<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏ - CO_LAB CRM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: white;
            box-sizing: border-box;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        h1 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-left: 20px;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 12px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            margin-bottom: 4px;
        }

        .user-name {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .user-email {
            color: #666;
            font-size: 12px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .dropdown-item.logout:hover {
            background-color: #fff5f5;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .orders-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .orders-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: nowrap;
        }

        .search-input {
            flex: 2;
            min-width: 300px;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
            height: 42px;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-controls select {
            padding: 10px 8px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            min-width: 100px;
            max-width: 140px;
            height: 42px;
            box-sizing: border-box;
        }

        .search-controls button {
            white-space: nowrap;
            padding: 10px 10px;
            font-size: 13px;
            height: 42px;
            box-sizing: border-box;
        }

        .date-range-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .search-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .search-group label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            margin-bottom: 3px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 12px;
            color: #c33;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 8px;
            padding: 12px;
            color: #3c3;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* –°—Ç–∞—Ç—É—Å—ã –∑–∞—è–≤–æ–∫ */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-created {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-calculation {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-proposal_sent {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-proposal_accepted {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-proposal_rejected {
            background: #ffebee;
            color: #c62828;
        }

        .status-paid {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-picking {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-shipped {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-closed {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .status-for_shipment_unpaid {
            background: #ffebee;
            color: #c62828;
        }

        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }

        .files-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 5px;
            margin-bottom: 8px;
            background: #fafafa;
        }

        .file-info {
            flex: 1;
        }

        .file-info strong {
            display: block;
            color: #333;
        }

        .file-info small {
            color: #666;
            font-size: 12px;
        }

        .no-files {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }


        .status-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .status-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-step.active {
            background: #667eea;
            color: white;
        }

        .status-step.completed {
            background: #28a745;
            color: white;
        }

        .status-step.pending {
            background: #e9ecef;
            color: #6c757d;
        }

        .status-branch {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .order-items {
            margin: 20px 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-input {
            width: 80px;
            padding: 6px;
            text-align: center;
        }

        .price-input {
            width: 120px;
            padding: 6px;
            text-align: right;
        }

        .total-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .total-row.final {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            border-top: 2px solid #e1e5e9;
            padding-top: 10px;
        }

        .product-selector {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .product-search {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .product-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .product-option {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .product-option:hover {
            background: #f8f9fa;
        }

        .product-option.selected {
            background: #d3d3d3;
            border-left: 4px solid #007bff;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-row:hover {
            background-color: #f0f8ff !important;
            cursor: pointer;
        }

        .history-row {
            transition: background-color 0.2s ease;
        }

        /* Calculation section styles */
        .calculation-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .calculation-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }

        .calculation-field {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .calculation-field:last-child {
            border-bottom: none;
        }

        .calculation-field label {
            font-weight: 500;
            color: #555;
        }

        .calculation-field span {
            color: #333;
            font-weight: 600;
        }

        .workflow-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-workflow {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .btn-workflow:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .btn-workflow.calculation {
            background: #ffc107;
            color: #212529;
        }

        .btn-workflow.proposal {
            background: #28a745;
            color: white;
        }

        .btn-workflow.accept {
            background: #28a745;
            color: white;
        }

        .btn-workflow.reject {
            background: #dc3545;
            color: white;
        }

        .btn-workflow.duplicate {
            background: #6c757d;
            color: white;
        }

        /* Enhanced progress bar */
        .enhanced-progress {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
        }

        .progress-step:not(:last-child)::after {
            content: '‚Üí';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #ddd;
            font-weight: bold;
        }

        .progress-step.current {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .progress-step.completed {
            background: #28a745;
            color: white;
        }

        .progress-step.available {
            background: #e9ecef;
            color: #495057;
            cursor: pointer;
        }

        .progress-step.available:hover {
            background: #dee2e6;
        }

        .progress-step.unavailable {
            background: #f8f9fa;
            color: #adb5bd;
        }

        /* Proposal response modal */
        .response-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .response-buttons .btn {
            min-width: 120px;
            padding: 12px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 30px;">
                    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</h1>
                    <button class="btn btn-success" onclick="openCreateOrderModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="nav-buttons">
                        <a href="contracts.html" class="btn btn-secondary">–î–æ–≥–æ–≤–æ—Ä—ã</a>
                        <a href="markup_calculator.html" class="btn btn-secondary">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
                        <a href="warehouse.html" class="btn btn-secondary">–°–∫–ª–∞–¥</a>
                        <a href="clients.html" class="btn btn-secondary">–ö–ª–∏–µ–Ω—Ç—ã</a>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                            –£
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-header">
                                <div class="user-name" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                                <div class="user-email" id="userEmail">user@example.com</div>
                            </div>
                            <a href="profile.html" class="dropdown-item" style="text-decoration: none; color: #333;">
                                üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                            </a>
                            <button class="dropdown-item logout" onclick="logout()">
                                üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeOrders">-</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">-</div>
                <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedOrders">-</div>
                <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö</div>
            </div>
        </div>

        <div class="section" style="position: relative;">
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div>
                    <div class="loading"></div>
                    <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>

            <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –∑–∞—è–≤–æ–∫ -->
            <div class="tabs">
                <button class="tab-button active" id="activeTab" onclick="switchTab('active')">
                    –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏
                </button>
                <button class="tab-button" id="historyTab" onclick="switchTab('history')">
                    –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫
                </button>
            </div>

            <!-- –°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ -->
            <div class="search-controls" id="activeSearchControls">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞—è–≤–∫–∏, –∫–ª–∏–µ–Ω—Ç—É, –ò–ù–ù, —Å—É–º–º–µ..." onkeyup="handleSearch()">
                
                <select id="statusFilter" onchange="handleSearch()">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="CREATED">–°–æ–∑–¥–∞–Ω–∞</option>
                    <option value="CALCULATION">–ü—Ä–æ—Å—á–µ—Ç</option>
                    <option value="PROPOSAL_SENT">–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                    <option value="PROPOSAL_ACCEPTED">–ö–ü –ø—Ä–∏–Ω—è—Ç–æ</option>
                    <option value="PROPOSAL_REJECTED">–ö–ü –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                    <option value="PAID">–û–ø–ª–∞—á–µ–Ω–∞</option>
                    <option value="FOR_SHIPMENT_UNPAID">–í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã</option>
                    <option value="PICKING">–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</option>
                    <option value="SHIPPED">–û—Ç–≥—Ä—É–∂–µ–Ω–∞</option>
                    <option value="CLOSED">–ó–∞–∫—Ä—ã—Ç–∞</option>
                </select>
                
                <select id="dateFilter" onchange="handleDateFilterChange()">
                    <option value="">–í—Å–µ –¥–∞—Ç—ã</option>
                    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                    <option value="yesterday">–í—á–µ—Ä–∞</option>
                    <option value="this_week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
                    <option value="this_month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
                    <option value="custom">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥</option>
                </select>
                <span id="dateFilterIndicator" style="font-size: 12px; color: #667eea; margin-left: 8px; display: none;"></span>
                
                <button class="btn btn-primary" onclick="loadOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="clearFilters()" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">‚úï</button>
            </div>
            
            <!-- –°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫ -->
            <div class="search-controls" id="historySearchControls" style="display: none;">
                <input type="text" class="search-input" id="historySearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞—è–≤–∫–∏, –∫–ª–∏–µ–Ω—Ç—É, –ò–ù–ù, —Å—É–º–º–µ..." onkeyup="handleHistorySearch()">
                
                <select id="historyDateFilter" onchange="handleHistoryDateFilterChange()">
                    <option value="">–í—Å–µ –¥–∞—Ç—ã</option>
                    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                    <option value="yesterday">–í—á–µ—Ä–∞</option>
                    <option value="this_week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
                    <option value="this_month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
                    <option value="custom">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥</option>
                </select>
                <span id="historyDateFilterIndicator" style="font-size: 12px; color: #667eea; margin-left: 8px; display: none;"></span>
                
                <button class="btn btn-primary" onclick="loadOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="clearHistoryFilters()" title="–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">‚úï</button>
            </div>
                
            <div class="date-range-row" id="dateRangeRow" style="display: none;">
                <div class="search-group">
                    <label for="dateFrom">–û—Ç:</label>
                    <input type="date" id="dateFrom" onchange="handleSearch()">
                </div>
                <div class="search-group">
                    <label for="dateTo">–î–æ:</label>
                    <input type="date" id="dateTo" onchange="handleSearch()">
                </div>
            </div>
            
            <div class="date-range-row" id="historyDateRangeRow" style="display: none;">
                <div class="search-group">
                    <label for="historyDateFrom">–û—Ç:</label>
                    <input type="date" id="historyDateFrom" onchange="handleHistorySearch()">
                </div>
                <div class="search-group">
                    <label for="historyDateTo">–î–æ:</label>
                    <input type="date" id="historyDateTo" onchange="handleHistorySearch()">
                </div>
            </div>
            
            <div id="ordersTableContainer">
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>‚Ññ –ó–∞—è–≤–∫–∏</th>
                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–¢–æ–≤–∞—Ä–æ–≤</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                    </tbody>
                </table>
            </div>

            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="orderModalTitle">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
            </div>
            
            <div id="orderModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="orderForm">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ -->
                <div class="section">
                    <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="orderClient">–ö–ª–∏–µ–Ω—Ç *</label>
                            <select id="orderClient" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="orderDate">–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏</label>
                            <input type="date" id="orderDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="orderManager">–ú–µ–Ω–µ–¥–∂–µ—Ä *</label>
                            <select id="orderManager" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="orderNotes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                        <textarea id="orderNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞—è–≤–∫–µ"></textarea>
                    </div>
                </div>

                <!-- –¢–æ–≤–∞—Ä—ã –≤ –∑–∞—è–≤–∫–µ -->
                <div class="section">
                    <h3>–¢–æ–≤–∞—Ä—ã</h3>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞—è–≤–∫–µ:</span>
                        <button type="button" class="btn btn-primary" onclick="openProductSelector()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                    </div>

                    <div id="orderItemsList" class="order-items">
                        <div class="empty-state">–¢–æ–≤–∞—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>
                    </div>

                    <div id="orderTotal" class="total-section" style="display: none;">
                        <div class="total-row">
                            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π:</span>
                            <span id="totalItems">0</span>
                        </div>
                        <div class="total-row">
                            <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                            <span id="totalQuantity">0</span>
                        </div>
                        <div class="total-row final">
                            <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                            <span id="totalAmount">0 —Å—É–º</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()" style="margin-right: 10px;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success" id="saveOrderBtn">üíæ –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div id="productSelectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–í—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–ª–∞–¥–∞</h2>
            </div>
            
            <div class="product-selector">
                <input type="text" class="product-search" id="productSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." onkeyup="searchProducts()">
                <div class="product-list" id="productList">
                    <div class="loading" style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
                </div>
            </div>

            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeProductSelector()" style="margin-right: 10px;">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" id="addSelectedProductsBtn" onclick="addSelectedProduct()" disabled>–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–∫–∏ -->
    <div id="viewOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewOrderTitle">–ó–∞—è–≤–∫–∞ #</h2>
            </div>
            
            <div id="viewOrderContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ -->
    <div id="statusSelectionModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="statusSelectionTitle">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏</h2>
                <span class="close" onclick="closeStatusSelectionModal()">&times;</span>
            </div>
            
            <div style="padding: 20px;">
                <p id="statusSelectionText" style="margin-bottom: 25px; font-size: 16px; text-align: center;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞—è–≤–∫–∏:
                </p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="btn btn-success" id="statusPaidBtn" onclick="selectOrderStatus('PAID')" style="padding: 15px; font-size: 16px;">
                        üí∞ –ó–∞—è–≤–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞
                    </button>
                    <button class="btn btn-primary" id="statusForShipmentBtn" onclick="selectOrderStatus('FOR_SHIPMENT_UNPAID')" style="padding: 15px; font-size: 16px;">
                        üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é –±–µ–∑ –æ–ø–ª–∞—Ç—ã
                    </button>
                    <button class="btn btn-secondary" onclick="closeStatusSelectionModal()" style="padding: 15px; font-size: 16px;">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞ -->
    <div id="calculationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="calculationModalTitle">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—á–µ—Ç –¥–ª—è –∑–∞—è–≤–∫–∏</h2>
                <span class="close" onclick="closeCalculationModal()">&times;</span>
            </div>
            
            <div id="calculationModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="calculationForm">
                <div class="section">
                    <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="calculationName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ *</label>
                            <input type="text" id="calculationName" required placeholder="–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è –∑–∞—è–≤–∫–∏">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="responsibleManager">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</label>
                            <input type="text" id="responsibleManager" placeholder="–ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gasCost">–ì–∞–∑ (—Å—É–º)</label>
                            <input type="number" id="gasCost" min="0" step="0.01" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="cylinderCost">–ë–∞–ª–ª–æ–Ω (—Å—É–º)</label>
                            <input type="number" id="cylinderCost" min="0" step="0.01" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="preparationCost">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–∞ (—Å—É–º)</label>
                            <input type="number" id="preparationCost" min="0" step="0.01" placeholder="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="logisticsCost">–õ–æ–≥–∏—Å—Ç–∏–∫–∞ (—Å—É–º)</label>
                            <input type="number" id="logisticsCost" min="0" step="0.01" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="workersCost">–ì—Ä—É–∑—á–∏–∫–∏ (—Å—É–º)</label>
                            <input type="number" id="workersCost" min="0" step="0.01" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="kickbacksCost">–û—Ç–∫–∞—Ç—ã –ø–æ —Å–¥–µ–ª–∫–µ (—Å—É–º)</label>
                            <input type="number" id="kickbacksCost" min="0" step="0.01" placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>–ü—Ä–æ–¥–∞–∂–Ω–∞—è —Ü–µ–Ω–∞</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pricePerUnit">–¶–µ–Ω–∞ –∑–∞ —à—Ç—É–∫—É (—Å—É–º)</label>
                            <input type="number" id="pricePerUnit" min="0" step="0.01" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" id="quantity" min="0" step="1" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label for="productName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                            <input type="text" id="productName" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∑–∞—è–≤–∫–∏">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sellingCompany">–ü—Ä–æ–¥–∞–∂–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è</label>
                            <input type="text" id="sellingCompany" placeholder="–ù–æ–≤–∞, –°–û-–õ–ê–ë –∏ —Ç.–¥.">
                        </div>
                        <div class="form-group">
                            <label for="organizationINN">–ò–ù–ù –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                            <input type="text" id="organizationINN" placeholder="123456789">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="organizationName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                            <input type="text" id="organizationName" placeholder="–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>–ù–∞–ª–æ–≥–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vatPercent">–ù–î–° (%)</label>
                            <input type="number" id="vatPercent" min="0" max="100" step="0.1" value="12" placeholder="12">
                        </div>
                        <div class="form-group">
                            <label for="incomeTaxPercent">–ü–æ–¥–æ—Ö–æ–¥–Ω—ã–π –Ω–∞–ª–æ–≥ (%)</label>
                            <input type="number" id="incomeTaxPercent" min="0" max="100" step="0.1" value="20" placeholder="20">
                        </div>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                    <button type="button" class="btn btn-secondary" onclick="closeCalculationModal()" style="margin-right: 10px;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success" id="saveCalculationBtn">üíæ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—á–µ—Ç</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ö–ü -->
    <div id="proposalResponseModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="proposalResponseTitle">–û—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h2>
                <span class="close" onclick="closeProposalResponseModal()">&times;</span>
            </div>
            
            <div id="proposalResponseErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="proposalResponseForm">
                <div class="section">
                    <p style="text-align: center; font-size: 16px; margin-bottom: 20px;" id="proposalResponseText">
                        –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ö–ü:
                    </p>
                    
                    <div class="form-group">
                        <label for="responseNotes">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <textarea id="responseNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞" rows="3"></textarea>
                    </div>

                    <div class="response-buttons">
                        <button type="button" class="btn btn-success" onclick="submitProposalResponse('ACCEPTED')">
                            ‚úÖ –ö–ü –ø—Ä–∏–Ω—è—Ç–æ
                        </button>
                        <button type="button" class="btn btn-danger" onclick="submitProposalResponse('REJECTED')">
                            ‚ùå –ö–ü –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeProposalResponseModal()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentEditingOrder = null;
        let currentPage = 1;
        const pageSize = 10;
        let searchTimeout;
        let selectedProduct = null;
        let orderItems = [];
        let currentTab = 'active'; // 'active' –∏–ª–∏ 'history'
        let pendingStatusChange = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞
        let currentOrderForCalculation = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–∞
        let currentOrderForProposal = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –ö–ü

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ api.js
            // –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            
            initializeUserInfo();
            loadOrders();
            loadClients();
            loadManagers();
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä URL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏
            const urlParams = new URLSearchParams(window.location.search);
            const viewOrderId = urlParams.get('view');
            if (viewOrderId) {
                setTimeout(() => viewOrder(viewOrderId), 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            }
        });

        function initializeUserInfo() {
            const user = APIHelpers.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É
                updateUserAvatar(user);
                
                // –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
                if (user.role === 'admin') {
                    const dropdown = document.getElementById('userDropdown');
                    const profileLink = dropdown.querySelector('a[href="profile.html"]');
                    if (profileLink) {
                        profileLink.insertAdjacentHTML('afterend', `
                            <a href="admin-users.html" class="dropdown-item" style="text-decoration: none; color: #333;">
                                üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                            </a>
                        `);
                    }
                }
            }
        }

        function updateUserAvatar(user) {
            const avatarElement = document.getElementById('userAvatar');
            
            if (user.avatar) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞
                avatarElement.innerHTML = `<img src="${user.avatar}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∏–º–µ–Ω–∏
                const firstLetter = user.name.charAt(0).toUpperCase();
                avatarElement.textContent = firstLetter;
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function logout() {
            API.logout();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            currentTab = tab;
            currentPage = 1;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ UI
            document.getElementById('activeTab').classList.remove('active');
            document.getElementById('historyTab').classList.remove('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
            const activeSearchControls = document.getElementById('activeSearchControls');
            const historySearchControls = document.getElementById('historySearchControls');
            const dateRangeRow = document.getElementById('dateRangeRow');
            const historyDateRangeRow = document.getElementById('historyDateRangeRow');
            
            if (tab === 'history') {
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫
                activeSearchControls.style.display = 'none';
                dateRangeRow.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å—Ç–æ—Ä–∏–∏
                historySearchControls.style.display = 'flex';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
                const createButton = document.querySelector('.btn-success[onclick="openCreateOrderModal()"]');
                createButton.style.display = 'none';
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫
                activeSearchControls.style.display = 'flex';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å—Ç–æ—Ä–∏–∏
                historySearchControls.style.display = 'none';
                historyDateRangeRow.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
                const createButton = document.querySelector('.btn-success[onclick="openCreateOrderModal()"]');
                createButton.style.display = 'inline-block';
            }
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
            document.getElementById('ordersTableContainer').innerHTML = '';
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—è–≤–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            loadOrders(1);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫
        async function loadOrders(page = 1) {
            try {
                currentPage = page;
                showLoading(true);
                hideMessages();

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
                let searchTerm, dateFrom, dateTo;
                if (currentTab === 'history') {
                    const historySearchEl = document.getElementById('historySearchInput');
                    const historyDateFromEl = document.getElementById('historyDateFrom');
                    const historyDateToEl = document.getElementById('historyDateTo');
                    
                    searchTerm = historySearchEl ? historySearchEl.value.trim() : '';
                    dateFrom = historyDateFromEl ? historyDateFromEl.value : '';
                    dateTo = historyDateToEl ? historyDateToEl.value : '';
                } else {
                    const searchEl = document.getElementById('searchInput');
                    const dateFromEl = document.getElementById('dateFrom');
                    const dateToEl = document.getElementById('dateTo');
                    
                    searchTerm = searchEl ? searchEl.value.trim() : '';
                    dateFrom = dateFromEl ? dateFromEl.value : '';
                    dateTo = dateToEl ? dateToEl.value : '';
                }
                
                const statusFilterEl = document.getElementById('statusFilter');
                const statusFilter = statusFilterEl ? statusFilterEl.value : '';
                
                const params = {
                    page,
                    limit: pageSize
                };
                
                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
                if (currentTab === 'history') {
                    params.status = 'CLOSED';
                } else if (currentTab === 'active') {
                    if (statusFilter && statusFilter !== 'CLOSED') {
                        params.status = statusFilter;
                    } else if (!statusFilter) {
                        // –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –∏—Å–∫–ª—é—á–∞–µ–º –∑–∞–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        params.excludeClosed = 'true';
                    }
                }

                if (searchTerm) {
                    params.search = searchTerm;
                }
                
                if (dateFrom) {
                    params.dateFrom = dateFrom;
                    console.log('Adding dateFrom parameter:', dateFrom);
                }
                
                if (dateTo) {
                    params.dateTo = dateTo;
                    console.log('Adding dateTo parameter:', dateTo);
                }
                
                console.log('Loading orders with params:', params);
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ –¥–∞—Ç
                if (dateFrom) {
                    console.log('dateFrom input value:', dateFrom);
                    console.log('dateFrom as Date:', new Date(dateFrom));
                }
                if (dateTo) {
                    console.log('dateTo input value:', dateTo);
                    console.log('dateTo as Date:', new Date(dateTo));
                }

                const response = await API.getOrders(params);
                console.log('API response received:', response);
                
                // –î–æ–±–∞–≤–ª—è–µ–º itemsCount –∫ –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–µ
                const ordersWithCount = response.orders.map(order => ({
                    ...order,
                    itemsCount: order._count?.items || order.items?.length || 0
                }));

                displayOrders(ordersWithCount);
                updatePagination(response.pagination);
                updateStats();

            } catch (error) {
                console.error('Error loading orders:', error);
                showMessage(APIHelpers.formatError(error), true);
                APIHelpers.showError(document.getElementById('ordersTableContainer'), '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫');
            } finally {
                showLoading(false);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
        function displayOrders(orders) {
            const container = document.getElementById('ordersTableContainer');
            let tableBody = document.getElementById('ordersTableBody');
            
            if (orders.length === 0) {
                const searchTerm = document.getElementById('searchInput').value.trim();
                const message = searchTerm ? '–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫';
                APIHelpers.showEmpty(container, message);
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞
            if (!tableBody) {
                const isHistoryTab = currentTab === 'history';
                const closeDateColumn = isHistoryTab ? '<th>–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</th>' : '';
                const actionsColumn = isHistoryTab ? '' : '<th>–î–µ–π—Å—Ç–≤–∏—è</th>';
                
                container.innerHTML = `
                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>‚Ññ –ó–∞—è–≤–∫–∏</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–¢–æ–≤–∞—Ä–æ–≤</th>
                                ${closeDateColumn}
                                ${actionsColumn}
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        </tbody>
                    </table>
                `;
                tableBody = document.getElementById('ordersTableBody');
            }

            const isHistoryTab = currentTab === 'history';
            
            tableBody.innerHTML = orders.map(order => {
                const rowClass = isHistoryTab ? 'history-row' : '';
                
                const closeDateColumn = isHistoryTab ? `<td>${APIHelpers.formatDate(order.updatedAt)}</td>` : '';
                const actionsColumn = isHistoryTab ? '' : `
                    <td onclick="event.stopPropagation()">
                        <div class="actions">
                            <button class="btn btn-edit" onclick="editOrder('${order.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="btn btn-success" onclick="changeOrderStatusWithDirection('${order.id}', 'next')" title="–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å">‚è≠Ô∏è</button>
                            <button class="btn btn-danger" onclick="deleteOrder('${order.id}', '${order.number}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                
                const redFlag = order.status === 'FOR_SHIPMENT_UNPAID' ? 'üö© ' : '';
                
                return `
                    <tr class="${rowClass}" onclick="viewOrder('${order.id}')" style="cursor: pointer;">
                        <td>
                            <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                <strong>${redFlag}${order.number}</strong>
                                <span class="status-badge status-${order.status?.toLowerCase() || 'unknown'}">${getStatusText(order.status)}</span>
                            </div>
                        </td>
                        <td>${order.client.name}</td>
                        <td>${APIHelpers.formatDateTime(order.createdAt)}</td>
                        <td>${APIHelpers.formatCurrency(order.totalAmount)}</td>
                        <td>${order.itemsCount} –ø–æ–∑.</td>
                        ${closeDateColumn}
                        ${actionsColumn}
                    </tr>
                `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'CREATED': '–°–æ–∑–¥–∞–Ω–∞',
                'CALCULATION': '–ü—Ä–æ—Å—á–µ—Ç',
                'PROPOSAL_SENT': '–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                'PROPOSAL_ACCEPTED': '–ö–ü –ø—Ä–∏–Ω—è—Ç–æ',
                'PROPOSAL_REJECTED': '–ö–ü –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ',
                'PAID': '–û–ø–ª–∞—á–µ–Ω–∞',
                'FOR_SHIPMENT_UNPAID': '–í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã',
                'PICKING': '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è',
                'SHIPPED': '–û—Ç–≥—Ä—É–∂–µ–Ω–∞',
                'CLOSED': '–ó–∞–∫—Ä—ã—Ç–∞'
            };
            return statusMap[status] || status;
        }


        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
        async function loadClients() {
            try {
                const response = await API.getClients({ limit: 1000 });
                const clientSelect = document.getElementById('orderClient');
                
                clientSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>' +
                    response.clients.map(client => 
                        `<option value="${client.id}">${client.name}</option>`
                    ).join('');
                    
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
        async function loadManagers() {
            try {
                const response = await API.getManagers();
                const managerSelect = document.getElementById('orderManager');
                const currentUser = APIHelpers.getCurrentUser();
                
                managerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>' +
                    response.managers.map(manager => 
                        `<option value="${manager.name}">${manager.name}</option>`
                    ).join('');
                
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (currentUser && currentUser.name) {
                    // –ò—â–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å –∏–º–µ–Ω–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userOption = Array.from(managerSelect.options).find(option => 
                        option.textContent.toLowerCase().includes(currentUser.name.toLowerCase()) ||
                        currentUser.name.toLowerCase().includes(option.textContent.toLowerCase())
                    );
                    if (userOption) {
                        managerSelect.value = userOption.value;
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        if (response.managers.length > 0) {
                            managerSelect.value = response.managers[0].name;
                        }
                    }
                }
                    
            } catch (error) {
                console.error('Error loading managers:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
                const managerSelect = document.getElementById('orderManager');
                managerSelect.innerHTML = `
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
                    <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 1">–ú–µ–Ω–µ–¥–∂–µ—Ä 1</option>
                    <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä 2">–ú–µ–Ω–µ–¥–∂–µ—Ä 2</option>
                `;
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                managerSelect.value = "–ú–µ–Ω–µ–¥–∂–µ—Ä 1";
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
        function openCreateOrderModal() {
            currentEditingOrder = null;
            document.getElementById('orderModalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É';
            document.getElementById('saveOrderBtn').textContent = 'üíæ –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É';
            document.getElementById('orderForm').reset();
            document.getElementById('orderModalErrorMessage').style.display = 'none';
            
            // –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
            orderItems = [];
            updateOrderItemsList();
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±–æ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            loadManagers();
            
            document.getElementById('orderModal').style.display = 'block';
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            orderItems = [];
        }

        // –í—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤
        async function openProductSelector() {
            document.getElementById('productSelectorModal').style.display = 'block';
            await loadAvailableProducts();
        }

        function closeProductSelector() {
            document.getElementById('productSelectorModal').style.display = 'none';
            selectedProducts = [];
            // –£–±—Ä–∞—Ç—å –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            document.querySelectorAll('.product-option.selected').forEach(el => el.classList.remove('selected'));
        }

        async function loadAvailableProducts() {
            try {
                const response = await API.getWarehouseItems({ limit: 1000 });
                const productList = document.getElementById('productList');
                
                if (response.items.length === 0) {
                    productList.innerHTML = '<div class="empty-state">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ</div>';
                    return;
                }

                productList.innerHTML = response.items
                    .filter(item => item.quantity > 0) // –¢–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏
                    .map(item => `
                        <div class="product-option" onclick="selectProduct('${item.id}', '${item.name}', ${item.quantity}, ${item.purchasePrice || item.price || 0}, '${item.unit || '—à—Ç'}')">
                            <strong>${item.name}</strong><br>
                            <small>–í –Ω–∞–ª–∏—á–∏–∏: ${item.quantity} ${item.unit || '—à—Ç'} | –¶–µ–Ω–∞: ${APIHelpers.formatCurrency(item.purchasePrice || item.price || 0)}</small>
                        </div>
                    `).join('');
                    
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productList').innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>';
            }
        }

        let selectedProducts = [];

        function selectProduct(id, name, availableQty, defaultPrice, unit) {
            const productElement = event.target.closest('.product-option');
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤—ã–±—Ä–∞–Ω –ª–∏ —É–∂–µ —Ç–æ–≤–∞—Ä
            const productIndex = selectedProducts.findIndex(p => p.id === id);
            
            if (productIndex > -1) {
                // –£–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                selectedProducts.splice(productIndex, 1);
                productElement.classList.remove('selected');
            } else {
                // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                selectedProducts.push({
                    id,
                    name,
                    availableQty,
                    defaultPrice,
                    unit
                });
                productElement.classList.add('selected');
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            updateAddSelectedButton();
        }

        function updateAddSelectedButton() {
            const addButton = document.getElementById('addSelectedProductsBtn');
            if (addButton) {
                addButton.textContent = selectedProducts.length > 0 
                    ? `–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (${selectedProducts.length})` 
                    : '–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã';
                addButton.disabled = selectedProducts.length === 0;
            }
        }

        function addSelectedProduct() {
            if (selectedProducts.length === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã');
                return;
            }

            // –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
            selectedProducts.forEach(selectedProduct => {
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä
                if (!orderItems.find(item => item.id === selectedProduct.id)) {
                    orderItems.push({
                        id: selectedProduct.id,
                        name: selectedProduct.name,
                        availableQty: selectedProduct.availableQty,
                        unit: selectedProduct.unit,
                        quantity: 1,
                        price: selectedProduct.defaultPrice
                    });
                }
            });

            updateOrderItemsList();
            closeProductSelector();
        }

        function updateOrderItemsList() {
            const container = document.getElementById('orderItemsList');
            const totalSection = document.getElementById('orderTotal');

            if (orderItems.length === 0) {
                container.innerHTML = '<div class="empty-state">–¢–æ–≤–∞—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
                totalSection.style.display = 'none';
                return;
            }

            container.innerHTML = orderItems.map((item, index) => `
                <div class="order-item">
                    <div class="order-item-info">
                        <strong>${item.name}</strong><br>
                        <small>–î–æ—Å—Ç—É–ø–Ω–æ: ${item.availableQty} ${item.unit || '—à—Ç'}</small>
                    </div>
                    <div class="order-item-actions">
                        <label>–ö–æ–ª-–≤–æ:</label>
                        <input type="number" class="quantity-input" min="1" max="${item.availableQty}" 
                               value="${item.quantity}" onchange="updateItemQuantity(${index}, this.value)">
                        
                        <label>–¶–µ–Ω–∞:</label>
                        <input type="number" class="price-input" min="0" step="0.01" 
                               value="${item.price}" onchange="updateItemPrice(${index}, this.value)">
                        
                        <button type="button" class="btn btn-danger" onclick="removeOrderItem(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            updateOrderTotals();
            totalSection.style.display = 'block';
        }

        function updateItemQuantity(index, quantity) {
            const qty = parseInt(quantity) || 1;
            orderItems[index].quantity = Math.min(qty, orderItems[index].availableQty);
            updateOrderTotals();
        }

        function updateItemPrice(index, price) {
            orderItems[index].price = parseFloat(price) || 0;
            updateOrderTotals();
        }

        function removeOrderItem(index) {
            orderItems.splice(index, 1);
            updateOrderItemsList();
        }

        function updateOrderTotals() {
            const totalItems = orderItems.length;
            const totalQuantity = orderItems.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = orderItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalAmount').textContent = APIHelpers.formatCurrency(totalAmount);
        }

        // –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤
        function searchProducts() {
            const query = document.getElementById('productSearch').value.toLowerCase();
            const options = document.querySelectorAll('.product-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(query) ? 'block' : 'none';
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const orderData = {
                clientId: document.getElementById('orderClient').value,
                orderDate: document.getElementById('orderDate').value,
                manager: document.getElementById('orderManager').value,
                notes: document.getElementById('orderNotes').value.trim() || null,
                items: orderItems.map(item => ({
                    id: item.id,
                    quantity: item.quantity,
                    price: item.price
                }))
            };

            if (!orderData.clientId) {
                showOrderModalMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞', true);
                return;
            }

            if (!orderData.manager) {
                showOrderModalMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞', true);
                return;
            }

            if (orderItems.length === 0) {
                showOrderModalMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞—è–≤–∫—É', true);
                return;
            }

            try {
                const saveBtn = document.getElementById('saveOrderBtn');
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<div class="loading"></div>' + (currentEditingOrder ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ–∑–¥–∞–Ω–∏–µ...');
                saveBtn.disabled = true;

                let response;
                if (currentEditingOrder) {
                    response = await API.updateOrder(currentEditingOrder, orderData);
                    showMessage(`–ó–∞—è–≤–∫–∞ ${response.number || response.order?.number || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!`);
                } else {
                    response = await API.createOrder(orderData);
                    showMessage(`–ó–∞—è–≤–∫–∞ ${response.number || response.order?.number || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
                }

                closeOrderModal();
                loadOrders(currentPage);

            } catch (error) {
                console.error('Error saving order:', error);
                showOrderModalMessage(APIHelpers.formatError(error), true);
            } finally {
                const saveBtn = document.getElementById('saveOrderBtn');
                saveBtn.textContent = currentEditingOrder ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : 'üíæ –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É';
                saveBtn.disabled = false;
            }
        });

        function showOrderModalMessage(message, isError = false) {
            const errorEl = document.getElementById('orderModalErrorMessage');
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            } else {
                errorEl.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏
        async function viewOrder(id) {
            try {
                const order = await API.getOrder(id);
                
                // Try to fetch calculation if order has one
                if (order.calculationId) {
                    try {
                        const calculationResponse = await fetch(`/api/orders/${id}/calculation`, {
                            method: 'GET',
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('token')
                            }
                        });
                        
                        if (calculationResponse.ok) {
                            const calculationData = await calculationResponse.json();
                            order.calculation = calculationData.calculation;
                        }
                    } catch (calcError) {
                        console.log('No calculation found for order:', calcError);
                    }
                }
                
                displayOrderDetails(order);
                document.getElementById('viewOrderModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading order:', error);
                showMessage(APIHelpers.formatError(error), true);
            }
        }

        function populateOrderForm(order) {
            // Populate client field
            const clientSelect = document.getElementById('orderClient');
            if (clientSelect) {
                clientSelect.value = order.clientId || '';
            }
            
            // Populate date field
            const dateInput = document.getElementById('orderDate');
            if (dateInput && order.orderDate) {
                const date = new Date(order.orderDate);
                dateInput.value = date.toISOString().split('T')[0];
            }
            
            // Populate manager field
            const managerSelect = document.getElementById('orderManager');
            if (managerSelect) {
                managerSelect.value = order.manager || '';
            }
            
            // Populate notes field
            const notesTextarea = document.getElementById('orderNotes');
            if (notesTextarea) {
                notesTextarea.value = order.notes || '';
            }
            
            // Populate order items
            if (order.items && order.items.length > 0) {
                currentOrderItems = [...order.items];
                updateOrderItemsDisplay();
                updateOrderTotal();
            } else {
                currentOrderItems = [];
                updateOrderItemsDisplay();
                updateOrderTotal();
            }
        }

        async function editOrder(id) {
            console.log('editOrder called with id:', id);
            try {
                const order = await API.getOrder(id);
                console.log('Order loaded for editing:', order);
                populateOrderForm(order);
                currentEditingOrder = id;
                document.getElementById('orderModalTitle').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É ${order.number}`;
                document.getElementById('saveOrderBtn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading order:', error);
                showMessage(APIHelpers.formatError(error), true);
            }
        }

        // Direct status change function (for workflow buttons)
        async function changeOrderStatus(id, newStatus) {
            try {
                const statusNames = {
                    'CREATED': '–°–æ–∑–¥–∞–Ω–∞',
                    'CALCULATION': '–ü—Ä–æ—Å—á–µ—Ç',
                    'PROPOSAL_SENT': '–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                    'PROPOSAL_ACCEPTED': '–ö–ü –ø—Ä–∏–Ω—è—Ç–æ',
                    'PROPOSAL_REJECTED': '–ö–ü –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ',
                    'PAID': '–û–ø–ª–∞—á–µ–Ω–∞',
                    'FOR_SHIPMENT_UNPAID': '–í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã',
                    'PICKING': '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è',
                    'SHIPPED': '–û—Ç–≥—Ä—É–∂–µ–Ω–∞',
                    'CLOSED': '–ó–∞–∫—Ä—ã—Ç–∞'
                };

                // –û—Å–æ–±–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Å—Ç–∞—Ç—É—Å "–ó–∞–∫—Ä—ã—Ç–∞"
                if (newStatus === 'CLOSED') {
                    const order = await API.getOrder(id);
                    
                    // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ –±—ã–ª–∞ –æ—Ç–≥—Ä—É–∂–µ–Ω–∞ –±–µ–∑ –æ–ø–ª–∞—Ç—ã, —Ç—Ä–µ–±—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                    if (order.status === 'SHIPPED') {
                        const confirmPayment = confirm(
                            `–í–ù–ò–ú–ê–ù–ò–ï!\n\n` +
                            `–í—ã –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ –∑–∞—è–≤–∫—É ‚Ññ${order.number} –≤ —Å—Ç–∞—Ç—É—Å "–ó–∞–∫—Ä—ã—Ç–∞".\n\n` +
                            `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:\n` +
                            `‚úì –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ–∏–∑–≤–µ–ª –æ–ø–ª–∞—Ç—É\n` +
                            `‚úì –ü–ª–∞—Ç–µ–∂ –ø–æ—Å—Ç—É–ø–∏–ª –Ω–∞ —Å—á–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏\n` +
                            `‚úì –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã\n\n` +
                            `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –∑–∞—è–≤–∫–∞ –û–ü–õ–ê–ß–ï–ù–ê –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç–∞?`
                        );
                        
                        if (!confirmPayment) {
                            showMessage('–ü–µ—Ä–µ–≤–æ–¥ –≤ —Å—Ç–∞—Ç—É—Å "–ó–∞–∫—Ä—ã—Ç–∞" –æ—Ç–º–µ–Ω–µ–Ω. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã.', false);
                            return;
                        }
                    }
                } else if (confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –Ω–∞ "${statusNames[newStatus]}"?`)) {
                    // –û–±—ã—á–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
                } else {
                    return; // –û—Ç–º–µ–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                }

                await API.updateOrderStatus(id, newStatus);
                showMessage(`–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${statusNames[newStatus]}"`);
                loadOrders(currentPage);
                closeViewOrderModal();
                
            } catch (error) {
                console.error('Error changing order status:', error);
                showMessage(APIHelpers.formatError(error), true);
            }
        }

        async function changeOrderStatusWithDirection(id, direction) {
            console.log('changeOrderStatusWithDirection called with:', id, direction);
            try {
                const order = await API.getOrder(id);
                console.log('Order data:', order);
                
                let newStatus;
                
                if (direction === 'next') {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ
                    if (order.status === 'CREATED') {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞
                        showStatusSelectionModal(id, order.number);
                        return;
                    } else if (order.status === 'PROPOSAL_ACCEPTED') {
                        showStatusSelectionModal(id, order.number);
                        return;
                    } else if (order.status === 'PAID' || order.status === 'FOR_SHIPMENT_UNPAID') {
                        newStatus = 'PICKING'; // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é
                    } else if (order.status === 'PICKING') {
                        newStatus = 'SHIPPED'; // –û—Ç–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏
                    } else if (order.status === 'SHIPPED') {
                        // –î–ª—è –æ—Ç–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ —Ç—Ä–µ–±—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
                        const confirmPayment = confirm(
                            `–í–ù–ò–ú–ê–ù–ò–ï!\n\n` +
                            `–í—ã –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ –∑–∞—è–≤–∫—É ‚Ññ${order.number} –≤ —Å—Ç–∞—Ç—É—Å "–ó–∞–∫—Ä—ã—Ç–∞".\n\n` +
                            `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:\n` +
                            `‚úì –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ–∏–∑–≤–µ–ª –æ–ø–ª–∞—Ç—É\n` +
                            `‚úì –ü–ª–∞—Ç–µ–∂ –ø–æ—Å—Ç—É–ø–∏–ª –Ω–∞ —Å—á–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏\n` +
                            `‚úì –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã\n\n` +
                            `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –∑–∞—è–≤–∫–∞ –û–ü–õ–ê–ß–ï–ù–ê –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç–∞?`
                        );
                        
                        if (!confirmPayment) {
                            showMessage('–ü–µ—Ä–µ–≤–æ–¥ –≤ —Å—Ç–∞—Ç—É—Å "–ó–∞–∫—Ä—ã—Ç–∞" –æ—Ç–º–µ–Ω–µ–Ω. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã.', false);
                            return;
                        }
                        
                        newStatus = 'CLOSED';
                    } else {
                        return; // –£–∂–µ –∑–∞–∫—Ä—ã—Ç–∞ –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å
                    }
                } else if (direction === 'prev') {
                    // –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å—Ç–∞—Ç—É—Å—É
                    if (order.status === 'PAID' || order.status === 'FOR_SHIPMENT_UNPAID') {
                        newStatus = 'PROPOSAL_ACCEPTED';
                    } else if (order.status === 'PICKING') {
                        newStatus = 'PAID';
                    } else if (order.status === 'SHIPPED') {
                        newStatus = 'PICKING';
                    } else if (order.status === 'CLOSED') {
                        newStatus = 'SHIPPED';
                    } else {
                        return; // –£–∂–µ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ
                    }
                } else {
                    return;
                }

                const statusNames = {
                    'CREATED': '–°–æ–∑–¥–∞–Ω–∞',
                    'CALCULATION': '–ü—Ä–æ—Å—á–µ—Ç',
                    'PROPOSAL_SENT': '–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                    'PROPOSAL_ACCEPTED': '–ö–ü –ø—Ä–∏–Ω—è—Ç–æ',
                    'PROPOSAL_REJECTED': '–ö–ü –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ',
                    'PAID': '–û–ø–ª–∞—á–µ–Ω–∞',
                    'FOR_SHIPMENT_UNPAID': '–í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã',
                    'PICKING': '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è',
                    'SHIPPED': '–û—Ç–≥—Ä—É–∂–µ–Ω–∞',
                    'CLOSED': '–ó–∞–∫—Ä—ã—Ç–∞'
                };

                if (confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ ${order.number} –Ω–∞ "${statusNames[newStatus]}"?`)) {
                    await API.updateOrderStatus(id, newStatus);
                    showMessage(`–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${statusNames[newStatus]}"`);
                    loadOrders(currentPage);
                }
            } catch (error) {
                console.error('Error changing order status:', error);
                showMessage(APIHelpers.formatError(error), true);
            }
        }

        // Test function for debugging
        window.testStatusButton = function() {
            console.log('Test function called');
            changeOrderStatusWithDirection('1', 'next');
        };
        
        window.testEditButton = function() {
            console.log('Test edit function called');
            editOrder('1');
        };

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
        function showStatusSelectionModal(orderId, orderNumber) {
            console.log('showStatusSelectionModal called with:', orderId, orderNumber);
            pendingStatusChange = { orderId, orderNumber };
            document.getElementById('statusSelectionTitle').textContent = `–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏ ${orderNumber}`;
            document.getElementById('statusSelectionModal').style.display = 'block';
            console.log('Modal should be visible now');
        }

        async function selectOrderStatus(status) {
            if (!pendingStatusChange) return;
            
            try {
                const statusNames = {
                    'PAID': '–û–ø–ª–∞—á–µ–Ω–∞',
                    'FOR_SHIPMENT_UNPAID': '–í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã'
                };
                
                await API.updateOrderStatus(pendingStatusChange.orderId, status);
                showMessage(`–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${statusNames[status]}"`);
                loadOrders(currentPage);
                closeStatusSelectionModal();
            } catch (error) {
                console.error('Error changing order status:', error);
                showMessage(APIHelpers.formatError(error), true);
            }
        }

        function closeStatusSelectionModal() {
            document.getElementById('statusSelectionModal').style.display = 'none';
            pendingStatusChange = null;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏–∑ –∑–∞—è–≤–∫–∏
        async function createContractFromOrder(orderId) {
            try {
                if (!confirm('–°–æ–∑–¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–π –∑–∞—è–≤–∫–∏?')) {
                    return;
                }

                showMessage('–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞...', false);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
                const order = await API.getOrder(orderId);
                
                // –°–æ–∑–¥–∞–µ–º –¥–æ–≥–æ–≤–æ—Ä —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                const contractData = {
                    contractType: 'SUPPLY', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏
                    validFrom: new Date().toISOString().split('T')[0],
                    description: `–î–æ–≥–æ–≤–æ—Ä –ø–æ –∑–∞—è–≤–∫–µ ${order.number}`,
                    terms: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏',
                    conditions: '–°–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏'
                };

                const response = await fetch('/api/contracts/from-order/' + orderId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ contractData })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                showMessage(`–î–æ–≥–æ–≤–æ—Ä ${result.contract.contractNumber} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`, false);
                
                // –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –¥–æ–≥–æ–≤–æ—Ä–æ–≤
                if (confirm('–î–æ–≥–æ–≤–æ—Ä —Å–æ–∑–¥–∞–Ω. –ü–µ—Ä–µ–π—Ç–∏ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏?')) {
                    window.location.href = 'contracts.html';
                }

            } catch (error) {
                console.error('Error creating contract from order:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), true);
            }
        }

        async function deleteOrder(id, number) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É ${number}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                try {
                    await API.deleteOrder(id);
                    showMessage(`–ó–∞—è–≤–∫–∞ ${number} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞`);
                    loadOrders(currentPage);
                } catch (error) {
                    console.error('Error deleting order:', error);
                    showMessage(APIHelpers.formatError(error), true);
                }
            }
        }

        function getCylinderInfoForItem(order, item) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
            if (order.status !== 'SHIPPED' || !order.shipment || !order.shipment.cylinderNumbers) {
                return '';
            }
            
            // –ù–∞–π–¥–µ–º –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
            const cylindersForProduct = order.shipment.cylinderNumbers.filter(cyl => cyl.productId === item.id);
            
            if (cylindersForProduct.length === 0) {
                return '';
            }
            
            const cylinderNumbers = cylindersForProduct.map(cyl => cyl.cylinderNumber).join(', ');
            return `<br><small style="color: #28a745; font-weight: 500;">üè∑Ô∏è –ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤: ${cylinderNumbers}</small>`;
        }

        function displayOrderDetails(order) {
            const content = document.getElementById('viewOrderContent');
            const statusNames = {
                'CREATED': '–°–æ–∑–¥–∞–Ω–∞',
                'CALCULATION': '–ü—Ä–æ—Å—á–µ—Ç',
                'PROPOSAL_SENT': '–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                'PROPOSAL_ACCEPTED': '–ö–ü –ø—Ä–∏–Ω—è—Ç–æ',
                'PROPOSAL_REJECTED': '–ö–ü –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ',
                'PAID': '–û–ø–ª–∞—á–µ–Ω–∞',
                'FOR_SHIPMENT_UNPAID': '–í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã',
                'PICKING': '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è',
                'SHIPPED': '–û—Ç–≥—Ä—É–∂–µ–Ω–∞',
                'CLOSED': '–ó–∞–∫—Ä—ã—Ç–∞'
            };

            content.innerHTML = `
                <div class="enhanced-progress">
                    <div class="progress-step ${getProgressStepClass(order.status, 'CREATED')}">–°–æ–∑–¥–∞–Ω–∞</div>
                    <div class="progress-step ${getProgressStepClass(order.status, 'CALCULATION')}">–ü—Ä–æ—Å—á–µ—Ç</div>
                    <div class="progress-step ${getProgressStepClass(order.status, 'PROPOSAL_SENT')}">–ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                    <div class="progress-step ${getProgressStepClass(order.status, 'PROPOSAL_ACCEPTED')}">–ö–ü –ø—Ä–∏–Ω—è—Ç–æ</div>
                    <div class="progress-step ${getProgressStepClass(order.status, 'PAID')}">–û–ø–ª–∞—Ç–∞</div>
                    <div class="progress-step ${getProgressStepClass(order.status, 'PICKING')}">–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è</div>
                    <div class="progress-step ${getProgressStepClass(order.status, 'SHIPPED')}">–û—Ç–≥—Ä—É–∑–∫–∞</div>
                    <div class="progress-step ${getProgressStepClass(order.status, 'CLOSED')}">–ó–∞–∫—Ä—ã—Ç–∞</div>
                </div>

                ${generateWorkflowButtons(order)}

                <div class="section">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h3>
                    <p><strong>–ù–æ–º–µ—Ä:</strong> ${order.number}</p>
                    <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.client?.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–î–∞—Ç–∞:</strong> ${APIHelpers.formatDate(order.orderDate)}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge status-${order.status?.toLowerCase() || 'unknown'}">${statusNames[order.status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å'}</span></p>
                    <p><strong>–°—É–º–º–∞:</strong> ${APIHelpers.formatCurrency(order.totalAmount)}</p>
                    ${order.notes ? `<p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong> ${order.notes}</p>` : ''}
                </div>

                ${generateCalculationSection(order)}

                <div class="section">
                    <h3>–¢–æ–≤–∞—Ä—ã –≤ –∑–∞—è–≤–∫–µ</h3>
                    <div class="order-items">
                        ${order.items?.map(item => {
                            const cylinderInfo = getCylinderInfoForItem(order, item);
                            return `
                                <div class="order-item">
                                    <div class="order-item-info">
                                        <strong>${item.product?.name || '–¢–æ–≤–∞—Ä –Ω–µ —É–∫–∞–∑–∞–Ω'}</strong><br>
                                        <small>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity} ${item.product?.unit || '—à—Ç'} √ó ${APIHelpers.formatCurrency(item.price)} —Å—É–º = ${APIHelpers.formatCurrency(item.total || (item.quantity * item.price))} —Å—É–º</small>
                                        ${cylinderInfo}
                                    </div>
                                </div>
                            `;
                        }).join('') || '<p>–¢–æ–≤–∞—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>'}
                    </div>
                </div>

                <div class="section">
                    <h3>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h3>
                    <div class="file-upload-area">
                        <input type="file" id="orderFileInput" multiple style="display: none;" onchange="uploadOrderFiles('${order.id}')">
                        <button class="btn btn-outline" onclick="document.getElementById('orderFileInput').click()">
                            üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª
                        </button>
                    </div>
                    <div id="orderFilesList" class="files-list">
                        ${order.files && order.files.length > 0 ? order.files.map(file => `
                            <div class="file-item">
                                <div class="file-info">
                                    <strong>${file.originalName}</strong>
                                    <small>${formatFileSize(file.size)} ‚Ä¢ ${APIHelpers.formatDateTime(file.createdAt)}</small>
                                </div>
                                <button class="btn btn-sm" onclick="downloadOrderFile('${file.id}')" title="–°–∫–∞—á–∞—Ç—å">
                                    ‚¨áÔ∏è
                                </button>
                            </div>
                        `).join('') : '<p class="no-files">–§–∞–π–ª—ã –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã</p>'}
                    </div>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-success" onclick="createContractFromOrder('${order.id}'); closeViewOrderModal();">üìã –°–æ–∑–¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä</button>
                    <button class="btn btn-primary" onclick="editOrder('${order.id}'); closeViewOrderModal();">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-secondary" onclick="closeViewOrderModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            
            document.getElementById('viewOrderTitle').textContent = `–ó–∞—è–≤–∫–∞ ${order.number}`;
        }

        function getStatusOrder(status) {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            const statusOrder = {
                'CREATED': 0,
                'PAID': 1,
                'FOR_SHIPMENT_UNPAID': 1, // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å –Ω–∞ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ
                'PICKING': 2,
                'SHIPPED': 3,
                'CLOSED': 4
            };
            return statusOrder[status] || 0;
        }

        function populateOrderForm(order) {
            document.getElementById('orderClient').value = order.clientId;
            document.getElementById('orderDate').value = order.orderDate.split('T')[0];
            document.getElementById('orderManager').value = order.manager || '';
            document.getElementById('orderNotes').value = order.notes || '';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–æ–≤–∞—Ä—ã
            orderItems = order.items.map(item => ({
                id: item.productId,
                name: item.product.name,
                availableQty: item.product.warehouseItems?.[0]?.quantity || 0,
                unit: item.product.unit,
                quantity: item.quantity,
                price: item.price
            }));
            
            updateOrderItemsList();
        }

        function closeViewOrderModal() {
            document.getElementById('viewOrderModal').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏
        async function uploadOrderFiles(orderId) {
            const fileInput = document.getElementById('orderFileInput');
            const files = fileInput.files;
            
            if (files.length === 0) return;

            try {
                showMessage('–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ–∞–π–ª...', false);
                await API.uploadFiles(files, orderId, 'ORDER');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
                const order = await API.getOrder(orderId);
                displayOrderDetails(order);
                
                showMessage(`${files.length} —Ñ–∞–π–ª(–æ–≤) —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã –∫ –∑–∞—è–≤–∫–µ`);
                fileInput.value = ''; // –û—á–∏—Å—Ç–∏—Ç—å input
            } catch (error) {
                console.error('Error uploading files:', error);
                showMessage(APIHelpers.formatError(error), true);
            }
        }

        async function downloadOrderFile(fileId) {
            try {
                await API.downloadFile(fileId);
            } catch (error) {
                console.error('Error downloading file:', error);
                showMessage(APIHelpers.formatError(error), true);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 –ë';
            
            const k = 1024;
            const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // –ü–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadOrders(1);
            }, 500);
        }

        // –ü–æ–∏—Å–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫
        function handleHistorySearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadOrders(1);
            }, 500);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º
        function handleDateFilterChange() {
            const dateFilter = document.getElementById('dateFilter').value;
            const dateRangeRow = document.getElementById('dateRangeRow');
            
            if (dateFilter === 'custom') {
                dateRangeRow.style.display = 'flex';
                // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
            } else {
                dateRangeRow.style.display = 'none';
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã
                setPresetDates(dateFilter);
            }
            
            handleSearch();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–∞–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        function handleHistoryDateFilterChange() {
            const dateFilter = document.getElementById('historyDateFilter').value;
            const dateRangeRow = document.getElementById('historyDateRangeRow');
            
            if (dateFilter === 'custom') {
                dateRangeRow.style.display = 'flex';
                // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã
                document.getElementById('historyDateFrom').value = '';
                document.getElementById('historyDateTo').value = '';
            } else {
                dateRangeRow.style.display = 'none';
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                setHistoryPresetDates(dateFilter);
            }
            
            handleHistorySearch();
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞—Ç
        function setPresetDates(preset) {
            const today = new Date();
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            const indicator = document.getElementById('dateFilterIndicator');
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è input[type="date"]
            const formatDate = (date) => date.toISOString().split('T')[0];
            const formatDisplayDate = (date) => date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            
            switch (preset) {
                case 'today':
                    dateFrom.value = formatDate(today);
                    dateTo.value = formatDate(today);
                    indicator.textContent = `üìÖ ${formatDisplayDate(today)}`;
                    indicator.style.display = 'inline';
                    console.log('Setting today filter:', formatDate(today));
                    break;
                
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    dateFrom.value = formatDate(yesterday);
                    dateTo.value = formatDate(yesterday);
                    indicator.textContent = `üìÖ ${formatDisplayDate(yesterday)}`;
                    indicator.style.display = 'inline';
                    console.log('Setting yesterday filter:', formatDate(yesterday));
                    break;
                
                case 'this_week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay() + 1); // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                    dateFrom.value = formatDate(startOfWeek);
                    dateTo.value = formatDate(today);
                    indicator.textContent = `üìÖ ${formatDisplayDate(startOfWeek)} - ${formatDisplayDate(today)}`;
                    indicator.style.display = 'inline';
                    console.log('Setting this week filter:', formatDate(startOfWeek), 'to', formatDate(today));
                    break;
                
                case 'this_month':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    dateFrom.value = formatDate(startOfMonth);
                    dateTo.value = formatDate(today);
                    indicator.textContent = `üìÖ ${formatDisplayDate(startOfMonth)} - ${formatDisplayDate(today)}`;
                    indicator.style.display = 'inline';
                    console.log('Setting this month filter:', formatDate(startOfMonth), 'to', formatDate(today));
                    break;
                
                default:
                    dateFrom.value = '';
                    dateTo.value = '';
                    indicator.style.display = 'none';
                    console.log('Clearing date filters');
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        function setHistoryPresetDates(preset) {
            const today = new Date();
            const dateFrom = document.getElementById('historyDateFrom');
            const dateTo = document.getElementById('historyDateTo');
            const indicator = document.getElementById('historyDateFilterIndicator');
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è input[type="date"]
            const formatDate = (date) => date.toISOString().split('T')[0];
            const formatDisplayDate = (date) => date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            
            switch (preset) {
                case 'today':
                    dateFrom.value = formatDate(today);
                    dateTo.value = formatDate(today);
                    indicator.textContent = `üìÖ ${formatDisplayDate(today)}`;
                    indicator.style.display = 'inline';
                    break;
                
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    dateFrom.value = formatDate(yesterday);
                    dateTo.value = formatDate(yesterday);
                    indicator.textContent = `üìÖ ${formatDisplayDate(yesterday)}`;
                    indicator.style.display = 'inline';
                    break;
                
                case 'this_week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay() + 1); // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
                    dateFrom.value = formatDate(startOfWeek);
                    dateTo.value = formatDate(today);
                    indicator.textContent = `üìÖ ${formatDisplayDate(startOfWeek)} - ${formatDisplayDate(today)}`;
                    indicator.style.display = 'inline';
                    break;
                
                case 'this_month':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    dateFrom.value = formatDate(startOfMonth);
                    dateTo.value = formatDate(today);
                    indicator.textContent = `üìÖ ${formatDisplayDate(startOfMonth)} - ${formatDisplayDate(today)}`;
                    indicator.style.display = 'inline';
                    break;
                
                default:
                    dateFrom.value = '';
                    dateTo.value = '';
                    indicator.style.display = 'none';
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('dateRangeRow').style.display = 'none';
            document.getElementById('dateFilterIndicator').style.display = 'none';
            
            currentPage = 1;
            loadOrders(1);
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏
        function clearHistoryFilters() {
            document.getElementById('historySearchInput').value = '';
            document.getElementById('historyDateFilter').value = '';
            document.getElementById('historyDateFrom').value = '';
            document.getElementById('historyDateTo').value = '';
            document.getElementById('historyDateRangeRow').style.display = 'none';
            document.getElementById('historyDateFilterIndicator').style.display = 'none';
            
            currentPage = 1;
            loadOrders(1);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        function showMessage(message, isError = false) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            } else {
                successEl.textContent = message;
                successEl.style.display = 'block';
                errorEl.style.display = 'none';
            }

            setTimeout(() => {
                if (errorEl) errorEl.style.display = 'none';
                if (successEl) successEl.style.display = 'none';
            }, 5000);
        }

        function hideMessages() {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
        }

        function updatePagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            
            if (pagination.pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            paginationHTML += `
                <button onclick="loadOrders(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>
                    ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                </button>
            `;

            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else if (Math.abs(i - pagination.page) <= 2 || i === 1 || i === pagination.pages) {
                    paginationHTML += `<button onclick="loadOrders(${i})">${i}</button>`;
                } else if (Math.abs(i - pagination.page) === 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            paginationHTML += `
                <button onclick="loadOrders(${pagination.page + 1})" ${pagination.page >= pagination.pages ? 'disabled' : ''}>
                    –°–ª–µ–¥—É—é—â–∞—è ‚Üí
                </button>
            `;

            paginationEl.innerHTML = paginationHTML;
        }

        async function updateStats() {
            try {
                const stats = await API.getOrderStats();
                
                document.getElementById('totalOrders').textContent = stats.totalOrders;
                document.getElementById('activeOrders').textContent = stats.activeOrders;
                document.getElementById('totalRevenue').textContent = APIHelpers.formatCurrency(stats.totalRevenue);
                document.getElementById('completedOrders').textContent = stats.completedOrders;
                
            } catch (error) {
                console.error('Error updating stats:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—á–µ—Ä–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                document.getElementById('totalOrders').textContent = '-';
                document.getElementById('activeOrders').textContent = '-';
                document.getElementById('totalRevenue').textContent = '-';
                document.getElementById('completedOrders').textContent = '-';
            }
        }

        // Helper functions for the enhanced workflow

        function getProgressStepClass(currentStatus, stepStatus) {
            const statusOrder = {
                'CREATED': 0,
                'CALCULATION': 1,
                'PROPOSAL_SENT': 2,
                'PROPOSAL_ACCEPTED': 3,
                'PROPOSAL_REJECTED': 3, // Same level as accepted
                'PAID': 4,
                'FOR_SHIPMENT_UNPAID': 4, // Same level as paid
                'PICKING': 5,
                'SHIPPED': 6,
                'CLOSED': 7
            };

            const currentOrder = statusOrder[currentStatus] || 0;
            const stepOrder = statusOrder[stepStatus] || 0;

            if (currentStatus === stepStatus) {
                return 'current';
            } else if (currentOrder > stepOrder) {
                return 'completed';
            } else if (stepOrder === currentOrder + 1) {
                return 'available';
            } else {
                return 'unavailable';
            }
        }

        function generateWorkflowButtons(order) {
            let buttons = '<div class="workflow-buttons">';

            switch (order.status) {
                case 'CREATED':
                    buttons += `<button class="btn-workflow calculation" onclick="openCalculationModal('${order.id}')">
                        üßÆ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—á–µ—Ç
                    </button>`;
                    break;
                
                case 'CALCULATION':
                    buttons += `<button class="btn-workflow proposal" onclick="sendProposal('${order.id}')">
                        üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ö–ü
                    </button>`;
                    buttons += `<button class="btn-workflow duplicate" onclick="duplicateCalculation('${order.id}')">
                        üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç
                    </button>`;
                    break;
                
                case 'PROPOSAL_SENT':
                    buttons += `<button class="btn-workflow accept" onclick="openProposalResponseModal('${order.id}', 'ACCEPTED')">
                        ‚úÖ –ö–ü –ø—Ä–∏–Ω—è—Ç–æ
                    </button>`;
                    buttons += `<button class="btn-workflow reject" onclick="openProposalResponseModal('${order.id}', 'REJECTED')">
                        ‚ùå –ö–ü –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ
                    </button>`;
                    break;
                
                case 'PROPOSAL_ACCEPTED':
                    buttons += `<button class="btn-workflow proposal" onclick="changeOrderStatus('${order.id}', 'PAID')">
                        üí∞ –ó–∞—è–≤–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞
                    </button>`;
                    buttons += `<button class="btn-workflow reject" onclick="changeOrderStatus('${order.id}', 'FOR_SHIPMENT_UNPAID')">
                        üì¶ –í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã
                    </button>`;
                    break;
            }

            buttons += '</div>';
            return buttons;
        }

        function generateCalculationSection(order) {
            if (!order.calculation && order.status === 'CREATED') {
                return `
                    <div class="calculation-section">
                        <h3>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h3>
                        <p style="text-align: center; color: #666; font-style: italic;">
                            –†–∞—Å—á–µ—Ç –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω –¥–ª—è –¥–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏
                        </p>
                        <div class="workflow-buttons">
                            <button class="btn-workflow calculation" onclick="openCalculationModal('${order.id}')">
                                üßÆ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—á–µ—Ç
                            </button>
                        </div>
                    </div>
                `;
            }

            if (!order.calculation) {
                return '';
            }

            const calc = order.calculation;
            return `
                <div class="calculation-section">
                    <h3>–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏: ${calc.name}</h3>
                    <div class="calculation-summary">
                        <div>
                            <div class="calculation-field">
                                <label>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</label>
                                <span>${APIHelpers.formatCurrency(calc.totalCostBreakdown || 0)}</span>
                            </div>
                            <div class="calculation-field">
                                <label>–¶–µ–Ω–∞ –∑–∞ —à—Ç—É–∫—É:</label>
                                <span>${APIHelpers.formatCurrency(calc.pricePerUnit || 0)}</span>
                            </div>
                            <div class="calculation-field">
                                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                <span>${calc.quantity || 0} —à—Ç</span>
                            </div>
                            <div class="calculation-field">
                                <label>–°—É–º–º–∞ —Å–¥–µ–ª–∫–∏:</label>
                                <span>${APIHelpers.formatCurrency(calc.totalSaleAmount || 0)}</span>
                            </div>
                        </div>
                        <div>
                            <div class="calculation-field">
                                <label>–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å:</label>
                                <span>${APIHelpers.formatCurrency(calc.grossProfit || 0)}</span>
                            </div>
                            <div class="calculation-field">
                                <label>–ù–î–°:</label>
                                <span>${APIHelpers.formatCurrency(calc.vatAmount || 0)}</span>
                            </div>
                            <div class="calculation-field">
                                <label>–ü–æ–¥–æ—Ö–æ–¥–Ω—ã–π –Ω–∞–ª–æ–≥:</label>
                                <span>${APIHelpers.formatCurrency(calc.incomeTaxAmount || 0)}</span>
                            </div>
                            <div class="calculation-field">
                                <label>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:</label>
                                <span style="color: ${(calc.netProfit || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    ${APIHelpers.formatCurrency(calc.netProfit || 0)}
                                </span>
                            </div>
                            <div class="calculation-field">
                                <label>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å:</label>
                                <span style="color: ${(calc.profitabilityPercent || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    ${(calc.profitabilityPercent || 0).toFixed(1)}%
                                </span>
                            </div>
                        </div>
                    </div>
                    ${calc.status === '–ö–ü_–û–¢–ü–†–ê–í–õ–ï–ù–û' ? `
                        <p style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; color: #2e7d32;">
                            üìß –ö–ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${APIHelpers.formatDate(calc.sentDate)}
                            ${calc.reminderActive ? ' ‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã' : ''}
                        </p>
                    ` : ''}
                </div>
            `;
        }

        // Calculation modal functions
        function openCalculationModal(orderId) {
            currentOrderForCalculation = orderId;
            document.getElementById('calculationForm').reset();
            document.getElementById('calculationModalErrorMessage').style.display = 'none';
            
            // Set default values
            document.getElementById('vatPercent').value = 12;
            document.getElementById('incomeTaxPercent').value = 20;
            
            document.getElementById('calculationModal').style.display = 'block';
        }

        function closeCalculationModal() {
            document.getElementById('calculationModal').style.display = 'none';
            currentOrderForCalculation = null;
        }

        // Handle calculation form submission
        document.getElementById('calculationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentOrderForCalculation) {
                showCalculationModalMessage('–û—à–∏–±–∫–∞: –∑–∞—è–≤–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', true);
                return;
            }

            const calculationData = {
                name: document.getElementById('calculationName').value,
                gasCost: parseFloat(document.getElementById('gasCost').value) || 0,
                cylinderCost: parseFloat(document.getElementById('cylinderCost').value) || 0,
                preparationCost: parseFloat(document.getElementById('preparationCost').value) || 0,
                logisticsCost: parseFloat(document.getElementById('logisticsCost').value) || 0,
                workersCost: parseFloat(document.getElementById('workersCost').value) || 0,
                kickbacksCost: parseFloat(document.getElementById('kickbacksCost').value) || 0,
                pricePerUnit: parseFloat(document.getElementById('pricePerUnit').value) || 0,
                quantity: parseFloat(document.getElementById('quantity').value) || 0,
                productName: document.getElementById('productName').value || '',
                sellingCompany: document.getElementById('sellingCompany').value || '',
                organizationINN: document.getElementById('organizationINN').value || '',
                organizationName: document.getElementById('organizationName').value || '',
                responsibleManager: document.getElementById('responsibleManager').value || '',
                vatPercent: parseFloat(document.getElementById('vatPercent').value) || 12,
                incomeTaxPercent: parseFloat(document.getElementById('incomeTaxPercent').value) || 20
            };

            try {
                const saveBtn = document.getElementById('saveCalculationBtn');
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<div class="loading"></div>–°–æ–∑–¥–∞–Ω–∏–µ...';
                saveBtn.disabled = true;

                const response = await fetch(`/api/orders/${currentOrderForCalculation}/create-calculation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(calculationData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞');
                }

                const result = await response.json();
                showMessage(`–†–∞—Å—á–µ—Ç "${result.calculation.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –¥–ª—è –∑–∞—è–≤–∫–∏!`);
                closeCalculationModal();
                loadOrders(currentPage);

            } catch (error) {
                console.error('Error creating calculation:', error);
                showCalculationModalMessage(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞', true);
            } finally {
                const saveBtn = document.getElementById('saveCalculationBtn');
                saveBtn.textContent = 'üíæ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—á–µ—Ç';
                saveBtn.disabled = false;
            }
        });

        function showCalculationModalMessage(message, isError = false) {
            const errorEl = document.getElementById('calculationModalErrorMessage');
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            } else {
                errorEl.style.display = 'none';
            }
        }

        // Send proposal function
        async function sendProposal(orderId) {
            if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ö–ü –∫–ª–∏–µ–Ω—Ç—É? –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—É–¥—É—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.')) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}/send-proposal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ö–ü');
                }

                const result = await response.json();
                showMessage(result.message);
                loadOrders(currentPage);
                closeViewOrderModal();

            } catch (error) {
                console.error('Error sending proposal:', error);
                showMessage(error.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ö–ü', true);
            }
        }

        // Duplicate calculation function
        async function duplicateCalculation(orderId) {
            if (!confirm('–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏?')) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}/duplicate-calculation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ø–∏–∏ —Ä–∞—Å—á–µ—Ç–∞');
                }

                const result = await response.json();
                showMessage(result.message);
                
            } catch (error) {
                console.error('Error duplicating calculation:', error);
                showMessage(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–ø–∏–∏ —Ä–∞—Å—á–µ—Ç–∞', true);
            }
        }

        // Proposal response modal functions
        function openProposalResponseModal(orderId, responseType) {
            currentOrderForProposal = { orderId, responseType };
            document.getElementById('responseNotes').value = '';
            document.getElementById('proposalResponseErrorMessage').style.display = 'none';
            
            const responseText = responseType === 'ACCEPTED' ? '–ø—Ä–∏–Ω—è—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å';
            document.getElementById('proposalResponseText').textContent = 
                `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Ä–µ—à–∏–ª ${responseText} –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:`;
            
            document.getElementById('proposalResponseModal').style.display = 'block';
        }

        function closeProposalResponseModal() {
            document.getElementById('proposalResponseModal').style.display = 'none';
            currentOrderForProposal = null;
        }

        async function submitProposalResponse(response) {
            if (!currentOrderForProposal) {
                showProposalResponseModalMessage('–û—à–∏–±–∫–∞: –∑–∞—è–≤–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', true);
                return;
            }

            const notes = document.getElementById('responseNotes').value.trim();

            try {
                const result = await fetch(`/api/orders/${currentOrderForProposal.orderId}/proposal-response`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ response, notes })
                });

                if (!result.ok) {
                    const error = await result.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ö–ü');
                }

                const data = await result.json();
                showMessage(data.message);
                closeProposalResponseModal();
                loadOrders(currentPage);
                closeViewOrderModal();

            } catch (error) {
                console.error('Error submitting proposal response:', error);
                showProposalResponseModalMessage(error.message || '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ö–ü', true);
            }
        }

        function showProposalResponseModalMessage(message, isError = false) {
            const errorEl = document.getElementById('proposalResponseErrorMessage');
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            } else {
                errorEl.style.display = 'none';
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        window.onclick = function(event) {
            const modals = ['orderModal', 'productSelectorModal', 'viewOrderModal', 'statusSelectionModal', 'calculationModal', 'proposalResponseModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    if (modalId === 'orderModal') {
                        orderItems = [];
                    }
                    if (modalId === 'productSelectorModal') {
                        selectedProduct = null;
                    }
                    if (modalId === 'statusSelectionModal') {
                        pendingStatusChange = null;
                    }
                    if (modalId === 'calculationModal') {
                        currentOrderForCalculation = null;
                    }
                    if (modalId === 'proposalResponseModal') {
                        currentOrderForProposal = null;
                    }
                }
            });
        }
    </script>
</body>
</html>