<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Склад - CO_LAB CRM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: white;
            box-sizing: border-box;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        h1 {
            color: #333;
            font-size: 24px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-left: 20px;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Search and Filter Controls */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-outline {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* Stock Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .stat-card.low-stock .stat-value {
            color: #e74c3c;
        }

        .stat-card.out-of-stock .stat-value {
            color: #dc3545;
        }

        .stat-card.total-value .stat-value {
            color: #28a745;
        }

        /* Products Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            position: relative;
        }

        th:hover {
            background: #e9ecef;
        }

        .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0.5;
        }

        th.sort-asc .sort-icon::after {
            content: '↑';
            opacity: 1;
        }

        th.sort-desc .sort-icon::after {
            content: '↓';
            opacity: 1;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        /* Stock Level Colors */
        .stock-level {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .stock-level.out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        .stock-level.low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .stock-level.normal {
            background: #d4edda;
            color: #155724;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e5e9;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e1e5e9;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .items-per-page select {
            padding: 6px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .action-btn.edit {
            background: #ffc107;
            color: #212529;
        }

        .action-btn.stock {
            background: #17a2b8;
            color: white;
        }

        .action-btn.details {
            background: #6c757d;
            color: white;
        }

        /* Loading and Empty States */
        .loading, .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e1e5e9;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .pagination-container {
                flex-direction: column;
                gap: 15px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Управление складом</h1>
            <div style="display: flex; align-items: center;">
                <nav class="nav-buttons">
                    <a href="markup_calculator.html" class="nav-btn">Калькулятор наценки</a>
                    <a href="clients.html" class="nav-btn">Клиенты</a>
                    <a href="orders.html" class="nav-btn">Заявки</a>
                </nav>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                        <span id="userInitials">U</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Statistics -->
        <div class="stats-grid" id="stockStats">
            <div class="stat-card">
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Всего товаров</div>
            </div>
            <div class="stat-card low-stock">
                <div class="stat-value" id="lowStockProducts">0</div>
                <div class="stat-label">Заканчивается</div>
            </div>
            <div class="stat-card out-of-stock">
                <div class="stat-value" id="outOfStockProducts">0</div>
                <div class="stat-label">Нет на складе</div>
            </div>
            <div class="stat-card total-value">
                <div class="stat-value" id="totalValue">0 сум</div>
                <div class="stat-label">Общая стоимость</div>
            </div>
        </div>

        <!-- Search and Filter Controls -->
        <div class="controls">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Поиск по названию, коду, поставщику, описанию..."
                    onkeyup="debounceSearch()"
                >
            </div>
            
            <div class="filter-group">
                <select id="supplierFilter" onchange="applyFilters()">
                    <option value="">Все поставщики</option>
                </select>
                
                <select id="stockFilter" onchange="applyFilters()">
                    <option value="">Все товары</option>
                    <option value="normal">В наличии</option>
                    <option value="low">Заканчивается</option>
                    <option value="out">Нет на складе</option>
                </select>
            </div>

            <div class="filter-group">
                <input 
                    type="number" 
                    id="minPrice" 
                    placeholder="Мин. цена"
                    class="filter-input"
                    onchange="applyFilters()"
                >
                <input 
                    type="number" 
                    id="maxPrice" 
                    placeholder="Макс. цена"
                    class="filter-input"
                    onchange="applyFilters()"
                >
            </div>

            <button class="btn btn-outline" onclick="clearFilters()">Очистить</button>
            <button class="btn btn-primary" onclick="showAddProductModal()">+ Добавить товар</button>
        </div>

        <!-- Products Table -->
        <div class="table-container">
            <table id="productsTable">
                <thead>
                    <tr>
                        <th onclick="sortBy('name')">
                            Название
                            <span class="sort-icon"></span>
                        </th>
                        <th onclick="sortBy('code')">
                            Код
                            <span class="sort-icon"></span>
                        </th>
                        <th onclick="sortBy('supplier')">
                            Поставщик
                            <span class="sort-icon"></span>
                        </th>
                        <th onclick="sortBy('currentStock')">
                            Остаток
                            <span class="sort-icon"></span>
                        </th>
                        <th onclick="sortBy('minStock')">
                            Мин. остаток
                            <span class="sort-icon"></span>
                        </th>
                        <th onclick="sortBy('purchasePrice')">
                            Цена закупки
                            <span class="sort-icon"></span>
                        </th>
                        <th onclick="sortBy('location')">
                            Расположение
                            <span class="sort-icon"></span>
                        </th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <tr>
                        <td colspan="8" class="loading">Загрузка данных...</td>
                    </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info" id="paginationInfo">
                    Показано 0-0 из 0
                </div>

                <div class="items-per-page">
                    <span>Показать:</span>
                    <select id="itemsPerPage" onchange="changeItemsPerPage()">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="pagination" id="paginationControls">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Global state
        let currentPage = 1;
        let itemsPerPage = 20;
        let currentSort = 'createdAt';
        let currentOrder = 'DESC';
        let searchTerm = '';
        let filters = {};
        let productsData = null;
        let searchTimeout = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadProducts();
        });

        async function initializePage() {
            // Set user info
            const user = APIHelpers.getCurrentUser();
            if (user) {
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('userInitials').textContent = initials;
            }
        }

        // Load products with current parameters
        async function loadProducts() {
            try {
                showLoading();

                const params = APIHelpers.buildPaginationParams(
                    currentPage,
                    itemsPerPage,
                    currentSort,
                    currentOrder,
                    searchTerm,
                    filters
                );

                const response = await API.getProductsPaginated(
                    currentPage,
                    itemsPerPage,
                    currentSort,
                    currentOrder,
                    searchTerm,
                    filters
                );

                productsData = response;
                renderProducts(response.products);
                renderPagination(response.pagination);
                renderStats(response.stockStats);
                renderSuppliers(response.suppliers);
                updateSortHeaders();

            } catch (error) {
                console.error('Error loading products:', error);
                showError(APIHelpers.formatError(error));
            }
        }

        function showLoading() {
            document.getElementById('productsTableBody').innerHTML = `
                <tr><td colspan="8" class="loading">Загрузка данных...</td></tr>
            `;
        }

        function showError(message) {
            document.getElementById('productsTableBody').innerHTML = `
                <tr><td colspan="8" class="empty-state" style="color: #dc3545;">${message}</td></tr>
            `;
        }

        function renderProducts(products) {
            const tbody = document.getElementById('productsTableBody');
            
            if (!products || products.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="8" class="empty-state">Товары не найдены</td></tr>
                `;
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>
                        <div style="font-weight: 600;">${product.name}</div>
                        <div style="font-size: 12px; color: #666;">${product.description || ''}</div>
                    </td>
                    <td>${product.code || '-'}</td>
                    <td>${product.supplier || '-'}</td>
                    <td>
                        <div class="stock-level ${getStockLevelClass(product)}">
                            ${product.currentStock} ${product.unit}
                        </div>
                    </td>
                    <td>${product.minStock} ${product.unit}</td>
                    <td>${APIHelpers.formatCurrency(product.purchasePrice)}</td>
                    <td>${product.location || '-'}</td>
                    <td>
                        <div class="quick-actions">
                            <button class="action-btn stock" onclick="adjustStock('${product.id}', ${product.currentStock})">
                                Корректировка
                            </button>
                            <button class="action-btn edit" onclick="editProduct('${product.id}')">
                                Редактировать
                            </button>
                            <button class="action-btn details" onclick="showProductDetails('${product.id}')">
                                Подробнее
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStockLevelClass(product) {
            if (product.outOfStock) return 'out-of-stock';
            if (product.lowStock) return 'low-stock';
            return 'normal';
        }

        function renderPagination(pagination) {
            const info = APIHelpers.getPaginationInfo(pagination);
            document.getElementById('paginationInfo').textContent = info.text;

            const controls = document.getElementById('paginationControls');
            let buttons = '';

            // Previous button
            buttons += `
                <button ${pagination.hasPrev ? '' : 'disabled'} onclick="goToPage(${pagination.prevPage})">
                    ← Предыдущая
                </button>
            `;

            // Page numbers
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.pages, pagination.page + 2);

            if (startPage > 1) {
                buttons += `<button onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    buttons += `<span>...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                buttons += `
                    <button ${i === pagination.page ? 'class="active"' : ''} onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }

            if (endPage < pagination.pages) {
                if (endPage < pagination.pages - 1) {
                    buttons += `<span>...</span>`;
                }
                buttons += `<button onclick="goToPage(${pagination.pages})">${pagination.pages}</button>`;
            }

            // Next button
            buttons += `
                <button ${pagination.hasNext ? '' : 'disabled'} onclick="goToPage(${pagination.nextPage})">
                    Следующая →
                </button>
            `;

            controls.innerHTML = buttons;
        }

        function renderStats(stockStats) {
            if (!stockStats) return;

            document.getElementById('totalProducts').textContent = productsData.pagination.total;
            document.getElementById('lowStockProducts').textContent = stockStats.lowStockCount;
            document.getElementById('outOfStockProducts').textContent = stockStats.outOfStockCount;
            document.getElementById('totalValue').textContent = APIHelpers.formatCurrency(stockStats.totalValue);
        }

        function renderSuppliers(suppliers) {
            const select = document.getElementById('supplierFilter');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Все поставщики</option>';
            
            if (suppliers && suppliers.length > 0) {
                suppliers.forEach(supplier => {
                    select.innerHTML += `<option value="${supplier}" ${supplier === currentValue ? 'selected' : ''}>${supplier}</option>`;
                });
            }
        }

        function updateSortHeaders() {
            // Reset all headers
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Find and update current sort header
            const currentHeader = Array.from(document.querySelectorAll('th')).find(th => {
                return th.textContent.toLowerCase().replace(/\s+/g, '') === getSortDisplayName(currentSort).toLowerCase().replace(/\s+/g, '');
            });

            if (currentHeader) {
                currentHeader.classList.add(currentOrder === 'ASC' ? 'sort-asc' : 'sort-desc');
            }
        }

        function getSortDisplayName(field) {
            const names = {
                'name': 'название',
                'code': 'код',
                'supplier': 'поставщик',
                'currentStock': 'остаток',
                'minStock': 'мин.остаток',
                'purchasePrice': 'ценазакупки',
                'location': 'расположение'
            };
            return names[field] || field;
        }

        // Event handlers
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchTerm = document.getElementById('searchInput').value.trim();
                currentPage = 1;
                loadProducts();
            }, 500);
        }

        function applyFilters() {
            const supplier = document.getElementById('supplierFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;

            filters = {};

            if (supplier) {
                filters.supplier = supplier;
            }

            if (stockFilter === 'low') {
                filters.lowStock = 'true';
            }

            if (minPrice || maxPrice) {
                const priceRange = {};
                if (minPrice) priceRange.min = parseFloat(minPrice);
                if (maxPrice) priceRange.max = parseFloat(maxPrice);
                filters.priceRange = JSON.stringify(priceRange);
            }

            currentPage = 1;
            loadProducts();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('supplierFilter').value = '';
            document.getElementById('stockFilter').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            
            searchTerm = '';
            filters = {};
            currentPage = 1;
            loadProducts();
        }

        function sortBy(field) {
            if (currentSort === field) {
                currentOrder = currentOrder === 'ASC' ? 'DESC' : 'ASC';
            } else {
                currentSort = field;
                currentOrder = 'ASC';
            }
            currentPage = 1;
            loadProducts();
        }

        function goToPage(page) {
            if (page && page !== currentPage) {
                currentPage = page;
                loadProducts();
            }
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            loadProducts();
        }

        // Product actions
        async function adjustStock(productId, currentStock) {
            const newStock = prompt(`Текущий остаток: ${currentStock}\nВведите новый остаток:`, currentStock);
            
            if (newStock !== null && !isNaN(newStock)) {
                try {
                    await API.updateProductQuantity(productId, parseFloat(newStock));
                    loadProducts(); // Reload to show updated data
                } catch (error) {
                    alert('Ошибка при обновлении остатка: ' + APIHelpers.formatError(error));
                }
            }
        }

        async function editProduct(productId) {
            // TODO: Implement product editing modal
            alert('Функция редактирования товара будет добавлена в следующей версии');
        }

        async function showProductDetails(productId) {
            try {
                const product = await API.getProduct(productId);
                const stats = await API.getProductStats(productId);
                
                alert(`
Товар: ${product.name}
Код: ${product.code || 'Не указан'}
Поставщик: ${product.supplier || 'Не указан'}
Текущий остаток: ${product.currentStock} ${product.unit}
Минимальный остаток: ${product.minStock} ${product.unit}
Цена закупки: ${APIHelpers.formatCurrency(product.purchasePrice)}
Расположение: ${product.location || 'Не указано'}

Статистика:
- Всего поступлений: ${stats.totalIncoming}
- Всего списаний: ${stats.totalOutgoing}
- Стоимость остатка: ${APIHelpers.formatCurrency(stats.stockValue)}
- Коэффициент оборачиваемости: ${stats.turnoverRate}
                `);
            } catch (error) {
                alert('Ошибка при загрузке данных товара: ' + APIHelpers.formatError(error));
            }
        }

        function showAddProductModal() {
            // TODO: Implement add product modal
            alert('Функция добавления товара будет добавлена в следующей версии');
        }

        function toggleUserDropdown() {
            // TODO: Implement user dropdown
            if (confirm('Выйти из системы?')) {
                API.logout();
            }
        }
    </script>
</body>
</html>