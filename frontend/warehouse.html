<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Склад - CO_LAB CRM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: white;
            box-sizing: border-box;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        h1 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-left: 20px;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 12px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            margin-bottom: 4px;
        }

        .user-name {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .user-email {
            color: #666;
            font-size: 12px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .dropdown-item.logout:hover {
            background-color: #fff5f5;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-warning {
            background: #fd7e14;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-warning:hover {
            background: #e8670c;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-info:hover {
            background: #138496;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-for-shipment-unpaid {
            background: #fff3cd;
            color: #856404;
        }

        .status-picking {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-shipped {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .shipment-order-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .shipment-items {
            margin-bottom: 25px;
        }

        .shipment-item {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .shipment-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .quantity-info {
            color: #666;
            font-size: 14px;
        }

        .serial-numbers-section h5 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .serial-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .serial-input-row label {
            min-width: 80px;
            font-size: 13px;
            color: #666;
        }

        .serial-input-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .shipment-files-section {
            border-top: 1px solid #e1e5e9;
            padding-top: 20px;
        }

        .file-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .files-preview {
            margin-top: 15px;
        }

        .file-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            margin-bottom: 5px;
            background: white;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .file-preview-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }

        .image-preview img:hover {
            transform: scale(1.05);
        }

        .file-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 24px;
            border: 1px solid #ddd;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .file-type {
            font-size: 11px;
            color: #999;
        }

        .no-files-text {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
        }

        .image-preview-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .close-preview {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-preview:hover {
            color: #333;
        }

        .image-preview-body {
            padding: 20px;
            text-align: center;
        }

        .image-preview-body img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 4px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .warehouse-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .warehouse-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .warehouse-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .warehouse-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .price-range-filter {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .price-range-filter input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .sortable:hover {
            background-color: #f8f9fa;
        }

        .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.5;
        }

        .sort-indicator.asc::after {
            content: '↑';
            opacity: 1;
        }

        .sort-indicator.desc::after {
            content: '↓';
            opacity: 1;
        }

        /* Stock level colors */
        .stock-level {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .stock-level.normal {
            background-color: #d4edda;
            color: #155724;
        }

        .stock-level.low {
            background-color: #fff3cd;
            color: #856404;
        }

        .stock-level.out {
            background-color: #f8d7da;
            color: #721c24;
        }

        .product-row.low-stock {
            background-color: #fff8e1;
        }

        .product-row.out-of-stock {
            background-color: #ffebee;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        #historyModal {
            z-index: 1200;
        }

        #operationModal {
            z-index: 1200;
        }

        #productCardModal {
            z-index: 1050;
        }

        #productModal {
            z-index: 1200;
        }

        #operationTypeModal {
            z-index: 1200;
        }

        #inventoryModal {
            z-index: 1200;
        }

        .modal-content {
            background-color: white;
            margin: 8% auto;
            padding: 20px;
            border-radius: 12px;
            width: 60%;
            max-width: 500px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .quantity-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .quantity-low {
            background: #ffebee;
            color: #c62828;
        }

        .quantity-normal {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .quantity-zero {
            background: #ffebee;
            color: #d32f2f;
        }

        .transaction-history {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
        }

        .transaction-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .transaction-item.outgoing {
            border-left-color: #dc3545;
        }

        .transaction-item.inventory {
            border-left-color: #ffc107;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 12px;
            color: #c33;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 8px;
            padding: 12px;
            color: #3c3;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Grouped serials styles */
        .product-group {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            background: white;
        }

        .product-group-header {
            background: #f8f9fa;
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .product-group-header:hover {
            background: #e9ecef;
        }

        .product-group-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-group-name {
            font-weight: 600;
            color: #333;
        }

        .product-group-code {
            color: #666;
            font-size: 12px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .product-group-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .stat-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.in-stock {
            background: #d4edda;
            color: #155724;
        }

        .stat-badge.out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        .expand-icon {
            transition: transform 0.2s;
            font-size: 18px;
            color: #666;
        }

        .product-group.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .serials-list {
            display: none;
            padding: 0;
        }

        .product-group.expanded .serials-list {
            display: block;
        }

        .serial-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .serial-item:last-child {
            border-bottom: none;
        }

        .serial-number {
            font-weight: 600;
            color: #333;
        }

        .serial-dates {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 10px;
        }

        .serial-status {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .serial-status.in-stock {
            background: #d4edda;
            color: #155724;
        }

        .serial-status.out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        /* Serial number form styles */
        .serial-row {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .serial-row .form-group {
            margin-bottom: 0;
        }

        .serial-row .form-group label {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .serial-row .form-group input {
            padding: 6px;
            font-size: 12px;
            height: 33px;
            min-height: 33px;
            box-sizing: border-box;
        }

        .serial-row .btn-remove {
            padding: 6px 8px;
            font-size: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Camera interface styles */
        .camera-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .camera-modal-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .camera-container {
            position: relative;
            margin: 20px 0;
        }

        #cameraVideo {
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 10px;
            background: #000;
        }

        .camera-controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn-capture {
            background: #28a745;
            color: white;
        }

        .camera-btn-capture:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .camera-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .camera-btn-cancel:hover {
            background: #5a6268;
        }

        .camera-btn-save {
            background: #007bff;
            color: white;
        }

        .camera-btn-save:hover {
            background: #0056b3;
        }

        .photos-preview {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo-preview {
            position: relative;
            width: 120px;
            height: 90px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e1e5e9;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-remove:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .camera-modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                padding: 15px;
            }

            .camera-controls {
                flex-direction: column;
                align-items: center;
            }

            .camera-btn {
                width: 200px;
                justify-content: center;
            }
        }

        /* Bulk product modal styles */
        .input-method-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .serial-row {
            margin-bottom: 5px;
        }

        .serial-input, .manufacture-date, .cert-date, .next-cert-date,
        .product-serial-input, .product-manufacture-date, .product-cert-date, .product-next-cert-date {
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            height: 40px;
            box-sizing: border-box;
            line-height: 1.4;
        }

        .serial-input:focus, .manufacture-date:focus, .cert-date:focus, .next-cert-date:focus,
        .product-serial-input:focus, .product-manufacture-date:focus, .product-cert-date:focus, .product-next-cert-date:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        /* Общие стили для всех вводов в формах */
        .form-group input,
        .form-group select,
        .form-group textarea {
            height: 40px;
            min-height: 40px;
            box-sizing: border-box;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.4;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        /* Особые стили для textarea */
        .form-group textarea {
            height: 80px;
            min-height: 80px;
            resize: vertical;
        }
        
        /* Фиксированная высота для строк с серийными номерами */
        .serial-row {
            min-height: 60px;
        }
        
        .serial-row input {
            height: 33px;
            min-height: 33px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 30px;">
                    <h1>Склад</h1>
                    <button class="btn btn-success" onclick="openAddProductModal()">➕ Добавить товар</button>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="nav-buttons">
                        <a href="markup_calculator.html" class="btn btn-secondary">Калькулятор</a>
                        <a href="clients.html" class="btn btn-secondary">Контрагенты</a>
                        <a href="orders.html" class="btn btn-secondary">Заявки</a>
                        <a href="contracts.html" class="btn btn-secondary">Договоры</a>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                            У
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-header">
                                <div class="user-name" id="userName">Пользователь</div>
                                <div class="user-email" id="userEmail">user@example.com</div>
                            </div>
                            <button class="dropdown-item logout" onclick="logout()">
                                🚪 Выйти из системы
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">-</div>
                <div class="stat-label">Позиций товаров</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalQuantity">-</div>
                <div class="stat-label">Единиц на складе</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalValue">-</div>
                <div class="stat-label">Общая стоимость (сум)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lowStockItems">-</div>
                <div class="stat-label">Товары с низким остатком</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('warehouse')">Склад</button>
            <button class="tab" onclick="switchTab('transactions')">Операции</button>
            <button class="tab" onclick="switchTab('orders')">Заявки на отгрузку</button>
        </div>

        <!-- Вкладка склада -->
        <div id="warehouseTab" class="tab-content active">
            <div class="section" style="position: relative;">
                <div id="warehouseLoadingOverlay" class="loading-overlay" style="display: none;">
                    <div>
                        <div class="loading"></div>
                        <span>Загрузка...</span>
                    </div>
                </div>

                <div id="warehouseErrorMessage" class="error-message" style="display: none;"></div>
                <div id="warehouseSuccessMessage" class="success-message" style="display: none;"></div>

                <div class="search-controls">
                    <input type="text" class="search-input" id="warehouseSearchInput" placeholder="🔍 Поиск товаров по названию, артикулу, поставщику..." onkeyup="handleWarehouseSearch()">
                    <div class="filter-controls">
                        <label>
                            <input type="checkbox" id="lowStockFilter" onchange="handleWarehouseSearch()">
                            Только с низким остатком
                        </label>
                        <select id="supplierFilter" onchange="handleWarehouseSearch()">
                            <option value="">Все поставщики</option>
                        </select>
                        <div class="price-range-filter">
                            <label>Цена от:</label>
                            <input type="number" id="minPriceFilter" placeholder="0" step="0.01" onchange="handleWarehouseSearch()">
                            <label>до:</label>
                            <input type="number" id="maxPriceFilter" placeholder="∞" step="0.01" onchange="handleWarehouseSearch()">
                        </div>
                        <button class="btn btn-primary" onclick="loadWarehouse()">🔄 Обновить</button>
                    </div>
                </div>
                
                <div class="table-controls">
                    <div class="sort-controls">
                        <label>Сортировать по:</label>
                        <select id="sortField" onchange="handleWarehouseSorting()">
                            <option value="name">Название</option>
                            <option value="code">Артикул</option>
                            <option value="supplier">Поставщик</option>
                            <option value="purchasePrice">Цена</option>
                            <option value="currentStock">Остаток</option>
                            <option value="minStock">Мин. остаток</option>
                            <option value="createdAt" selected>Дата создания</option>
                            <option value="updatedAt">Дата обновления</option>
                        </select>
                        <select id="sortOrder" onchange="handleWarehouseSorting()">
                            <option value="ASC">По возрастанию</option>
                            <option value="DESC" selected>По убыванию</option>
                        </select>
                    </div>
                    <div class="pagination-controls">
                        <label>Показать по:</label>
                        <select id="pageSize" onchange="handlePageSizeChange()">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span id="paginationInfo" class="pagination-info"></span>
                    </div>
                </div>
                
                <div id="warehouseTableContainer">
                    <table class="warehouse-table" id="warehouseTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">
                                    Товар <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="code">
                                    Артикул <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="supplier">
                                    Поставщик <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="currentStock">
                                    Остаток <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="minStock">
                                    Мин. остаток <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="purchasePrice">
                                    Цена <span class="sort-indicator">↕</span>
                                </th>
                                <th>Единица</th>
                                <th>Последнее движение</th>
                            </tr>
                        </thead>
                        <tbody id="warehouseTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="warehousePagination" class="pagination"></div>
            </div>
        </div>



        <!-- Вкладка операций -->
        <div id="transactionsTab" class="tab-content">
            <div class="section" style="position: relative;">
                <div id="transactionsLoadingOverlay" class="loading-overlay" style="display: none;">
                    <div>
                        <div class="loading"></div>
                        <span>Загрузка...</span>
                    </div>
                </div>

                <div id="transactionsErrorMessage" class="error-message" style="display: none;"></div>
                <div id="transactionsSuccessMessage" class="success-message" style="display: none;"></div>

                <div class="search-controls">
                    <select id="transactionTypeFilter" onchange="loadTransactions()">
                        <option value="">Все операции</option>
                        <option value="INCOMING">📥 Поступления</option>
                        <option value="OUTGOING">📤 Отгрузки</option>
                        <option value="INVENTORY">📋 Инвентаризации</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadTransactions()">🔄 Обновить</button>
                </div>
                
                <div id="transactionsTableContainer">
                    <!-- Transactions table will be loaded here -->
                </div>

                <div id="transactionsPagination" class="pagination"></div>
            </div>
        </div>

        <!-- Вкладка заявок на отгрузку -->
        <div id="ordersTab" class="tab-content">
            <div class="section" style="position: relative;">
                <div id="ordersLoadingOverlay" class="loading-overlay" style="display: none;">
                    <div>
                        <div class="loading"></div>
                        <span>Загрузка...</span>
                    </div>
                </div>

                <div id="ordersErrorMessage" class="error-message" style="display: none;"></div>
                <div id="ordersSuccessMessage" class="success-message" style="display: none;"></div>

                <div class="search-controls">
                    <button class="btn btn-primary" onclick="loadWarehouseOrders()">🔄 Обновить</button>
                </div>
                
                <div id="ordersTableContainer">
                    <!-- Orders table will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления товара -->
    <div id="productModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="productModalTitle">Добавить товар</h2>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            
            <div id="productModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="productForm">
                <!-- Общие параметры товара -->
                <div class="section" style="margin-bottom: 25px;">
                    <h3>Общие параметры товара</h3>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="productName">Название товара *</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="productUnit">Единица измерения</label>
                            <select id="productUnit">
                                <option value="шт">шт</option>
                                <option value="кг">кг</option>
                                <option value="м">м</option>
                                <option value="м²">м²</option>
                                <option value="м³">м³</option>
                                <option value="л">л</option>
                                <option value="упак">упак</option>
                                <option value="коробка">коробка</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="productSupplier">Поставщик</label>
                            <select id="productSupplier" style="width: 100%;">
                                <option value="">Выберите поставщика</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="productMinStock">Минимальный остаток</label>
                            <input type="number" id="productMinStock" value="0" min="0" step="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="productPurchasePrice">Цена закупки</label>
                            <input type="number" id="productPurchasePrice" value="0" min="0" step="0.01">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="productCategory">Категория</label>
                            <input type="text" id="productCategory" placeholder="Категория товара">
                        </div>
                    </div>
                </div>

                <!-- Способы ввода номеров баллонов -->
                <div class="section">
                    <h3>Номера баллонов</h3>
                    
                    <div class="form-group">
                        <label>Способ ввода:</label>
                        <div style="display: flex; gap: 15px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; margin: 0;">
                                <input type="radio" name="productInputMethod" value="manual" checked onchange="switchProductInputMethod()" style="margin-right: 8px;">
                                Ручной ввод
                            </label>
                            <label style="display: flex; align-items: center; margin: 0;">
                                <input type="radio" name="productInputMethod" value="range" onchange="switchProductInputMethod()" style="margin-right: 8px;">
                                Диапазон номеров
                            </label>
                            <label style="display: flex; align-items: center; margin: 0;">
                                <input type="radio" name="productInputMethod" value="text" onchange="switchProductInputMethod()" style="margin-right: 8px;">
                                Текстовый блок
                            </label>
                        </div>
                    </div>

                    <!-- Ручной ввод -->
                    <div id="productManualInput" class="input-method-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label>Номера баллонов:</label>
                            <button type="button" class="btn btn-secondary" onclick="addProductSerialRow()">➕ Добавить строку</button>
                        </div>
                        <div id="productSerialNumbersContainer">
                            <div class="serial-row">
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <div style="flex: 2; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Номер баллона *</small>
                                        <input type="text" placeholder="Номер баллона" class="product-serial-input" style="height: 33px;" required>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Дата изготовления *</small>
                                        <input type="text" placeholder="MM/YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Дата изготовления в формате MM/YYYY" required>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Дата переосвидетельствования *</small>
                                        <input type="text" placeholder="MM/YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Дата переосвидетельствования в формате MM/YYYY" required>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Следующая дата *</small>
                                        <input type="text" placeholder="MM/YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Следующая дата переосвидетельствования в формате MM/YYYY" required>
                                    </div>
                                    <div style="display: flex; align-items: flex-end; min-height: 50px;">
                                        <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px; height: 33px;">🗑️</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Диапазон номеров -->
                    <div id="productRangeInput" class="input-method-section" style="display: none;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangePrefix">Префикс</label>
                                <input type="text" id="productRangePrefix" placeholder="BAL" value="BAL">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeStart">Начальный номер</label>
                                <input type="number" id="productRangeStart" placeholder="1" min="1" value="1">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeEnd">Конечный номер</label>
                                <input type="number" id="productRangeEnd" placeholder="10" min="1">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeFormat">Разрядность</label>
                                <input type="number" id="productRangeFormat" placeholder="3" min="1" value="3">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeManufactureDate">Дата изготовления (месяц/год)</label>
                                <input type="text" id="productRangeManufactureDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="Формат: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeCertDate">Дата переосвидетельствования (месяц/год)</label>
                                <input type="text" id="productRangeCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="Формат: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeNextCertDate">Следующая дата переосвидетельствования (месяц/год)</label>
                                <input type="text" id="productRangeNextCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="Формат: MM/YYYY">
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="previewProductRange()">👁️ Предварительный просмотр</button>
                            <div id="productRangePreview" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                                <strong>Будет создано номеров:</strong>
                                <div id="productRangePreviewList" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Текстовый блок -->
                    <div id="productTextInput" class="input-method-section" style="display: none;">
                        <div class="form-group">
                            <label for="productTextSerialNumbers">Номера баллонов (по одному на строке)</label>
                            <textarea id="productTextSerialNumbers" rows="10" placeholder="BAL001&#10;BAL002&#10;BAL003&#10;..."></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                Вставьте номера баллонов, каждый с новой строки. Пустые строки будут проигнорированы.
                            </small>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="productTextManufactureDate">Дата изготовления (месяц/год)</label>
                                <input type="text" id="productTextManufactureDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="Формат: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productTextCertDate">Дата переосвидетельствования (месяц/год)</label>
                                <input type="text" id="productTextCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="Формат: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productTextNextCertDate">Следующая дата переосвидетельствования (месяц/год)</label>
                                <input type="text" id="productTextNextCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="Формат: MM/YYYY">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()" style="margin-right: 10px;">Отмена</button>
                    <button type="submit" class="btn btn-success" id="saveProductBtn">💾 Добавить товар</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно операций с товаром -->
    <div id="operationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="operationModalTitle">Операция с товаром</h2>
                <span class="close" onclick="closeOperationModal()">&times;</span>
            </div>
            
            <div id="operationModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="operationForm">
                <div class="form-group">
                    <label for="operationType">Тип операции *</label>
                    <select id="operationType" required onchange="updateOperationForm()">
                        <option value="">Выберите операцию</option>
                        <option value="INCOMING">📥 Поступление</option>
                        <option value="OUTGOING">📤 Отгрузка/Списание</option>
                        <option value="INVENTORY">📋 Инвентаризация</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="operationQuantity">Количество *</label>
                        <input type="number" id="operationQuantity" step="0.01" min="0" required>
                        <small id="currentStockInfo" style="color: #666;"></small>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="operationReason">Причина/Комментарий</label>
                        <input type="text" id="operationReason" placeholder="Причина операции">
                    </div>
                </div>

                <div id="clientField" class="form-group" style="display: none;">
                    <label for="operationClient">Контрагент</label>
                    <select id="operationClient">
                        <option value="">Выберите контрагента</option>
                    </select>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeOperationModal()" style="margin-right: 10px;">Отмена</button>
                    <button type="submit" class="btn btn-primary" id="executeOperationBtn">Выполнить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно истории товара -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="historyModalTitle">История товара</h2>
                <span class="close" onclick="closeHistoryModal()">&times;</span>
            </div>
            
            <div id="transactionHistory" class="transaction-history">
                <!-- История будет загружена здесь -->
            </div>
        </div>
    </div>

    <!-- Модальное окно камеры для фотографий отгрузки -->
    <div id="cameraModal" class="camera-modal">
        <div class="camera-modal-content">
            <h3>📸 Фотографии подтверждения отгрузки</h3>
            <p>Сделайте фотографии для подтверждения факта отгрузки товара</p>
            
            <div class="camera-container">
                <video id="cameraVideo" autoplay muted playsinline></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>

            <div class="camera-controls">
                <button class="camera-btn camera-btn-capture" onclick="capturePhoto()">
                    📷 Сделать фото
                </button>
                <button class="camera-btn camera-btn-cancel" onclick="closeCameraModal()">
                    ❌ Отмена
                </button>
                <button class="camera-btn camera-btn-save" onclick="savePhotos()" style="display: none;">
                    💾 Сохранить фото
                </button>
            </div>

            <div id="photosPreview" class="photos-preview"></div>
        </div>
    </div>

    <!-- Модальное окно отгрузки заявки -->
    <div id="shipmentModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>📦 Форма отгрузки</h2>
                <span class="close" onclick="closeShipmentModal()">&times;</span>
            </div>
            
            <div id="shipmentFormContent">
                <!-- Содержимое формы будет загружено динамически -->
            </div>
            
            <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                <button type="button" class="btn btn-secondary" onclick="closeShipmentModal()" style="margin-right: 10px;">Отмена</button>
                <button type="button" class="btn btn-success" onclick="executeShipment()">📦 Выполнить отгрузку</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора типа операции -->
    <div id="operationTypeModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="operationTypeTitle">Выберите тип операции</h2>
                <span class="close" onclick="closeOperationTypeModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <p id="operationTypeProductName" style="margin-bottom: 20px; font-weight: bold;"></p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="btn btn-success" onclick="selectOperationType('incoming')" style="padding: 15px; text-align: left;">
                        📥 <strong>Поступление</strong>
                        <small style="display: block; margin-top: 5px; color: #6c757d;">Приход товара с номерами баллонов</small>
                    </button>
                    
                    <button class="btn btn-info" onclick="selectOperationType('inventory')" style="padding: 15px; text-align: left;">
                        📋 <strong>Инвентаризация</strong>
                        <small style="display: block; margin-top: 5px; color: #6c757d;">Корректировка остатков</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно инвентаризации -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="inventoryModalTitle">Инвентаризация: </h2>
                <span class="close" onclick="closeInventoryModal()">&times;</span>
            </div>
            
            <div id="inventoryModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>Текущий остаток на складе:</strong>
                        <span id="currentInventoryStock" style="font-size: 18px; color: #28a745;"></span>
                    </div>
                    <small style="color: #6c757d;">Отметьте номера баллонов, которые фактически находятся на складе</small>
                </div>

                <div id="inventorySerialNumbersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Список номеров баллонов будет добавлен динамически -->
                </div>

                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <strong>Итоговый остаток:</strong>
                        <span id="finalInventoryCount" style="font-size: 18px; font-weight: bold; color: #007bff;">0 шт</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="inventoryReason">Причина изменения остатка:</label>
                        <textarea id="inventoryReason" rows="3" placeholder="Укажите причину изменения остатка (например: повреждение баллонов, потеря, ошибка учета)"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveInventoryBtn" onclick="saveInventory()">💾 Провести инвентаризацию</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentOperationProduct = null;
        let currentPage = 1;
        let currentTransactionsPage = 1;
        const pageSize = 10;
        let searchTimeouts = {};
        
        // Переменные для отгрузки
        let currentShippingOrder = null;
        let shippingItems = [];
        let shipmentFiles = [];

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Проверка авторизации уже выполнена в api.js
            // Здесь просто инициализируем страницу
            
            initializeUserInfo();
            loadWarehouse();
            loadStats();
            loadClientsForOperations();
            initializeDateInputs();
        });

        // Инициализация масок для полей дат
        function initializeDateInputs() {
            // Обработчик для input событий (основной)
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('date-input')) {
                    formatDateInput(e.target);
                }
            });
            
            // Обработчик для keyup событий (дополнительный для надежности)
            document.addEventListener('keyup', function(e) {
                if (e.target.classList.contains('date-input')) {
                    formatDateInput(e.target);
                }
            });
            
            // Обработчик для change событий (для завершения ввода)
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('date-input') && e.target.classList.contains('product-cert-date')) {
                    calculateNextCertification(e.target);
                }
            });
        }

        // Форматирование ввода даты в формат MM/YYYY
        function formatDateInput(input) {
            // Сохраняем позицию курсора
            const cursorPos = input.selectionStart;
            const oldValue = input.value;
            
            // Удаляем все кроме цифр
            let value = input.value.replace(/[^\d]/g, '');
            
            // Ограничиваем длину (2 цифры для месяца + 4 для года)
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            
            // Автоматически добавляем "/" после 2-х цифр
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 6);
            }
            
            // Проверяем месяц (01-12)
            if (value.length >= 2) {
                const month = parseInt(value.substring(0, 2));
                if (month > 12 || month < 1) {
                    return; // Не применяем изменения если месяц некорректен
                }
            }
            
            input.value = value;
            
            // Восстанавливаем позицию курсора
            if (value.length > oldValue.length && cursorPos === 2 && value.charAt(2) === '/') {
                input.setSelectionRange(cursorPos + 1, cursorPos + 1);
            } else {
                input.setSelectionRange(cursorPos, cursorPos);
            }
            
            // Автоматический расчет следующего переосвидетельствования
            if (input.classList.contains('product-cert-date') && value.length === 7) {
                calculateNextCertification(input);
            }
        }

        // Расчет следующей даты переосвидетельствования
        function calculateNextCertification(certInput) {
            try {
                const certValue = certInput.value;
                if (!certValue || certValue.length !== 7) {
                    return;
                }
                
                // Проверяем формат MM/YYYY
                const parts = certValue.split('/');
                if (parts.length !== 2 || parts[0].length !== 2 || parts[1].length !== 4) {
                    return;
                }
                
                // Найти соответствующие поля в той же строке/форме
                let manufactureInput, nextCertInput;
                
                if (certInput.classList.contains('product-cert-date')) {
                    // Ручной ввод - найти в той же строке
                    const row = certInput.closest('.serial-row') || certInput.closest('.form-row') || certInput.closest('div');
                    if (row) {
                        manufactureInput = row.querySelector('.product-manufacture-date');
                        nextCertInput = row.querySelector('.product-next-cert-date');
                    }
                } else if (certInput.id === 'productRangeCertDate') {
                    // Диапазон
                    manufactureInput = document.getElementById('productRangeManufactureDate');
                    nextCertInput = document.getElementById('productRangeNextCertDate');
                } else if (certInput.id === 'productTextCertDate') {
                    // Текстовый блок
                    manufactureInput = document.getElementById('productTextManufactureDate');
                    nextCertInput = document.getElementById('productTextNextCertDate');
                }
                
                if (!nextCertInput) {
                    return;
                }
                
                const [certMonth, certYear] = certValue.split('/');
                const certMonthNum = parseInt(certMonth);
                const certYearNum = parseInt(certYear);
                
                // Проверяем корректность данных
                if (isNaN(certMonthNum) || isNaN(certYearNum) || certMonthNum < 1 || certMonthNum > 12) {
                    return;
                }
                
                let nextYear = certYearNum + 5;
                
                // Проверка ограничения 40 лет от даты производства
                if (manufactureInput && manufactureInput.value && manufactureInput.value.length === 7) {
                    const manufParts = manufactureInput.value.split('/');
                    if (manufParts.length === 2 && manufParts[1].length === 4) {
                        const manufYear = parseInt(manufParts[1]);
                        if (!isNaN(manufYear)) {
                            const maxYear = manufYear + 40;
                            
                            if (nextYear > maxYear) {
                                nextYear = maxYear;
                            }
                        }
                    }
                }
                
                const nextDate = certMonth.padStart(2, '0') + '/' + nextYear;
                nextCertInput.value = nextDate;
                
                
                // Запускаем форматирование для поля следующей даты
                if (nextCertInput.classList.contains('date-input')) {
                    formatDateInput(nextCertInput);
                }
                
            } catch (error) {
            }
        }

        function initializeUserInfo() {
            const user = APIHelpers.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                
                // Установить аватарку - первая буква имени
                const firstLetter = user.name.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Закрывать дропдаун при клике вне его
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function logout() {
            API.logout();
        }

        // Переключение вкладок
        function switchTab(tabName) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Показать выбранную вкладку
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Загрузить данные для вкладки
            switch(tabName) {
                case 'warehouse':
                    loadWarehouse();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'orders':
                    loadWarehouseOrders();
                    break;
            }
        }

        // Функции отображения загрузки и сообщений
        function showTabLoading(tabName, show = true) {
            const overlay = document.getElementById(tabName + 'LoadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        function showTabMessage(tabName, message, isError = false) {
            const errorEl = document.getElementById(tabName + 'ErrorMessage');
            const successEl = document.getElementById(tabName + 'SuccessMessage');
            
            if (errorEl && successEl) {
                if (isError) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                    successEl.style.display = 'none';
                } else {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                    errorEl.style.display = 'none';
                }

                setTimeout(() => {
                    errorEl.style.display = 'none';
                    successEl.style.display = 'none';
                }, 5000);
            }
        }

        function hideTabMessages(tabName) {
            const errorEl = document.getElementById(tabName + 'ErrorMessage');
            const successEl = document.getElementById(tabName + 'SuccessMessage');
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
        }

        // Загрузка статистики склада
        async function loadStats() {
            try {
                const stats = await API.getWarehouseStats();
                
                document.getElementById('totalItems').textContent = stats.totalProducts || 0;
                document.getElementById('totalQuantity').textContent = stats.totalQuantity || 0;
                document.getElementById('totalValue').textContent = APIHelpers.formatCurrency(stats.totalValue || 0).replace(' сум', '');
                document.getElementById('lowStockItems').textContent = stats.lowStockCount || 0;
                
            } catch (error) {
            }
        }

        // Загрузка склада
        async function loadWarehouse(page = 1) {
            try {
                currentPage = page;
                showTabLoading('warehouse', true);
                hideTabMessages('warehouse');

                const searchTerm = document.getElementById('warehouseSearchInput').value.trim();
                const lowStock = document.getElementById('lowStockFilter').checked;
                const supplier = document.getElementById('supplierFilter').value;
                const minPrice = document.getElementById('minPriceFilter').value;
                const maxPrice = document.getElementById('maxPriceFilter').value;
                const sortField = document.getElementById('sortField').value;
                const sortOrder = document.getElementById('sortOrder').value;
                const currentPageSize = parseInt(document.getElementById('pageSize').value);
                
                const params = {
                    page,
                    limit: currentPageSize,
                    sort: sortField,
                    order: sortOrder
                };

                if (searchTerm) params.search = searchTerm;
                if (lowStock) params.lowStock = 'true';
                if (supplier) params.supplier = supplier;
                if (minPrice) params.minPrice = parseFloat(minPrice);
                if (maxPrice) params.maxPrice = parseFloat(maxPrice);
                
                // Price range filter
                if (minPrice || maxPrice) {
                    const priceRange = {};
                    if (minPrice) priceRange.min = parseFloat(minPrice);
                    if (maxPrice) priceRange.max = parseFloat(maxPrice);
                    params.priceRange = JSON.stringify(priceRange);
                }

                const response = await API.getProductsPaginated(
                    params.page, 
                    params.limit, 
                    params.sort, 
                    params.order, 
                    params.search || '', 
                    {
                        lowStock: params.lowStock,
                        supplier: params.supplier,
                        priceRange: params.priceRange
                    }
                );
                
                displayWarehouseItems(response.products, response.suppliers, response.stockStats);
                updateWarehousePagination(response.pagination);
                updatePaginationInfo(response.pagination);
                updateSortIndicators(params.sort, params.order);

            } catch (error) {
                showTabMessage('warehouse', APIHelpers.formatError(error), true);
                APIHelpers.showError(document.getElementById('warehouseTableContainer'), 'Ошибка загрузки склада');
            } finally {
                showTabLoading('warehouse', false);
            }
        }

        // Отображение товаров склада
        function displayWarehouseItems(items, suppliers, stockStats) {
            const container = document.getElementById('warehouseTableContainer');
            
            // Update suppliers dropdown
            updateSuppliersDropdown(suppliers);
            
            if (items.length === 0) {
                const searchTerm = document.getElementById('warehouseSearchInput').value.trim();
                const message = searchTerm ? 'По вашему запросу ничего не найдено' : 'Склад пуст';
                APIHelpers.showEmpty(container, message);
                document.getElementById('warehousePagination').innerHTML = '';
                return;
            }

            // Восстанавливаем таблицу если она была скрыта
            if (!document.getElementById('warehouseTable')) {
                container.innerHTML = `
                    <table class="warehouse-table" id="warehouseTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">
                                    Товар <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="code">
                                    Артикул <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="supplier">
                                    Поставщик <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="currentStock">
                                    Остаток <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="minStock">
                                    Мин. остаток <span class="sort-indicator">↕</span>
                                </th>
                                <th class="sortable" data-sort="purchasePrice">
                                    Цена <span class="sort-indicator">↕</span>
                                </th>
                                <th>Единица</th>
                                <th>Последнее движение</th>
                            </tr>
                        </thead>
                        <tbody id="warehouseTableBody"></tbody>
                    </table>
                `;
                
                // Add click handlers for sortable headers
                container.addEventListener('click', handleTableHeaderClick);
            }

            // Получаем tableBody после возможного пересоздания таблицы
            const tableBody = document.getElementById('warehouseTableBody');
            tableBody.innerHTML = items.map(item => {
                // Handle both nested (item.product) and flat (item) structures
                const product = item.product || item;
                const quantity = item.quantity || product.quantity;
                const totalValue = quantity * product.purchasePrice;
                const isLowStock = product.minQuantity > 0 && quantity <= product.minQuantity;
                const isZeroStock = quantity === 0;
                
                let quantityClass = 'quantity-normal';
                if (isZeroStock) {
                    quantityClass = 'quantity-zero';
                } else if (isLowStock) {
                    quantityClass = 'quantity-low';
                }
                
                const lastUpdated = new Date(item.updatedAt).toLocaleDateString('ru-RU');

                return `
                    <tr style="cursor: pointer;" onclick="openProductCard('${product.id}')" title="Нажмите для просмотра карточки товара">
                        <td>
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small style="color: #6c757d;">${product.description}</small>` : ''}
                            ${product.manufactureDate || product.certificationDate || product.nextCertificationDate ? `
                                <div style="margin-top: 8px; font-size: 11px; color: #6c757d;">
                                    ${product.manufactureDate ? `<div>📅 Изготовление: ${product.manufactureDate}</div>` : ''}
                                    ${product.certificationDate ? `<div>🔧 Переосвидетельствование: ${product.certificationDate}</div>` : ''}
                                    ${product.nextCertificationDate ? `<div>⏰ Следующее освидетельствование: ${product.nextCertificationDate}</div>` : ''}
                                </div>
                            ` : ''}
                        </td>
                        <td>${product.sku || '-'}</td>
                        <td>${product.supplier || '-'}</td>
                        <td>
                            <span class="quantity-badge ${quantityClass}">
                                ${quantity}
                            </span>
                        </td>
                        <td>${product.minQuantity || 0}</td>
                        <td>${APIHelpers.formatCurrency(product.purchasePrice)}</td>
                        <td>${product.unit || 'шт'}</td>
                        <td>${lastUpdated}</td>
                    </tr>
                `;
            }).join('');
        }

        // Обновление пагинации склада
        function updateWarehousePagination(pagination) {
            updatePagination('warehousePagination', pagination, loadWarehouse);
        }

        // Универсальная функция пагинации
        function updatePagination(elementId, pagination, loadFunction) {
            const paginationEl = document.getElementById(elementId);
            
            if (pagination.pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            paginationHTML += `
                <button onclick="${loadFunction.name}(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>
                    ← Предыдущая
                </button>
            `;

            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else if (Math.abs(i - pagination.page) <= 2 || i === 1 || i === pagination.pages) {
                    paginationHTML += `<button onclick="${loadFunction.name}(${i})">${i}</button>`;
                } else if (Math.abs(i - pagination.page) === 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            paginationHTML += `
                <button onclick="${loadFunction.name}(${pagination.page + 1})" ${pagination.page >= pagination.pages ? 'disabled' : ''}>
                    Следующая →
                </button>
            `;

            paginationEl.innerHTML = paginationHTML;
        }

        // Поиск по складу
        function handleWarehouseSearch() {
            clearTimeout(searchTimeouts.warehouse);
            searchTimeouts.warehouse = setTimeout(() => {
                currentPage = 1;
                loadWarehouse(1);
            }, 500);
        }


        // Загрузка операций
        async function loadTransactions(page = 1) {
            try {
                currentTransactionsPage = page;
                showTabLoading('transactions', true);
                hideTabMessages('transactions');

                const typeFilter = document.getElementById('transactionTypeFilter').value;
                const params = {
                    page,
                    limit: pageSize
                };

                if (typeFilter) params.type = typeFilter;

                const response = await API.getTransactions(params);
                displayTransactions(response.transactions);
                updatePagination('transactionsPagination', response.pagination, loadTransactions);

            } catch (error) {
                showTabMessage('transactions', APIHelpers.formatError(error), true);
            } finally {
                showTabLoading('transactions', false);
            }
        }

        // Отображение операций
        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsTableContainer');
            
            if (transactions.length === 0) {
                APIHelpers.showEmpty(container, 'Нет операций');
                return;
            }

            const typeLabels = {
                'INCOMING': 'Поступление',
                'OUTGOING': 'Отгрузка',
                'SHIPMENT': 'Отгрузка',
                'INVENTORY': 'Инвентаризация'
            };

            container.innerHTML = `
                <table class="warehouse-table">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Товар</th>
                            <th>Тип операции</th>
                            <th>Количество</th>
                            <th>Клиент</th>
                            <th>Причина</th>
                            <th>Пользователь</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(transaction => `
                            <tr>
                                <td>${APIHelpers.formatDateTime(transaction.createdAt)}</td>
                                <td>
                                    <strong>${transaction.productName || 'Неизвестный товар'}</strong>
                                </td>
                                <td>
                                    <span class="transaction-item ${transaction.type.toLowerCase()}">
                                        ${typeLabels[transaction.type] || transaction.type}
                                    </span>
                                </td>
                                <td>${transaction.quantity} шт</td>
                                <td>${transaction.orderNumber ? `Заявка ${transaction.orderNumber}` : '-'}</td>
                                <td>
                                    ${transaction.reason || '-'}${transaction.cylinderNumbers && transaction.cylinderNumbers.length > 0 ? ` (${transaction.cylinderNumbers.map(num => typeof num === 'object' ? num.cylinderNumber : num).join(', ')})` : ''}
                                </td>
                                <td>${transaction.createdBy || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Загрузка контрагентов для операций
        async function loadClientsForOperations() {
            try {
                const response = await API.getClients({ limit: 1000 });
                
                // Заполняем список контрагентов для операций
                const clientSelect = document.getElementById('operationClient');
                if (clientSelect) {
                    clientSelect.innerHTML = '<option value="">Выберите контрагента</option>';
                    response.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        clientSelect.appendChild(option);
                    });
                }
                
                // Заполняем список поставщиков в форме создания товара из контрагентов
                const supplierSelect = document.getElementById('productSupplier');
                if (supplierSelect) {
                    const currentValue = supplierSelect.value; // Сохраняем текущее значение
                    supplierSelect.innerHTML = '<option value="">Выберите поставщика</option>';
                    response.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.name; // Используем имя как значение
                        option.textContent = client.name;
                        supplierSelect.appendChild(option);
                    });
                    // Восстанавливаем значение если оно было
                    if (currentValue) {
                        supplierSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error loading contractors:', error);
            }
        }

        // Модальные окна
        function openAddProductModal() {
            try {
                currentEditingProduct = null;
                
                // Проверяем наличие всех необходимых элементов
                const requiredElements = ['productModalTitle', 'saveProductBtn', 'productForm', 'productModalErrorMessage', 'productSerialNumbersContainer', 'productModal'];
                for (const elementId of requiredElements) {
                    if (!document.getElementById(elementId)) {
                        return;
                    }
                }
                
                document.getElementById('productModalTitle').textContent = 'Добавить товар';
                document.getElementById('saveProductBtn').textContent = '💾 Добавить товар';
                document.getElementById('productForm').reset();
                document.getElementById('productModalErrorMessage').style.display = 'none';
                
                // Убираем readOnly с полей для создания нового товара
                document.getElementById('productName').readOnly = false;
                document.getElementById('productUnit').readOnly = false;
                
                // Загружаем список клиентов для поставщиков
                loadClientsForOperations();
                
                // Сброс к ручному вводу
                const manualRadio = document.querySelector('input[name="productInputMethod"][value="manual"]');
                if (manualRadio) {
                    manualRadio.checked = true;
                    switchProductInputMethod();
                } else {
                }
                
                // Добавляем первую строку в ручной ввод
                const container = document.getElementById('productSerialNumbersContainer');
                container.innerHTML = `
                    <div class="serial-row">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="text" placeholder="Номер баллона" class="product-serial-input" style="flex: 2;">
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <small style="color: #666; font-size: 11px; margin-bottom: 2px;">Дата изготовления</small>
                                <input type="text" placeholder="MM / YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace;" maxlength="7" title="Дата изготовления в формате MM/YYYY">
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <small style="color: #666; font-size: 11px; margin-bottom: 2px;">Дата переосвидетельствования</small>
                                <input type="text" placeholder="MM / YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7" title="Дата переосвидетельствования в формате MM/YYYY">
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <small style="color: #666; font-size: 11px; margin-bottom: 2px;">Следующая дата</small>
                                <input type="text" placeholder="MM / YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7" title="Следующая дата переосвидетельствования в формате MM/YYYY">
                            </div>
                            <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px;">🗑️</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('productModal').style.display = 'block';
                
            } catch (error) {
            }
        }

        function closeProductModal() {
            // Сбросить модальное окно к состоянию создания
            document.getElementById('productModalTitle').textContent = 'Добавить товар';
            
            // Показать секцию с номерами баллонов
            const serialNumbersSection = document.querySelector('.section:nth-child(2)');
            if (serialNumbersSection) {
                serialNumbersSection.style.display = 'block';
            }
            
            // Сбросить кнопку сохранения
            const saveBtn = document.getElementById('saveProductBtn');
            saveBtn.textContent = 'Сохранить';
            
            // Сбросить флаг режима редактирования
            window.isEditMode = false;
            window.editProductId = null;
            
            // Убираем readOnly с полей
            document.getElementById('productName').readOnly = false;
            document.getElementById('productUnit').readOnly = false;
            
            // Скрыть модальное окно
            document.getElementById('productModal').style.display = 'none';
            
            // Сбросить форму
            document.getElementById('productForm').reset();
            
            // Скрыть сообщения об ошибках
            document.getElementById('productModalErrorMessage').style.display = 'none';
        }

        // Функции для нового интерфейса добавления товаров
        function switchProductInputMethod() {
            const methodRadio = document.querySelector('input[name="productInputMethod"]:checked');
            if (!methodRadio) {
                return;
            }
            const method = methodRadio.value;
            
            // Скрыть все секции
            const sections = ['productManualInput', 'productRangeInput', 'productTextInput'];
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.style.display = 'none';
                } else {
                }
            });
            
            // Показать выбранную секцию
            const targetSectionId = 'product' + method.charAt(0).toUpperCase() + method.slice(1) + 'Input';
            const targetElement = document.getElementById(targetSectionId);
            if (targetElement) {
                targetElement.style.display = 'block';
            } else {
            }
        }

        function addProductSerialRow() {
            const container = document.getElementById('productSerialNumbersContainer');
            const newRow = document.createElement('div');
            newRow.className = 'serial-row';
            newRow.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 2; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Номер баллона *</small>
                        <input type="text" placeholder="Номер баллона" class="product-serial-input" style="height: 33px;" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Дата изготовления *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Дата изготовления в формате MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Дата переосвидетельствования *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Дата переосвидетельствования в формате MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Следующая дата *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Следующая дата переосвидетельствования в формате MM/YYYY" required>
                    </div>
                    <div style="display: flex; align-items: flex-end; min-height: 50px;">
                        <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px; height: 33px;">🗑️</button>
                    </div>
                </div>
            `;
            container.appendChild(newRow);
        }

        function removeProductSerialRow(button) {
            const container = document.getElementById('productSerialNumbersContainer');
            if (container.children.length > 1) {
                button.closest('.serial-row').remove();
            } else {
                showProductModalMessage('Должна остаться хотя бы одна строка', true);
            }
        }

        function previewProductRange() {
            const prefix = document.getElementById('productRangePrefix').value || '';
            const start = parseInt(document.getElementById('productRangeStart').value) || 1;
            const end = parseInt(document.getElementById('productRangeEnd').value) || start;
            const format = parseInt(document.getElementById('productRangeFormat').value) || 3;
            
            if (end < start) {
                showProductModalMessage('Конечный номер должен быть больше начального', true);
                return;
            }
            
            if (end - start > 1000) {
                showProductModalMessage('Слишком большой диапазон (максимум 1000 номеров)', true);
                return;
            }
            
            const preview = document.getElementById('productRangePreview');
            const list = document.getElementById('productRangePreviewList');
            
            let html = '';
            const count = end - start + 1;
            
            for (let i = start; i <= Math.min(start + 20, end); i++) {
                const number = prefix + i.toString().padStart(format, '0');
                html += `<span style="display: inline-block; margin: 2px 5px; padding: 2px 8px; background: white; border: 1px solid #ddd; border-radius: 4px;">${number}</span>`;
            }
            
            if (count > 20) {
                html += `<div style="margin-top: 10px; color: #666;">...и еще ${count - 20} номеров</div>`;
            }
            
            list.innerHTML = html;
            preview.style.display = 'block';
            
            // Обновляем заголовок
            const header = preview.querySelector('strong');
            header.textContent = `Будет создано номеров: ${count}`;
        }

        function showProductModalMessage(message, isError = false) {
            const errorEl = document.getElementById('productModalErrorMessage');
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            } else {
                errorEl.style.display = 'none';
            }
        }

        // Функции для управления серийными номерами в форме
        function addSerialNumberRow() {
            const container = document.getElementById('serialNumbersList');
            
            const row = document.createElement('div');
            row.className = 'serial-row';
            row.innerHTML = `
                <div class="form-group" style="flex: 2;">
                    <label>Номер баллона *</label>
                    <input type="text" class="serial-number-input" placeholder="Введите номер баллона" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Дата изготовления</label>
                    <input type="date" class="manufacture-date-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Дата освидетельствования</label>
                    <input type="date" class="certification-date-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>След. освидетельствование</label>
                    <input type="date" class="next-certification-date-input">
                </div>
                <div>
                    <button type="button" class="btn-remove" onclick="removeSerialNumberRow(this)">❌</button>
                </div>
            `;
            
            container.appendChild(row);
        }

        function removeSerialNumberRow(button) {
            button.closest('.serial-row').remove();
        }

        function openOperationModal(productId, productName, currentStock, unit) {
            // Сохраняем информацию о товаре
            currentOperationProduct = { id: productId, name: productName, currentStock, unit };
            
            // Показываем кастомное модальное окно выбора типа операции
            document.getElementById('operationTypeProductName').textContent = `Товар: ${productName} (остаток: ${currentStock} ${unit})`;
            document.getElementById('operationTypeModal').style.display = 'block';
        }
        
        function closeOperationTypeModal() {
            document.getElementById('operationTypeModal').style.display = 'none';
            currentOperationProduct = null;
        }
        
        function selectOperationType(type) {
            if (!currentOperationProduct) {
                console.error('currentOperationProduct is null');
                return;
            }
            
            // Сохраняем данные продукта перед закрытием модального окна
            const product = currentOperationProduct;
            
            closeOperationTypeModal();
            
            if (type === 'incoming') {
                // Открываем модальное окно добавления товара для поступления
                openIncomingOperationModal(product.id, product.name, product.unit);
            } else if (type === 'inventory') {
                // Открываем специальное модальное окно инвентаризации
                openInventoryModal(product.id, product.name, product.currentStock, product.unit);
            }
        }
        
        function openIncomingOperationModal(productId, productName, unit) {
            // Используем модальное окно добавления товара для поступления
            currentEditingProduct = { id: productId, isIncoming: true };
            
            // ВАЖНО: Восстанавливаем currentOperationProduct для корректной работы обработчика формы
            currentOperationProduct = { id: productId, name: productName, unit: unit };
            
            // Заполняем форму данными товара
            document.getElementById('productModalTitle').textContent = `Поступление товара: ${productName}`;
            document.getElementById('saveProductBtn').textContent = '💾 Добавить поступление';
            document.getElementById('productForm').reset();
            document.getElementById('productModalErrorMessage').style.display = 'none';
            
            // Заполняем название и единицу измерения
            document.getElementById('productName').value = productName;
            document.getElementById('productUnit').value = unit;
            
            // Делаем поля только для чтения
            document.getElementById('productName').readOnly = true;
            document.getElementById('productUnit').readOnly = true;
            
            // Сброс к ручному вводу баллонов
            const manualRadio = document.querySelector('input[name="productInputMethod"][value="manual"]');
            if (manualRadio) {
                manualRadio.checked = true;
                switchProductInputMethod();
            }
            
            // Добавляем первую строку для ввода баллона
            const container = document.getElementById('productSerialNumbersContainer');
            container.innerHTML = `
                <div class="serial-row">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <input type="text" placeholder="Номер баллона" class="product-serial-input" style="flex: 2;">
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <small style="color: #666; font-size: 11px; margin-bottom: 2px;">Дата изготовления</small>
                            <input type="text" placeholder="MM / YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace;" maxlength="7">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <small style="color: #666; font-size: 11px; margin-bottom: 2px;">Дата переосвидетельствования</small>
                            <input type="text" placeholder="MM / YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <small style="color: #666; font-size: 11px; margin-bottom: 2px;">Следующая дата</small>
                            <input type="text" placeholder="MM / YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7">
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeSerialNumberRow(this)" style="width: 40px; height: 40px;">✖</button>
                    </div>
                </div>
            `;
            
            document.getElementById('productModal').style.display = 'block';
        }

        function closeOperationModal() {
            document.getElementById('operationModal').style.display = 'none';
            currentOperationProduct = null;
            hideModalMessages('operation');
        }

        function openHistoryModal(productId, productName) {
            console.log('Opening history modal for product:', productId, productName);
            document.getElementById('historyModalTitle').textContent = `История: ${productName || 'товара'}`;
            loadTransactionHistory(productId);
            document.getElementById('historyModal').style.display = 'block';
        }
        
        // Делаем функцию доступной глобально
        window.openHistoryModal = openHistoryModal;

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
        window.closeHistoryModal = closeHistoryModal;

        function updateOperationForm() {
            const operationType = document.getElementById('operationType').value;
            const clientField = document.getElementById('clientField');
            
            if (operationType === 'OUTGOING') {
                clientField.style.display = 'block';
            } else {
                clientField.style.display = 'none';
            }
        }

        function hideModalMessages(modalType) {
            const errorEl = document.getElementById(modalType + 'ModalErrorMessage');
            if (errorEl) errorEl.style.display = 'none';
        }

        function showModalMessage(modalType, message, isError = false) {
            const errorEl = document.getElementById(modalType + 'ModalErrorMessage');
            
            if (errorEl && isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else if (errorEl) {
                errorEl.style.display = 'none';
            }
        }

        // Removed duplicate productForm handler - using enhanced version below

        // Выполнение операции
        document.getElementById('operationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentOperationProduct) return;
            
            const operationType = document.getElementById('operationType').value;
            const quantity = parseFloat(document.getElementById('operationQuantity').value);
            const reason = document.getElementById('operationReason').value.trim();
            const clientId = document.getElementById('operationClient').value || undefined;

            if (!operationType || isNaN(quantity) || quantity <= 0) {
                showModalMessage('operation', 'Пожалуйста, заполните все обязательные поля', true);
                return;
            }

            if (operationType === 'OUTGOING' && quantity > currentOperationProduct.currentStock) {
                showModalMessage('operation', `Недостаточно товара на складе! Доступно: ${currentOperationProduct.currentStock} ${currentOperationProduct.unit}`, true);
                return;
            }

            try {
                const executeBtn = document.getElementById('executeOperationBtn');
                executeBtn.innerHTML = '<div class="loading"></div>Выполнение...';
                executeBtn.disabled = true;

                await API.createTransaction({
                    productId: currentOperationProduct.id,
                    type: operationType,
                    quantity: quantity,
                    reason: reason,
                    clientId: clientId
                });

                showTabMessage('warehouse', 'Операция успешно выполнена!');
                closeOperationModal();
                loadWarehouse(currentPage);
                loadStats();
                
                // Обновить вкладку товаров если она активна
                const productsTab = document.getElementById('productsTab');
                if (productsTab && productsTab.classList.contains('active')) {
                    // Обновление товаров при необходимости
                }
                
                // Обновить вкладку операций если она активна
                const transactionsTab = document.getElementById('transactionsTab');
                if (transactionsTab && transactionsTab.classList.contains('active')) {
                    loadTransactions(currentTransactionsPage);
                }

            } catch (error) {
                showModalMessage('operation', APIHelpers.formatError(error), true);
            } finally {
                const executeBtn = document.getElementById('executeOperationBtn');
                executeBtn.textContent = 'Выполнить';
                executeBtn.disabled = false;
            }
        });

        // Обработчик для поступления с баллонами
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Проверяем режим редактирования
            if (window.isEditMode && window.editProductId) {
                await saveEditedProduct(window.editProductId);
                return;
            }

            // Проверяем, это операция поступления для существующего товара или создание нового
            const isIncomingOperation = document.getElementById('productName').readOnly;
            
            if (isIncomingOperation && currentOperationProduct) {
                // Это операция поступления с баллонами для существующего товара
                const serialNumbers = [];
                
                try {
                    document.querySelectorAll('.serial-row').forEach((row, index) => {
                    const serialNumberInput = row.querySelector('.product-serial-input');
                    const manufactureDateInput = row.querySelector('.product-manufacture-date');
                    const certificationDateInput = row.querySelector('.product-cert-date');
                    const nextCertificationDateInput = row.querySelector('.product-next-cert-date');

                    if (!serialNumberInput) return;

                    const serialNumber = serialNumberInput.value.trim();
                    const manufactureDate = manufactureDateInput ? manufactureDateInput.value.trim() : '';
                    const certificationDate = certificationDateInput ? certificationDateInput.value.trim() : '';
                    const nextCertificationDate = nextCertificationDateInput ? nextCertificationDateInput.value.trim() : '';

                    // Валидация всех обязательных полей
                    if (!serialNumber) {
                        throw new Error(`Строка ${index + 1}: Номер баллона обязателен для заполнения`);
                    }
                    
                    if (!manufactureDate) {
                        throw new Error(`Строка ${index + 1}: Дата изготовления обязательна для заполнения`);
                    }
                    
                    if (!certificationDate) {
                        throw new Error(`Строка ${index + 1}: Дата переосвидетельствования обязательна для заполнения`);
                    }
                    
                    if (!nextCertificationDate) {
                        throw new Error(`Строка ${index + 1}: Следующая дата переосвидетельствования обязательна для заполнения`);
                    }

                    // Валидация формата дат (MM/YYYY)
                    const datePattern = /^(0[1-9]|1[0-2])\/\d{4}$/;
                    
                    if (!datePattern.test(manufactureDate)) {
                        throw new Error(`Строка ${index + 1}: Неверный формат даты изготовления "${manufactureDate}". Используйте MM/YYYY`);
                    }
                    
                    if (!datePattern.test(certificationDate)) {
                        throw new Error(`Строка ${index + 1}: Неверный формат даты переосвидетельствования "${certificationDate}". Используйте MM/YYYY`);
                    }
                    
                    if (!datePattern.test(nextCertificationDate)) {
                        throw new Error(`Строка ${index + 1}: Неверный формат следующей даты переосвидетельствования "${nextCertificationDate}". Используйте MM/YYYY`);
                    }

                    serialNumbers.push({
                        serialNumber,
                        manufactureDate,
                        certificationDate,
                        nextCertificationDate
                    });
                    });

                    if (serialNumbers.length === 0) {
                        throw new Error('Добавьте хотя бы один номер баллона');
                    }
                } catch (validationError) {
                    showModalMessage('product', validationError.message, true);
                    return;
                }

                try {
                    const saveBtn = document.getElementById('saveProductBtn');
                    saveBtn.innerHTML = '<div class="loading"></div>Сохранение...';
                    saveBtn.disabled = true;

                    // Создаем номера баллонов для существующего товара
                    await API.createSerialNumbers({
                        productId: currentOperationProduct.id,
                        serialNumbers: serialNumbers
                    });

                    // Создаем транзакцию поступления
                    await API.createTransaction({
                        productId: currentOperationProduct.id,
                        type: 'INCOMING',
                        quantity: serialNumbers.length,
                        reason: 'Поступление баллонов'
                    });

                    showToast(`Поступление выполнено! Добавлено ${serialNumbers.length} номеров баллонов.`);
                showTabMessage('warehouse', `Поступление выполнено! Добавлено ${serialNumbers.length} номеров баллонов.`);
                    closeProductModal();
                    loadWarehouse(currentPage);
                    loadStats();

                } catch (error) {
                    showModalMessage('product', APIHelpers.formatError(error), true);
                } finally {
                    const saveBtn = document.getElementById('saveProductBtn');
                    saveBtn.textContent = 'Добавить товар';
                    saveBtn.disabled = false;
                }
                return;
            }

            // Обычное создание нового товара (существующий код)
            const purchasePrice = parseFloat(document.getElementById('productPurchasePrice').value) || 0;
            const productData = {
                name: document.getElementById('productName').value.trim(),
                unit: document.getElementById('productUnit').value,
                minQuantity: parseInt(document.getElementById('productMinStock').value) || 0,
                supplier: document.getElementById('productSupplier').value.trim() || '',
                category: document.getElementById('productCategory').value.trim() || '',
                // Устанавливаем значения по умолчанию для обязательных полей
                purchasePrice: purchasePrice,
                price: purchasePrice * 1.3, // Цена продажи с наценкой 30%
                quantity: 0, // Будет установлено после подсчета баллонов
                code: undefined,
                location: undefined,
                description: undefined
            };

            const serialNumbers = [];
            
            document.querySelectorAll('.serial-row').forEach(row => {
                const serialNumberInput = row.querySelector('.product-serial-input');
                const manufactureDateInput = row.querySelector('.product-manufacture-date');
                const certificationDateInput = row.querySelector('.product-cert-date');
                const nextCertificationDateInput = row.querySelector('.product-next-cert-date');

                if (!serialNumberInput) return;

                const serialNumber = serialNumberInput.value.trim();
                const manufactureDate = manufactureDateInput ? manufactureDateInput.value : '';
                const certificationDate = certificationDateInput ? certificationDateInput.value : '';
                const nextCertificationDate = nextCertificationDateInput ? nextCertificationDateInput.value : '';

                if (serialNumber) {
                    serialNumbers.push({
                        serialNumber,
                        manufactureDate: manufactureDate || undefined,
                        certificationDate: certificationDate || undefined,
                        nextCertificationDate: nextCertificationDate || undefined
                    });
                }
            });

            // Устанавливаем количество товара равным количеству баллонов
            if (serialNumbers.length > 0) {
                productData.quantity = serialNumbers.length;
            }

            if (!productData.name) {
                showModalMessage('product', 'Пожалуйста, укажите название товара', true);
                return;
            }

            try {
                const saveBtn = document.getElementById('saveProductBtn');
                saveBtn.innerHTML = '<div class="loading"></div>Сохранение...';
                saveBtn.disabled = true;

                const product = await API.createProduct(productData);
                
                // Создаем номера баллонов если они есть
                if (serialNumbers.length > 0) {
                    await API.createSerialNumbers({
                        productId: product.id,
                        serialNumbers: serialNumbers
                    });
                }
                
                // При создании товара quantity уже устанавливается правильно
                // Транзакция нужна только для последующих поступлений
                
                showToast(`Товар успешно добавлен! ${serialNumbers.length > 0 ? `Добавлено ${serialNumbers.length} номеров баллонов.` : ''}`);
                showTabMessage('warehouse', `Товар успешно добавлен! ${serialNumbers.length > 0 ? `Добавлено ${serialNumbers.length} номеров баллонов.` : ''}`);
                closeProductModal();
                loadWarehouse(currentPage);
                loadStats();
                
                // Обновляем историю операций если она открыта
                const transactionsTab = document.getElementById('transactionsTab');
                if (transactionsTab && transactionsTab.classList.contains('active')) {
                    loadTransactions(currentTransactionsPage);
                }

            } catch (error) {
                showModalMessage('product', APIHelpers.formatError(error), true);
            } finally {
                const saveBtn = document.getElementById('saveProductBtn');
                saveBtn.textContent = 'Добавить товар';
                saveBtn.disabled = false;
            }
        });

        // Загрузка истории товара
        async function loadTransactionHistory(productId) {
            console.log('Loading transaction history for productId:', productId);
            try {
                const historyContainer = document.getElementById('transactionHistory');
                if (!historyContainer) {
                    console.error('History container not found');
                    return;
                }
                
                APIHelpers.showLoading(historyContainer, 'Загрузка истории...');

                
                let response;
                try {
                    // Временно делаем прямой запрос минуя API wrapper
                    const directResponse = await fetch(`http://localhost:8081/api/products/${productId}/transactions?limit=50`);
                    response = await directResponse.json();
                    
                    // Также пробуем через API для сравнения
                    const apiResponse = await API.getProductTransactions(productId, { limit: 50 });
                    
                    // Используем прямой ответ если API wrapper возвращает неправильный формат
                    if (apiResponse && apiResponse.status === 'OK' && apiResponse.data) {
                    } else if (apiResponse && apiResponse.transactions) {
                        response = apiResponse;
                    }
                    
                } catch (apiError) {
                    console.error('API call failed:', apiError);
                    throw apiError;
                }
                
                // Проверяем наличие transactions в ответе
                if (!response || !response.transactions) {
                    console.error('Invalid response format:', response);
                    APIHelpers.showEmpty(historyContainer, 'Ошибка формата данных');
                    return;
                }
                
                if (response.transactions.length === 0) {
                    APIHelpers.showEmpty(historyContainer, 'История операций пуста');
                    return;
                }

                const typeLabels = {
                    'INCOMING': '📥 Поступление',
                    'OUTGOING': '📤 Отгрузка',
                    'SHIPMENT': '📦 Отгрузка по заявке',
                    'INVENTORY': '📋 Инвентаризация'
                };

                historyContainer.innerHTML = response.transactions.map(transaction => {
                    const typeClass = transaction.type === 'SHIPMENT' ? 'outgoing' : transaction.type.toLowerCase();
                    const date = APIHelpers.formatDateTime(transaction.createdAt);
                    const quantityChange = transaction.quantity > 0 ? `+${transaction.quantity}` : transaction.quantity;
                    
                    return `
                        <div class="transaction-item ${typeClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>${typeLabels[transaction.type] || transaction.type}</strong>
                                <small>${date}</small>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <div>
                                    <strong style="font-size: 16px; color: ${transaction.quantity > 0 ? '#28a745' : '#dc3545'};">
                                        ${quantityChange} шт
                                    </strong>
                                </div>
                                <div style="text-align: right; color: #6c757d;">
                                    ${transaction.oldQuantity} → ${transaction.newQuantity}
                                </div>
                            </div>
                            
                            ${transaction.cylinderNumbers && transaction.cylinderNumbers.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                    <strong>${transaction.type === 'INVENTORY' ? 'Баллоны на складе:' : 'Номера баллонов:'}</strong>
                                    <div style="margin-top: 5px;">
                                        ${transaction.cylinderNumbers.map(num => `
                                            <span style="display: inline-block; padding: 2px 8px; margin: 2px; background-color: #28a745; color: white; border-radius: 3px;">
                                                ${typeof num === 'object' ? num.cylinderNumber : num}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${transaction.missingCylinderNumbers && transaction.missingCylinderNumbers.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background-color: #fff5f5; border-radius: 5px; border-left: 4px solid #dc3545;">
                                    <strong style="color: #dc3545;">Списанные баллоны:</strong>
                                    <div style="margin-top: 5px;">
                                        ${transaction.missingCylinderNumbers.map(num => `
                                            <span style="display: inline-block; padding: 2px 8px; margin: 2px; background-color: #dc3545; color: white; border-radius: 3px;">
                                                ${typeof num === 'object' ? num.cylinderNumber : num}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${transaction.orderNumber ? `
                                <div style="margin-top: 5px;">
                                    <strong>Заявка:</strong> №${transaction.orderNumber}
                                </div>
                            ` : ''}
                            
                            ${transaction.reason ? `
                                <div style="margin-top: 5px;">
                                    <strong>Основание:</strong> ${transaction.reason}
                                </div>
                            ` : ''}
                            
                            ${transaction.clientId ? `
                                <div style="margin-top: 5px;">
                                    <strong>Контрагент:</strong> ${transaction.clientName || 'ID: ' + transaction.clientId}
                                </div>
                            ` : ''}
                            
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; color: #6c757d; font-size: 12px;">
                                <strong>Выполнил:</strong> ${transaction.createdBy || 'Система'}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading transaction history:', error);
                const historyContainer = document.getElementById('transactionHistory');
                if (historyContainer) {
                    historyContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p>❌ Ошибка загрузки истории</p>
                            <small>${error.message || 'Неизвестная ошибка'}</small>
                        </div>
                    `;
                }
            }
        }

        // Редактирование товара
        async function editProduct(productId) {
            try {
                // Получить данные товара
                const product = await API.getProduct(productId);
                
                // Показать модальное окно редактирования (теперь асинхронное)
                await showEditProductModal(product);
                
            } catch (error) {
                console.error('Error loading product for edit:', error);
                showTabMessage('warehouse', 'Ошибка при загрузке данных товара: ' + (error.message || error), false);
            }
        }

        // Показать модальное окно редактирования товара
        async function showEditProductModal(product) {
            // Установить флаги режима редактирования
            window.isEditMode = true;
            window.editProductId = product.id;
            
            // Изменить заголовок модального окна
            document.getElementById('productModalTitle').textContent = 'Редактировать товар';
            
            // Показать секцию с номерами баллонов для редактирования
            const serialNumbersSection = document.querySelector('.section:nth-child(2)');
            if (serialNumbersSection) {
                serialNumbersSection.style.display = 'block';
            }
            
            // Загрузить существующие номера баллонов
            await loadExistingSerialNumbers(product.id);
            
            // Заполнить форму данными товара
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productUnit').value = product.unit || 'шт';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productMinStock').value = product.minQuantity || 0;
            document.getElementById('productPurchasePrice').value = product.purchasePrice || 0;
            document.getElementById('productCategory').value = product.category || '';
            
            // Если есть поле для цены продажи
            const priceField = document.getElementById('productPrice');
            if (priceField) {
                priceField.value = product.price || 0;
            }
            
            // Если есть поле для описания
            const descriptionField = document.getElementById('productDescription');
            if (descriptionField) {
                descriptionField.value = product.description || '';
            }
            
            // Если есть поле для локации
            const locationField = document.getElementById('productLocation');
            if (locationField) {
                locationField.value = product.location || '';
            }
            
            // Изменить кнопку сохранения
            const saveBtn = document.getElementById('saveProductBtn');
            saveBtn.textContent = 'Обновить товар';
            
            // Очистить сообщения об ошибках
            document.getElementById('productModalErrorMessage').style.display = 'none';
            
            // Показать модальное окно
            document.getElementById('productModal').style.display = 'block';
        }

        // Загрузить существующие номера баллонов для редактирования
        async function loadExistingSerialNumbers(productId) {
            try {
                console.log('Loading existing serial numbers for product:', productId);
                
                // Получить существующие номера баллонов
                const response = await API.getSerialNumbers(productId);
                const existingSerialNumbers = response.serialNumbers || [];
                
                console.log('Existing serial numbers:', existingSerialNumbers);
                
                // Очистить текущий контейнер
                const container = document.getElementById('productSerialNumbersContainer');
                container.innerHTML = '';
                
                // Установить ручной ввод по умолчанию для редактирования
                document.querySelector('input[name="productInputMethod"][value="manual"]').checked = true;
                switchProductInputMethod();
                
                if (existingSerialNumbers.length === 0) {
                    // Если нет номеров баллонов, добавить одну пустую строку
                    addProductSerialRow();
                } else {
                    // Заполнить форму существующими данными
                    existingSerialNumbers.forEach((serial, index) => {
                        const row = createProductSerialRow();
                        
                        // Заполнить данными
                        const inputs = row.querySelectorAll('input');
                        if (inputs[0]) inputs[0].value = serial.serialNumber || '';
                        if (inputs[1]) inputs[1].value = serial.manufactureDate || '';
                        if (inputs[2]) inputs[2].value = serial.certificationDate || '';
                        if (inputs[3]) inputs[3].value = serial.nextCertificationDate || '';
                        
                        // Добавить data-attribute для отслеживания существующих записей
                        row.setAttribute('data-serial-id', serial.id);
                        row.setAttribute('data-existing', 'true');
                        
                        container.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error('Error loading existing serial numbers:', error);
                // В случае ошибки, добавить одну пустую строку
                addProductSerialRow();
            }
        }

        // Создать строку для номера баллона (используется при загрузке существующих данных)
        function createProductSerialRow() {
            const row = document.createElement('div');
            row.className = 'serial-row';
            row.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 2; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Номер баллона *</small>
                        <input type="text" placeholder="Номер баллона" class="product-serial-input" style="height: 33px;" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Дата изготовления *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Дата изготовления в формате MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Дата переосвидетельствования *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Дата переосвидетельствования в формате MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">Следующая дата *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="Следующая дата переосвидетельствования в формате MM/YYYY" required>
                    </div>
                    <div style="display: flex; align-items: flex-end; min-height: 50px;">
                        <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px; height: 33px;">🗑️</button>
                    </div>
                </div>
            `;
            return row;
        }

        // Сохранить отредактированный товар
        async function saveEditedProduct(productId) {
            try {
                // Проверить, что мы действительно в режиме редактирования
                if (!window.isEditMode || !window.editProductId) {
                    console.error('saveEditedProduct called but not in edit mode');
                    return;
                }
                
                showTabLoading('warehouse', true);
                
                const formData = {
                    name: document.getElementById('productName').value,
                    unit: document.getElementById('productUnit').value,
                    supplier: document.getElementById('productSupplier').value,
                    minQuantity: parseInt(document.getElementById('productMinStock').value) || 0,
                    purchasePrice: parseFloat(document.getElementById('productPurchasePrice').value) || 0,
                    category: document.getElementById('productCategory').value
                };
                
                // Добавить дополнительные поля если они есть
                const priceField = document.getElementById('productPrice');
                if (priceField) {
                    formData.price = parseFloat(priceField.value) || 0;
                }
                
                const descriptionField = document.getElementById('productDescription');
                if (descriptionField) {
                    formData.description = descriptionField.value;
                }
                
                const locationField = document.getElementById('productLocation');
                if (locationField) {
                    formData.location = locationField.value;
                }
                
                // Валидация
                if (!formData.name || formData.name.trim().length === 0) {
                    const errorEl = document.getElementById('productModalErrorMessage');
                    errorEl.textContent = 'Название товара обязательно для заполнения';
                    errorEl.style.display = 'block';
                    showTabLoading('warehouse', false);
                    return;
                }
                
                // Сбросить флаги сразу, чтобы избежать повторных вызовов
                window.isEditMode = false;
                window.editProductId = null;
                
                // Обновить товар
                await API.updateProduct(productId, formData);
                
                // Обработать изменения в номерах баллонов
                await processSerialNumberChanges(productId);
                
                // Закрыть модальное окно
                closeProductModal();
                
                // Перезагрузить данные склада
                await loadWarehouse(currentPage);
                await loadStats();
                
                showTabMessage('warehouse', 'Товар успешно обновлен!');
                
            } catch (error) {
                console.error('Error updating product:', error);
                const errorEl = document.getElementById('productModalErrorMessage');
                errorEl.textContent = 'Ошибка при обновлении товара: ' + (error.message || error);
                errorEl.style.display = 'block';
                showTabLoading('warehouse', false);
                
                // Восстановить флаги в случае ошибки
                window.isEditMode = true;
                window.editProductId = productId;
            }
        }

        // Обработать изменения в номерах баллонов при редактировании
        async function processSerialNumberChanges(productId) {
            try {
                console.log('Processing serial number changes for product:', productId);
                
                // Получить текущие данные из формы
                const serialRows = document.querySelectorAll('.serial-row');
                const currentSerialNumbers = [];
                
                serialRows.forEach((row, index) => {
                    const inputs = row.querySelectorAll('input');
                    const serialNumber = inputs[0]?.value?.trim();
                    const manufactureDate = inputs[1]?.value?.trim();
                    const certificationDate = inputs[2]?.value?.trim();
                    const nextCertificationDate = inputs[3]?.value?.trim();
                    
                    if (serialNumber) {
                        currentSerialNumbers.push({
                            id: row.getAttribute('data-serial-id'), // null для новых записей
                            serialNumber,
                            manufactureDate,
                            certificationDate,
                            nextCertificationDate,
                            isExisting: row.getAttribute('data-existing') === 'true'
                        });
                    }
                });
                
                console.log('Current serial numbers from form:', currentSerialNumbers);
                
                // Получить существующие номера баллонов с сервера
                const response = await API.getSerialNumbers(productId);
                const existingSerialNumbers = response.serialNumbers || [];
                
                console.log('Existing serial numbers from server:', existingSerialNumbers);
                
                // Определить изменения
                const toUpdate = [];
                const toCreate = [];
                const toDelete = [];
                
                // Найти записи для обновления и создания
                currentSerialNumbers.forEach(current => {
                    if (current.id && current.isExisting) {
                        // Существующая запись - проверить изменения
                        const existing = existingSerialNumbers.find(e => e.id === current.id);
                        if (existing) {
                            if (existing.serialNumber !== current.serialNumber ||
                                existing.manufactureDate !== current.manufactureDate ||
                                existing.certificationDate !== current.certificationDate ||
                                existing.nextCertificationDate !== current.nextCertificationDate) {
                                toUpdate.push({
                                    id: current.id,
                                    ...current
                                });
                            }
                        }
                    } else {
                        // Новая запись
                        toCreate.push({
                            productId: productId,
                            ...current
                        });
                    }
                });
                
                // Найти записи для удаления
                existingSerialNumbers.forEach(existing => {
                    const stillExists = currentSerialNumbers.find(c => c.id === existing.id);
                    if (!stillExists) {
                        toDelete.push(existing.id);
                    }
                });
                
                console.log('Changes to process:', { toUpdate, toCreate, toDelete });
                
                // Применить изменения
                const promises = [];
                
                // Обновить существующие записи
                toUpdate.forEach(serial => {
                    promises.push(API.updateSerialNumber(serial.id, {
                        serialNumber: serial.serialNumber,
                        manufactureDate: serial.manufactureDate,
                        certificationDate: serial.certificationDate,
                        nextCertificationDate: serial.nextCertificationDate
                    }));
                });
                
                // Создать новые записи
                if (toCreate.length > 0) {
                    promises.push(API.createSerialNumbers({
                        productId: productId,
                        serialNumbers: toCreate
                    }));
                }
                
                // Удалить записи
                toDelete.forEach(serialId => {
                    promises.push(API.deleteSerialNumber(serialId));
                });
                
                // Выполнить все операции
                if (promises.length > 0) {
                    await Promise.all(promises);
                    console.log('Serial number changes applied successfully');
                }
                
            } catch (error) {
                console.error('Error processing serial number changes:', error);
                // Не показываем ошибку пользователю, если основное обновление товара прошло успешно
                // Только логируем в консоль
            }
        }

        // Удаление товара
        async function deleteProduct(productId, productName) {
            if (!confirm(`Вы уверены, что хотите удалить товар "${productName}"?`)) {
                return;
            }

            try {
                showTabLoading('warehouse', true);
                await API.deleteProduct(productId);
                showTabMessage('warehouse', 'Товар успешно удален!');
                loadWarehouse(currentPage);
                loadStats();
                
            } catch (error) {
                showTabMessage('warehouse', APIHelpers.formatError(error), true);
            } finally {
                showTabLoading('warehouse', false);
            }
        }

        // Камера для фотографий отгрузки
        let cameraStream = null;
        let currentTransactionId = null;
        let capturedPhotos = [];

        async function openCameraForShipment(transactionId) {
            currentTransactionId = transactionId;
            capturedPhotos = [];
            
            try {
                // Запрашиваем доступ к камере
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // Задняя камера по умолчанию
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                
                document.getElementById('cameraModal').style.display = 'block';
                document.getElementById('photosPreview').innerHTML = '';
                document.querySelector('.camera-btn-save').style.display = 'none';
                
            } catch (error) {
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            // Устанавливаем размер canvas по размеру видео
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Рисуем текущий кадр видео на canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Конвертируем в blob и добавляем к захваченным фото
            canvas.toBlob(blob => {
                const photoUrl = URL.createObjectURL(blob);
                capturedPhotos.push({
                    blob: blob,
                    url: photoUrl,
                    timestamp: new Date().toISOString()
                });
                
                updatePhotosPreview();
            }, 'image/jpeg', 0.8);
        }

        function updatePhotosPreview() {
            const preview = document.getElementById('photosPreview');
            
            preview.innerHTML = capturedPhotos.map((photo, index) => `
                <div class="photo-preview">
                    <img src="${photo.url}" alt="Фото ${index + 1}">
                    <button class="photo-remove" onclick="removePhoto(${index})">×</button>
                </div>
            `).join('');
            
            // Показываем кнопку сохранения если есть фото
            const saveBtn = document.querySelector('.camera-btn-save');
            saveBtn.style.display = capturedPhotos.length > 0 ? 'block' : 'none';
        }

        function removePhoto(index) {
            // Освобождаем URL объект
            URL.revokeObjectURL(capturedPhotos[index].url);
            capturedPhotos.splice(index, 1);
            updatePhotosPreview();
        }

        async function savePhotos() {
            if (capturedPhotos.length === 0) {
                return;
            }

            try {
                const saveBtn = document.querySelector('.camera-btn-save');
                saveBtn.innerHTML = '💾 Сохранение...';
                saveBtn.disabled = true;

                // Создаем FormData для отправки фотографий
                const formData = new FormData();
                
                capturedPhotos.forEach((photo, index) => {
                    formData.append('photos', photo.blob, `shipment_photo_${index + 1}.jpg`);
                });

                // Отправляем фотографии на сервер
                const response = await fetch(`${API.baseURL}/files/transaction/${currentTransactionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API.getToken()}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                
                closeCameraModal();
                loadOperations(currentOperationsPage); // Обновляем список операций
                
            } catch (error) {
            } finally {
                const saveBtn = document.querySelector('.camera-btn-save');
                saveBtn.innerHTML = '💾 Сохранить фото';
                saveBtn.disabled = false;
            }
        }

        function closeCameraModal() {
            // Останавливаем поток камеры
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Освобождаем URL объекты
            capturedPhotos.forEach(photo => {
                URL.revokeObjectURL(photo.url);
            });
            
            capturedPhotos = [];
            currentTransactionId = null;
            document.getElementById('cameraModal').style.display = 'none';
            document.getElementById('photosPreview').innerHTML = '';
        }



        // Закрытие модальных окон
        window.onclick = function(event) {
            const modals = ['productModal', 'operationModal', 'historyModal', 'cameraModal', 'shipmentModal', 'operationTypeModal', 'inventoryModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'cameraModal') {
                        closeCameraModal();
                    } else {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // Загрузка заявок на отгрузку для склада
        async function loadWarehouseOrders() {
            showTabLoading('orders', true);
            showTabMessage('orders', '');

            try {
                const response = await API.getWarehousePendingOrders();
                const container = document.getElementById('ordersTableContainer');
                
                if (response.orders.length === 0) {
                    container.innerHTML = '<div class="empty-state">📋 Нет заявок для отгрузки</div>';
                    return;
                }

                container.innerHTML = `
                    <table class="warehouse-table">
                        <thead>
                            <tr>
                                <th>№ Заявки</th>
                                <th>Клиент</th>
                                <th>Статус</th>
                                <th>Товары</th>
                                <th>Сумма</th>
                                <th>Дата заявки</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${response.orders.map(order => {
                                let statusText, statusClass;
                                if (order.status === 'PAID') {
                                    statusText = 'Оплачена';
                                    statusClass = 'paid';
                                } else if (order.status === 'FOR_SHIPMENT_UNPAID') {
                                    statusText = 'В отгрузку без оплаты';
                                    statusClass = 'for-shipment-unpaid';
                                } else if (order.status === 'PICKING') {
                                    statusText = 'Комплектация';
                                    statusClass = 'picking';
                                } else if (order.status === 'SHIPPED') {
                                    statusText = 'Отгружена';
                                    statusClass = 'shipped';
                                }
                                
                                const isShipped = order.status === 'SHIPPED';
                                const rowClick = isShipped ? `onclick="viewOrderFromWarehouse('${order.id}')" style="cursor: pointer;"` : '';
                                
                                return `
                                    <tr ${rowClick}>
                                        <td><strong>${order.number}</strong></td>
                                        <td>${order.client.name}</td>
                                        <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                                        <td>
                                            ${order.items.map(item => 
                                                `${item.product.name} - ${item.quantity} ${item.product.unit}`
                                            ).join('<br>')}
                                        </td>
                                        <td>${APIHelpers.formatCurrency(order.totalAmount)}</td>
                                        <td>${APIHelpers.formatDate(order.orderDate || order.createdAt)}</td>
                                        <td ${isShipped ? 'onclick="event.stopPropagation()"' : ''}>
                                            <div class="actions">
                                                ${!isShipped ? `<button class="btn btn-success" onclick="shipOrder('${order.id}', '${order.number}')" title="Отгрузить">📦 Отгрузить</button>` : '<span style="color: #28a745;">✓ Отгружена</span>'}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                showTabMessage('orders', APIHelpers.formatError(error), true);
            } finally {
                showTabLoading('orders', false);
            }
        }

        // Отгрузка заявки
        async function shipOrder(orderId, orderNumber) {
            try {
                // Загружаем детали заявки
                const order = await API.getOrder(orderId);
                
                currentShippingOrder = order;
                shippingItems = [];
                
                // Подготавливаем данные для каждого товара в заявке
                for (const item of order.items) {
                    const serialNumbers = [];
                    // Используем правильный ID товара из объекта product или напрямую из item
                    const productId = item.product ? item.product.id : (item.id || item.productId);
                    const productName = item.product ? item.product.name : (item.name || 'Товар');
                    
                    // Если нет объекта product, загружаем информацию о товаре
                    if (!item.product && productId) {
                        try {
                            const productInfo = await API.getProduct(productId);
                            item.product = productInfo;
                        } catch (error) {
                            console.warn('Не удалось загрузить информацию о товаре:', productId);
                            // Создаем минимальный объект product
                            item.product = {
                                id: productId,
                                name: productName,
                                unit: 'шт'
                            };
                        }
                    }
                    
                    // Создаем пустые поля для серийных номеров (по количеству товара)
                    for (let i = 0; i < item.quantity; i++) {
                        serialNumbers.push({
                            serialNumber: '',
                            productId: productId,
                            productName: productName
                        });
                    }
                    
                    shippingItems.push({
                        ...item,
                        productId: productId,
                        serialNumbers: serialNumbers
                    });
                }
                
                displayShipmentForm();
                document.getElementById('shipmentModal').style.display = 'block';
                
            } catch (error) {
                showTabMessage('orders', APIHelpers.formatError(error), true);
            }
        }
        
        // Делаем функцию глобально доступной
        window.shipOrder = shipOrder;

        // Функция openShipmentModal убрана - логика перенесена в shipOrder

        // Отображение формы отгрузки
        function displayShipmentForm() {
            const content = document.getElementById('shipmentFormContent');
            
            content.innerHTML = `
                <div class="shipment-order-info">
                    <h3>Заявка ${currentShippingOrder.number}</h3>
                    <p><strong>Клиент:</strong> ${currentShippingOrder.client.name}</p>
                    <p><strong>Дата заявки:</strong> ${APIHelpers.formatDate(currentShippingOrder.orderDate || currentShippingOrder.createdAt)}</p>
                </div>
                
                <div class="shipment-items">
                    <h4>Товары к отгрузке:</h4>
                    ${shippingItems.map((item, itemIndex) => `
                        <div class="shipment-item">
                            <div class="shipment-item-header">
                                <strong>${item.product ? item.product.name : (item.name || 'Неизвестный товар')}</strong>
                                <span class="quantity-info">Количество: ${item.quantity} ${item.product ? item.product.unit : 'шт'}</span>
                            </div>
                            
                            <div class="serial-numbers-section">
                                <h5>Номера баллонов:</h5>
                                ${item.serialNumbers.map((serial, serialIndex) => `
                                    <div class="serial-input-row">
                                        <label>Баллон ${serialIndex + 1}:</label>
                                        <input 
                                            type="text" 
                                            placeholder="Введите номер баллона"
                                            value="${serial.serialNumber}"
                                            onchange="updateSerialNumber(${itemIndex}, ${serialIndex}, this.value)"
                                            required
                                        >
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="shipment-files-section">
                    <h4>Документы и фотографии:</h4>
                    <div class="file-upload-area">
                        <input type="file" id="shipmentFileInput" multiple accept="image/*,application/pdf" style="display: none;" onchange="handleShipmentFiles(this)">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('shipmentFileInput').click()">
                            📎 Прикрепить файлы
                        </button>
                        <p class="file-info">Можно прикреплять фотографии и PDF документы</p>
                    </div>
                    <div id="shipmentFilesList" class="files-preview">
                        <!-- Список файлов будет здесь -->
                    </div>
                </div>
            `;
        }

        // Обновление серийного номера
        async function updateSerialNumber(itemIndex, serialIndex, value) {
            const trimmedValue = value.trim();
            
            if (!trimmedValue) {
                shippingItems[itemIndex].serialNumbers[serialIndex].serialNumber = '';
                return;
            }
            
            // Проверка уникальности номера баллона
            const currentProductId = shippingItems[itemIndex].productId;
            const validationResult = await validateCylinderNumber(trimmedValue, currentProductId);
            
            if (!validationResult.isValid) {
                // Показать ошибку и очистить поле
                alert(`Ошибка: ${validationResult.message}`);
                // Найти соответствующий input и очистить его
                const inputs = document.querySelectorAll(`input[onchange*="updateSerialNumber(${itemIndex}, ${serialIndex}"]`);
                if (inputs.length > 0) {
                    inputs[0].value = '';
                }
                shippingItems[itemIndex].serialNumbers[serialIndex].serialNumber = '';
                return;
            }
            
            shippingItems[itemIndex].serialNumbers[serialIndex].serialNumber = trimmedValue;
        }
        
        // Функция валидации номера баллона
        async function validateCylinderNumber(cylinderNumber, currentProductId) {
            try {
                console.log('Validating cylinder:', cylinderNumber, 'for product:', currentProductId);
                
                // Базовая валидация формата номера баллона
                if (cylinderNumber.length < 3) {
                    return {
                        isValid: false,
                        message: 'Номер баллона должен содержать не менее 3 символов'
                    };
                }
                
                // Проверяем актуальные серийные номера товара
                const serialResponse = await API.getSerialNumbers(currentProductId);
                const serialNumbers = serialResponse.serialNumbers || [];
                
                console.log('Serial numbers found:', serialNumbers.length);
                
                // Ищем активные серийные номера (доступные для отгрузки)
                const availableSerials = serialNumbers.filter(serial => serial.status === 'active');
                console.log('Available active serials:', availableSerials.map(s => s.serialNumber));
                
                // Проверяем, есть ли данный номер среди активных
                const foundSerial = availableSerials.find(serial => serial.serialNumber === cylinderNumber);
                
                if (!foundSerial) {
                    // Проверяем, существует ли номер вообще но с другим статусом
                    const existingSerial = serialNumbers.find(serial => serial.serialNumber === cylinderNumber);
                    
                    if (existingSerial) {
                        if (existingSerial.status === 'shipped') {
                            return {
                                isValid: false,
                                message: `Номер баллона ${cylinderNumber} уже был отгружен`
                            };
                        } else if (existingSerial.status === 'lost') {
                            return {
                                isValid: false,
                                message: `Номер баллона ${cylinderNumber} списан`
                            };
                        } else {
                            return {
                                isValid: false,
                                message: `Номер баллона ${cylinderNumber} недоступен (статус: ${existingSerial.status})`
                            };
                        }
                    } else {
                        return {
                            isValid: false,
                            message: `Номер баллона ${cylinderNumber} не найден в остатках товара`
                        };
                    }
                }
                
                console.log('Cylinder validation passed for:', cylinderNumber);
                return {
                    isValid: true,
                    message: 'Номер баллона доступен'
                };
                
            } catch (error) {
                console.error('Error validating cylinder number:', error);
                return {
                    isValid: false,
                    message: 'Ошибка при проверке номера баллона. Попробуйте еще раз.'
                };
            }
        }

        // Обработка прикрепленных файлов
        function handleShipmentFiles(input) {
            const files = Array.from(input.files);
            shipmentFiles = files;
            
            const filesList = document.getElementById('shipmentFilesList');
            
            if (files.length === 0) {
                filesList.innerHTML = '<p class="no-files-text">Файлы не выбраны</p>';
                return;
            }
            
            filesList.innerHTML = files.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                const fileUrl = URL.createObjectURL(file);
                
                return `
                    <div class="file-preview-item">
                        <div class="file-preview-content">
                            ${isImage ? `
                                <div class="image-preview">
                                    <img src="${fileUrl}" alt="${file.name}" onclick="openImagePreview('${fileUrl}', '${file.name}')">
                                </div>
                            ` : `
                                <div class="file-icon">
                                    📄
                                </div>
                            `}
                            <div class="file-details">
                                <div class="file-name" title="${file.name}">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                                <div class="file-type">${file.type || 'Неизвестный тип'}</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeShipmentFile(${index})" title="Удалить файл">
                            🗑️
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Открытие предварительного просмотра изображения
        function openImagePreview(imageUrl, fileName) {
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            modal.innerHTML = `
                <div class="image-preview-content">
                    <div class="image-preview-header">
                        <h3>${fileName}</h3>
                        <button class="close-preview" onclick="closeImagePreview()">&times;</button>
                    </div>
                    <div class="image-preview-body">
                        <img src="${imageUrl}" alt="${fileName}">
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // Закрытие по клику вне изображения
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeImagePreview();
                }
            };
        }

        // Закрытие предварительного просмотра изображения
        function closeImagePreview() {
            const modal = document.querySelector('.image-preview-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Удаление файла из списка
        function removeShipmentFile(index) {
            shipmentFiles.splice(index, 1);
            
            // Обновляем input файлов
            const input = document.getElementById('shipmentFileInput');
            const dt = new DataTransfer();
            shipmentFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            handleShipmentFiles(input);
        }

        // Выполнение отгрузки
        async function executeShipment() {
            try {
                // Валидация номеров баллонов
                for (const item of shippingItems) {
                    for (const serial of item.serialNumbers) {
                        if (!serial.serialNumber) {
                            alert('Все поля номеров баллонов должны быть заполнены');
                            return;
                        }
                        
                        // Проверить каждый номер баллона
                        const validationResult = await validateCylinderNumber(serial.serialNumber, item.productId);
                        if (!validationResult.isValid) {
                            console.error(`Validation failed for cylinder ${serial.serialNumber}, product ID: ${item.productId}`);
                            alert(`Ошибка: ${validationResult.message}\n\nПродукт ID: ${item.productId}\nНомер баллона: ${serial.serialNumber}`);
                            return;
                        }
                    }
                }

                showTabMessage('orders', 'Выполняется отгрузка...', false);
                
                // Загружаем файлы если есть
                let uploadedFiles = [];
                if (shipmentFiles.length > 0) {
                    const fileResponse = await API.uploadFiles(shipmentFiles, currentShippingOrder.id, 'ORDER');
                    uploadedFiles = fileResponse.files;
                }

                // Создаем отгрузку с серийными номерами
                const shipmentData = {
                    items: shippingItems.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity,
                        serialNumbers: item.serialNumbers.map(sn => sn.serialNumber)
                    })),
                    fileIds: uploadedFiles.map(f => f.id),
                    notes: null
                };

                // Сохраняем номер заявки перед закрытием
                const orderNumber = currentShippingOrder.number;
                
                // Создаем отгрузку (автоматически обновляет статус заявки)
                await API.createShipment(currentShippingOrder.id, shipmentData);
                
                // Закрываем модальное окно
                closeShipmentModal();
                
                showTabMessage('orders', `Заявка ${orderNumber} успешно отгружена!`);
                loadWarehouseOrders();
                
                const warehouseTab = document.getElementById('warehouseTab');
                if (warehouseTab && warehouseTab.classList.contains('active')) {
                    loadWarehouse();
                }
                
                // Обновить вкладку товаров если она активна
                const productsTab = document.getElementById('productsTab');
                if (productsTab && productsTab.classList.contains('active')) {
                    // Обновление товаров при необходимости
                }
                
                // Обновить статистику и операции
                loadStats();
                const transactionsTab = document.getElementById('transactionsTab');
                if (transactionsTab && transactionsTab.classList.contains('active')) {
                    loadTransactions(currentTransactionsPage);
                }

            } catch (error) {
                showTabMessage('orders', APIHelpers.formatError(error), true);
            }
        }

        // Закрытие модального окна отгрузки
        function closeShipmentModal() {
            document.getElementById('shipmentModal').style.display = 'none';
            currentShippingOrder = null;
            shippingItems = [];
            shipmentFiles = [];
        }

        // Просмотр заявки из интерфейса склада
        function viewOrderFromWarehouse(orderId) {
            // Открываем заявку в новой вкладке orders.html
            window.open(`orders.html?view=${orderId}`, '_blank');
        }

        // Enhanced pagination helper functions
        function updateSuppliersDropdown(suppliers) {
            const supplierFilter = document.getElementById('supplierFilter');
            const currentValue = supplierFilter.value;
            
            // Clear existing options except the first one
            supplierFilter.innerHTML = '<option value="">Все поставщики</option>';
            
            if (suppliers && suppliers.length > 0) {
                suppliers.forEach(supplier => {
                    if (supplier) {
                        const option = document.createElement('option');
                        option.value = supplier;
                        option.textContent = supplier;
                        if (supplier === currentValue) {
                            option.selected = true;
                        }
                        supplierFilter.appendChild(option);
                    }
                });
            }
        }

        function updatePaginationInfo(pagination) {
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo && pagination) {
                const start = (pagination.page - 1) * pagination.limit + 1;
                const end = Math.min(pagination.page * pagination.limit, pagination.total);
                paginationInfo.textContent = `Показано ${start}-${end} из ${pagination.total}`;
            }
        }

        function updateSortIndicators(sortField, sortOrder) {
            // Reset all sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
                indicator.textContent = '↕';
            });

            // Update the active sort indicator
            const activeTh = document.querySelector(`th[data-sort="${sortField}"] .sort-indicator`);
            if (activeTh) {
                activeTh.className = `sort-indicator ${sortOrder.toLowerCase()}`;
                activeTh.textContent = sortOrder === 'ASC' ? '↑' : '↓';
            }
        }

        function handleTableHeaderClick(event) {
            const th = event.target.closest('th.sortable');
            if (th) {
                const sortField = th.dataset.sort;
                const currentSortField = document.getElementById('sortField').value;
                const currentSortOrder = document.getElementById('sortOrder').value;
                
                let newSortOrder = 'ASC';
                if (sortField === currentSortField && currentSortOrder === 'ASC') {
                    newSortOrder = 'DESC';
                }
                
                document.getElementById('sortField').value = sortField;
                document.getElementById('sortOrder').value = newSortOrder;
                
                loadWarehouse(1); // Reset to first page when sorting
            }
        }

        function handleWarehouseSorting() {
            loadWarehouse(1); // Reset to first page when changing sort
        }

        function handlePageSizeChange() {
            loadWarehouse(1); // Reset to first page when changing page size
        }

        // Открытие карточки товара
        async function openProductCard(productId) {
            try {
                const product = await API.getProduct(productId);
                const user = APIHelpers.getCurrentUser();
                const isAdmin = user && user.role === 'admin';
                
                // Загрузить номера баллонов
                let serialNumbers = [];
                try {
                    const serialResponse = await API.getSerialNumbers(productId);
                    // Фильтруем только активные баллоны для отображения в карточке
                    serialNumbers = (serialResponse.serialNumbers || []).filter(serial => serial.status === 'active');
                } catch (serialError) {
                    console.warn('Could not load serial numbers for product:', serialError);
                }
                
                // Создаем модальное окно карточки товара
                const cardModal = document.createElement('div');
                cardModal.className = 'modal';
                cardModal.style.display = 'block';
                cardModal.id = 'productCardModal';
                
                cardModal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 style="font-size: 18px;">Карточка товара: ${product.name}</h2>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-primary" onclick="openOperationModal('${product.id}', '${product.name}', ${product.quantity || 0}, '${product.unit || 'шт'}')">Операции</button>
                                <button class="btn btn-edit" onclick="editProduct('${product.id}')">Редактировать</button>
                                ${isAdmin ? `<button class="btn btn-danger" onclick="deleteProduct('${product.id}', '${product.name}')">Удалить</button>` : ''}
                                <button class="btn btn-secondary" onclick="openHistoryModal('${product.id}', \`${product.name || ''}\`)">История</button>
                                <span class="close" onclick="closeProductCard()">&times;</span>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Основная информация -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                <div>
                                    <h3 style="color: #667eea; margin-bottom: 15px;">Основная информация</h3>
                                    <p><strong>Название:</strong> ${product.name}</p>
                                    <p><strong>Артикул:</strong> ${product.sku || '-'}</p>
                                    <p><strong>Поставщик:</strong> ${product.supplier || '-'}</p>
                                    <p><strong>Категория:</strong> ${product.category || '-'}</p>
                                    <p><strong>Описание:</strong> ${product.description || '-'}</p>
                                    <p><strong>Закупочная цена:</strong> ${APIHelpers.formatCurrency(product.purchasePrice)} | <strong>Цена продажи:</strong> ${APIHelpers.formatCurrency(product.price)}</p>
                                </div>
                                <div>
                                    <h3 style="color: #667eea; margin-bottom: 15px;">Складская информация</h3>
                                    <p><strong>Остаток:</strong> <span style="color: ${product.quantity > 0 ? '#28a745' : '#dc3545'};">${product.quantity || 0} ${product.unit || 'шт'}</span></p>
                                    <p><strong>Мин. остаток:</strong> ${product.minQuantity || 0} ${product.unit || 'шт'}</p>
                                    <p><strong>Местоположение:</strong> ${product.location || '-'}</p>
                                    <p><strong>Статус:</strong> ${product.status || 'active'}</p>
                                    <p><strong>Создан:</strong> ${APIHelpers.formatDateTime(product.createdAt)} | <strong>Обновлен:</strong> ${APIHelpers.formatDateTime(product.updatedAt)}</p>
                                </div>
                            </div>
                            
                            <!-- Номера баллонов -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">Номера баллонов (${serialNumbers.length} шт.)</h3>
                                ${serialNumbers.length > 0 ? `
                                    <div style="display: grid; gap: 15px;">
                                        ${serialNumbers.map(serial => {
                                            const statusColor = serial.status === 'active' ? '#28a745' : serial.status === 'lost' ? '#dc3545' : '#6c757d';
                                            const statusText = serial.status === 'active' ? 'На складе' : serial.status === 'lost' ? 'Списан' : serial.status;
                                            
                                            return `
                                                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid ${statusColor};">
                                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: center;">
                                                        <div>
                                                            <strong style="font-size: 16px;">${serial.serialNumber}</strong>
                                                        </div>
                                                        <div>
                                                            <small style="color: #6c757d; display: block;">Дата изготовления</small>
                                                            <span>${serial.manufactureDate || '-'}</span>
                                                        </div>
                                                        <div>
                                                            <small style="color: #6c757d; display: block;">Дата переосвидетельствования</small>
                                                            <span>${serial.certificationDate || '-'}</span>
                                                        </div>
                                                        <div>
                                                            <small style="color: #6c757d; display: block;">Следующее переосвидетельствование</small>
                                                            <span>${serial.nextCertificationDate || '-'}</span>
                                                        </div>
                                                        <div>
                                                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; background-color: ${statusColor};">
                                                                ${statusText}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">
                                        Номера баллонов не указаны
                                    </p>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(cardModal);
                
                // Обработчик закрытия по клику вне модального окна
                cardModal.addEventListener('click', function(event) {
                    if (event.target === cardModal) {
                        closeProductCard();
                    }
                });
                
            } catch (error) {
                console.error('Error opening product card:', error);
                alert('Ошибка при открытии карточки товара: ' + error.message);
            }
        }

        // Закрытие карточки товара
        function closeProductCard() {
            const modal = document.getElementById('productCardModal');
            if (modal) {
                modal.remove();
            }
        }

        // Функции для инвентаризации
        let inventoryData = null;
        
        async function openInventoryModal(productId, productName, currentStock, unit) {
            try {
                // Сохраняем данные товара
                inventoryData = { productId, productName, currentStock, unit };
                
                // Устанавливаем заголовок и текущий остаток
                document.getElementById('inventoryModalTitle').textContent = `Инвентаризация: ${productName}`;
                document.getElementById('currentInventoryStock').textContent = `${currentStock} ${unit}`;
                document.getElementById('inventoryModalErrorMessage').style.display = 'none';
                document.getElementById('inventoryReason').value = '';
                
                // Загружаем номера баллонов с сервера
                const serialNumbers = await API.getSerialNumbers(productId);
                
                // Фильтруем только активные баллоны для инвентаризации
                const activeSerialNumbers = (serialNumbers.serialNumbers || []).filter(serial => serial.status === 'active');
                displayInventorySerialNumbers(activeSerialNumbers);
                updateFinalInventoryCount();
                
                // Показываем модальное окно
                document.getElementById('inventoryModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading serial numbers:', error);
                showTabMessage('warehouse', 'Ошибка при загрузке номеров баллонов: ' + (error.message || error), false);
            }
        }
        
        function displayInventorySerialNumbers(serialNumbers) {
            const container = document.getElementById('inventorySerialNumbersList');
            
            if (serialNumbers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">На складе нет номеров баллонов для этого товара</p>';
                return;
            }
            
            container.innerHTML = serialNumbers.map(serial => `
                <div class="inventory-serial-item" style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; border: 1px solid #dee2e6; border-radius: 6px; background-color: #f8f9fa;">
                    <label style="display: flex; align-items: center; width: 100%; cursor: pointer; margin: 0;">
                        <input type="checkbox" 
                               class="inventory-checkbox" 
                               value="${serial.serialNumber}" 
                               checked 
                               onchange="updateFinalInventoryCount()" 
                               style="margin-right: 15px; transform: scale(1.2);">
                        
                        <div style="flex: 1;">
                            <strong>${serial.serialNumber}</strong>
                            ${serial.manufactureDate ? `<br><small style="color: #6c757d;">Изготовлен: ${serial.manufactureDate}</small>` : ''}
                            ${serial.certificationDate ? `<br><small style="color: #6c757d;">Аттестован: ${serial.certificationDate}</small>` : ''}
                            ${serial.nextCertificationDate ? `<br><small style="color: #28a745;">Следующая аттестация: ${serial.nextCertificationDate}</small>` : ''}
                        </div>
                        
                        <span class="inventory-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background-color: #28a745; color: white;">
                            НА СКЛАДЕ
                        </span>
                    </label>
                </div>
            `).join('');
        }
        
        function updateFinalInventoryCount() {
            const checkedBoxes = document.querySelectorAll('.inventory-checkbox:checked');
            const finalCount = checkedBoxes.length;
            const unit = inventoryData ? inventoryData.unit : 'шт';
            
            document.getElementById('finalInventoryCount').textContent = `${finalCount} ${unit}`;
            
            // Обновляем статус элементов
            document.querySelectorAll('.inventory-serial-item').forEach(item => {
                const checkbox = item.querySelector('.inventory-checkbox');
                const status = item.querySelector('.inventory-status');
                
                if (checkbox.checked) {
                    status.textContent = 'НА СКЛАДЕ';
                    status.style.backgroundColor = '#28a745';
                    item.style.backgroundColor = '#f8f9fa';
                } else {
                    status.textContent = 'ОТСУТСТВУЕТ';
                    status.style.backgroundColor = '#dc3545';
                    item.style.backgroundColor = '#fff5f5';
                }
            });
        }
        
        async function saveInventory() {
            if (!inventoryData) return;
            
            try {
                const allCheckboxes = document.querySelectorAll('.inventory-checkbox');
                const checkedBoxes = document.querySelectorAll('.inventory-checkbox:checked');
                const uncheckedBoxes = document.querySelectorAll('.inventory-checkbox:not(:checked)');
                
                const finalCount = checkedBoxes.length;
                const currentStock = inventoryData.currentStock;
                const difference = finalCount - currentStock;
                
                if (difference === 0) {
                    showInventoryError('Остаток не изменился. Инвентаризация не требуется.');
                    return;
                }
                
                const reason = document.getElementById('inventoryReason').value.trim();
                if (!reason) {
                    showInventoryError('Укажите причину изменения остатка');
                    return;
                }
                
                // Отключаем кнопку и показываем загрузку
                const saveBtn = document.getElementById('saveInventoryBtn');
                saveBtn.innerHTML = '<div class="loading"></div>Сохранение...';
                saveBtn.disabled = true;
                
                // Подготавливаем данные для транзакции
                const presentCylinders = Array.from(checkedBoxes).map(cb => cb.value);
                const missingCylinders = Array.from(uncheckedBoxes).map(cb => cb.value);
                
                // Формируем детальное описание операции
                let detailedReason = `${reason}. `;
                if (missingCylinders.length > 0) {
                    detailedReason += `Списаны баллоны: ${missingCylinders.join(', ')}. `;
                }
                if (presentCylinders.length > 0) {
                    detailedReason += `Остались на складе: ${presentCylinders.join(', ')}.`;
                }
                
                // Создаем транзакцию инвентаризации
                await API.createTransaction({
                    productId: inventoryData.productId,
                    type: 'INVENTORY',
                    quantity: finalCount, // Итоговое количество после инвентаризации
                    reason: detailedReason,
                    cylinderNumbers: presentCylinders, // Баллоны, которые остались
                    missingCylinderNumbers: missingCylinders // Баллоны, которые списаны
                });
                
                // Обновить статус списанных номеров баллонов
                if (missingCylinders.length > 0) {
                    try {
                        await API.updateSerialNumbersStatus(missingCylinders, 'lost');
                    } catch (statusError) {
                        console.warn('Could not update serial numbers status:', statusError);
                    }
                }
                
                const actionType = difference > 0 ? 'добавлен' : 'списан';
                const changeDesc = missingCylinders.length > 0 ? ` (списаны: ${missingCylinders.join(', ')})` : '';
                
                showToast(`Инвентаризация: ${inventoryData.productName} - ${Math.abs(difference)} ${inventoryData.unit} ${actionType}${changeDesc}`);
                showTabMessage('warehouse', `Инвентаризация: ${inventoryData.productName} - ${Math.abs(difference)} ${inventoryData.unit} ${actionType}${changeDesc}`);
                
                closeInventoryModal();
                loadWarehouse(currentPage);
                loadStats();
                
            } catch (error) {
                console.error('Error saving inventory:', error);
                showInventoryError('Ошибка при проведении инвентаризации: ' + (error.message || error));
                
                const saveBtn = document.getElementById('saveInventoryBtn');
                saveBtn.innerHTML = '💾 Провести инвентаризацию';
                saveBtn.disabled = false;
            }
        }
        
        function showInventoryError(message) {
            const errorEl = document.getElementById('inventoryModalErrorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            // Также показываем toast уведомление
            showToast(message, true);
        }
        
        function showToast(message, isError = false) {
            // Удаляем существующие toast уведомления
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());

            // Создаем новое toast уведомление
            const toast = document.createElement('div');
            toast.className = `toast-notification ${isError ? 'toast-error' : 'toast-success'}`;
            toast.textContent = message;

            // Добавляем стили для toast
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isError ? '#dc3545' : '#28a745'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 350px;
                word-wrap: break-word;
            `;

            document.body.appendChild(toast);

            // Анимация появления
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);

            // Автоматическое скрытие через 4 секунды
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 4000);
        }
        
        function closeInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'none';
            inventoryData = null;
            
            // Сброс кнопки
            const saveBtn = document.getElementById('saveInventoryBtn');
            saveBtn.innerHTML = '💾 Провести инвентаризацию';
            saveBtn.disabled = false;
        }

        // Экспорт функций для использования в HTML
        window.openProductCard = openProductCard;
        window.closeProductCard = closeProductCard;
    </script>
</body>
</html>