<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–ª–∞–¥ - CO_LAB CRM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: white;
            box-sizing: border-box;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        h1 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-left: 20px;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 12px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            margin-bottom: 4px;
        }

        .user-name {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .user-email {
            color: #666;
            font-size: 12px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .dropdown-item.logout:hover {
            background-color: #fff5f5;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-warning {
            background: #fd7e14;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-warning:hover {
            background: #e8670c;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-info:hover {
            background: #138496;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-for-shipment-unpaid {
            background: #fff3cd;
            color: #856404;
        }

        .status-picking {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-shipped {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .shipment-order-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .shipment-items {
            margin-bottom: 25px;
        }

        .shipment-item {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .shipment-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .quantity-info {
            color: #666;
            font-size: 14px;
        }

        .serial-numbers-section h5 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .serial-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .serial-input-row label {
            min-width: 80px;
            font-size: 13px;
            color: #666;
        }

        .serial-input-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .shipment-files-section {
            border-top: 1px solid #e1e5e9;
            padding-top: 20px;
        }

        .file-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .files-preview {
            margin-top: 15px;
        }

        .file-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            margin-bottom: 5px;
            background: white;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .file-preview-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }

        .image-preview img:hover {
            transform: scale(1.05);
        }

        .file-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 24px;
            border: 1px solid #ddd;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .file-type {
            font-size: 11px;
            color: #999;
        }

        .no-files-text {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
        }

        .image-preview-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .close-preview {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-preview:hover {
            color: #333;
        }

        .image-preview-body {
            padding: 20px;
            text-align: center;
        }

        .image-preview-body img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 4px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .warehouse-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .warehouse-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .warehouse-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .warehouse-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .price-range-filter {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .price-range-filter input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-controls select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .sortable:hover {
            background-color: #f8f9fa;
        }

        .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.5;
        }

        .sort-indicator.asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        .sort-indicator.desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        /* Stock level colors */
        .stock-level {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .stock-level.normal {
            background-color: #d4edda;
            color: #155724;
        }

        .stock-level.low {
            background-color: #fff3cd;
            color: #856404;
        }

        .stock-level.out {
            background-color: #f8d7da;
            color: #721c24;
        }

        .product-row.low-stock {
            background-color: #fff8e1;
        }

        .product-row.out-of-stock {
            background-color: #ffebee;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        #historyModal {
            z-index: 1200;
        }

        #operationModal {
            z-index: 1200;
        }

        #productCardModal {
            z-index: 1050;
        }

        #productModal {
            z-index: 1200;
        }

        #operationTypeModal {
            z-index: 1200;
        }

        #inventoryModal {
            z-index: 1200;
        }

        .modal-content {
            background-color: white;
            margin: 8% auto;
            padding: 20px;
            border-radius: 12px;
            width: 60%;
            max-width: 500px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .quantity-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .quantity-low {
            background: #ffebee;
            color: #c62828;
        }

        .quantity-normal {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .quantity-zero {
            background: #ffebee;
            color: #d32f2f;
        }

        .transaction-history {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
        }

        .transaction-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .transaction-item.outgoing {
            border-left-color: #dc3545;
        }

        .transaction-item.inventory {
            border-left-color: #ffc107;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 12px;
            color: #c33;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 8px;
            padding: 12px;
            color: #3c3;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover {
            background: #f8f9fa;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Grouped serials styles */
        .product-group {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            background: white;
        }

        .product-group-header {
            background: #f8f9fa;
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .product-group-header:hover {
            background: #e9ecef;
        }

        .product-group-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-group-name {
            font-weight: 600;
            color: #333;
        }

        .product-group-code {
            color: #666;
            font-size: 12px;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .product-group-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .stat-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.in-stock {
            background: #d4edda;
            color: #155724;
        }

        .stat-badge.out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        .expand-icon {
            transition: transform 0.2s;
            font-size: 18px;
            color: #666;
        }

        .product-group.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .serials-list {
            display: none;
            padding: 0;
        }

        .product-group.expanded .serials-list {
            display: block;
        }

        .serial-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .serial-item:last-child {
            border-bottom: none;
        }

        .serial-number {
            font-weight: 600;
            color: #333;
        }

        .serial-dates {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 10px;
        }

        .serial-status {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .serial-status.in-stock {
            background: #d4edda;
            color: #155724;
        }

        .serial-status.out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        /* Serial number form styles */
        .serial-row {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .serial-row .form-group {
            margin-bottom: 0;
        }

        .serial-row .form-group label {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .serial-row .form-group input {
            padding: 6px;
            font-size: 12px;
            height: 33px;
            min-height: 33px;
            box-sizing: border-box;
        }

        .serial-row .btn-remove {
            padding: 6px 8px;
            font-size: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Camera interface styles */
        .camera-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .camera-modal-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .camera-container {
            position: relative;
            margin: 20px 0;
        }

        #cameraVideo {
            width: 100%;
            max-width: 600px;
            height: auto;
            border-radius: 10px;
            background: #000;
        }

        .camera-controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn-capture {
            background: #28a745;
            color: white;
        }

        .camera-btn-capture:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .camera-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .camera-btn-cancel:hover {
            background: #5a6268;
        }

        .camera-btn-save {
            background: #007bff;
            color: white;
        }

        .camera-btn-save:hover {
            background: #0056b3;
        }

        .photos-preview {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo-preview {
            position: relative;
            width: 120px;
            height: 90px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e1e5e9;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-remove:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .camera-modal-content {
                margin: 10px;
                width: calc(100% - 20px);
                padding: 15px;
            }

            .camera-controls {
                flex-direction: column;
                align-items: center;
            }

            .camera-btn {
                width: 200px;
                justify-content: center;
            }
        }

        /* Bulk product modal styles */
        .input-method-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .serial-row {
            margin-bottom: 5px;
        }

        .serial-input, .manufacture-date, .cert-date, .next-cert-date,
        .product-serial-input, .product-manufacture-date, .product-cert-date, .product-next-cert-date {
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            height: 40px;
            box-sizing: border-box;
            line-height: 1.4;
        }

        .serial-input:focus, .manufacture-date:focus, .cert-date:focus, .next-cert-date:focus,
        .product-serial-input:focus, .product-manufacture-date:focus, .product-cert-date:focus, .product-next-cert-date:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –≤–≤–æ–¥–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ö */
        .form-group input,
        .form-group select,
        .form-group textarea {
            height: 40px;
            min-height: 40px;
            box-sizing: border-box;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.4;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        /* –û—Å–æ–±—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è textarea */
        .form-group textarea {
            height: 80px;
            min-height: 80px;
            resize: vertical;
        }
        
        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å—Ç—Ä–æ–∫ —Å —Å–µ—Ä–∏–π–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ */
        .serial-row {
            min-height: 60px;
        }
        
        .serial-row input {
            height: 33px;
            min-height: 33px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 30px;">
                    <h1>–°–∫–ª–∞–¥</h1>
                    <button class="btn btn-success" onclick="openAddProductModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="nav-buttons">
                        <a href="markup_calculator.html" class="btn btn-secondary">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
                        <a href="clients.html" class="btn btn-secondary">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã</a>
                        <a href="orders.html" class="btn btn-secondary">–ó–∞—è–≤–∫–∏</a>
                        <a href="contracts.html" class="btn btn-secondary">–î–æ–≥–æ–≤–æ—Ä—ã</a>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                            –£
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-header">
                                <div class="user-name" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                                <div class="user-email" id="userEmail">user@example.com</div>
                            </div>
                            <button class="dropdown-item logout" onclick="logout()">
                                üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">-</div>
                <div class="stat-label">–ü–æ–∑–∏—Ü–∏–π —Ç–æ–≤–∞—Ä–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalQuantity">-</div>
                <div class="stat-label">–ï–¥–∏–Ω–∏—Ü –Ω–∞ —Å–∫–ª–∞–¥–µ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalValue">-</div>
                <div class="stat-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (—Å—É–º)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lowStockItems">-</div>
                <div class="stat-label">–¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('warehouse')">–°–∫–ª–∞–¥</button>
            <button class="tab" onclick="switchTab('transactions')">–û–ø–µ—Ä–∞—Ü–∏–∏</button>
            <button class="tab" onclick="switchTab('orders')">–ó–∞—è–≤–∫–∏ –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Å–∫–ª–∞–¥–∞ -->
        <div id="warehouseTab" class="tab-content active">
            <div class="section" style="position: relative;">
                <div id="warehouseLoadingOverlay" class="loading-overlay" style="display: none;">
                    <div>
                        <div class="loading"></div>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>

                <div id="warehouseErrorMessage" class="error-message" style="display: none;"></div>
                <div id="warehouseSuccessMessage" class="success-message" style="display: none;"></div>

                <div class="search-controls">
                    <input type="text" class="search-input" id="warehouseSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É, –ø–æ—Å—Ç–∞–≤—â–∏–∫—É..." onkeyup="handleWarehouseSearch()">
                    <div class="filter-controls">
                        <label>
                            <input type="checkbox" id="lowStockFilter" onchange="handleWarehouseSearch()">
                            –¢–æ–ª—å–∫–æ —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º
                        </label>
                        <select id="supplierFilter" onchange="handleWarehouseSearch()">
                            <option value="">–í—Å–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏</option>
                        </select>
                        <div class="price-range-filter">
                            <label>–¶–µ–Ω–∞ –æ—Ç:</label>
                            <input type="number" id="minPriceFilter" placeholder="0" step="0.01" onchange="handleWarehouseSearch()">
                            <label>–¥–æ:</label>
                            <input type="number" id="maxPriceFilter" placeholder="‚àû" step="0.01" onchange="handleWarehouseSearch()">
                        </div>
                        <button class="btn btn-primary" onclick="loadWarehouse()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <div class="table-controls">
                    <div class="sort-controls">
                        <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
                        <select id="sortField" onchange="handleWarehouseSorting()">
                            <option value="name">–ù–∞–∑–≤–∞–Ω–∏–µ</option>
                            <option value="code">–ê—Ä—Ç–∏–∫—É–ª</option>
                            <option value="supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</option>
                            <option value="purchasePrice">–¶–µ–Ω–∞</option>
                            <option value="currentStock">–û—Å—Ç–∞—Ç–æ–∫</option>
                            <option value="minStock">–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫</option>
                            <option value="createdAt" selected>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                            <option value="updatedAt">–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</option>
                        </select>
                        <select id="sortOrder" onchange="handleWarehouseSorting()">
                            <option value="ASC">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                            <option value="DESC" selected>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                        </select>
                    </div>
                    <div class="pagination-controls">
                        <label>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ:</label>
                        <select id="pageSize" onchange="handlePageSizeChange()">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span id="paginationInfo" class="pagination-info"></span>
                    </div>
                </div>
                
                <div id="warehouseTableContainer">
                    <table class="warehouse-table" id="warehouseTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">
                                    –¢–æ–≤–∞—Ä <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="code">
                                    –ê—Ä—Ç–∏–∫—É–ª <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="supplier">
                                    –ü–æ—Å—Ç–∞–≤—â–∏–∫ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="currentStock">
                                    –û—Å—Ç–∞—Ç–æ–∫ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="minStock">
                                    –ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="purchasePrice">
                                    –¶–µ–Ω–∞ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th>–ï–¥–∏–Ω–∏—Ü–∞</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="warehouseTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="warehousePagination" class="pagination"></div>
            </div>
        </div>



        <!-- –í–∫–ª–∞–¥–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π -->
        <div id="transactionsTab" class="tab-content">
            <div class="section" style="position: relative;">
                <div id="transactionsLoadingOverlay" class="loading-overlay" style="display: none;">
                    <div>
                        <div class="loading"></div>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>

                <div id="transactionsErrorMessage" class="error-message" style="display: none;"></div>
                <div id="transactionsSuccessMessage" class="success-message" style="display: none;"></div>

                <div class="search-controls">
                    <select id="transactionTypeFilter" onchange="loadTransactions()">
                        <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
                        <option value="INCOMING">üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</option>
                        <option value="OUTGOING">üì§ –û—Ç–≥—Ä—É–∑–∫–∏</option>
                        <option value="INVENTORY">üìã –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadTransactions()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                
                <div id="transactionsTableContainer">
                    <!-- Transactions table will be loaded here -->
                </div>

                <div id="transactionsPagination" class="pagination"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É -->
        <div id="ordersTab" class="tab-content">
            <div class="section" style="position: relative;">
                <div id="ordersLoadingOverlay" class="loading-overlay" style="display: none;">
                    <div>
                        <div class="loading"></div>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>

                <div id="ordersErrorMessage" class="error-message" style="display: none;"></div>
                <div id="ordersSuccessMessage" class="success-message" style="display: none;"></div>

                <div class="search-controls">
                    <button class="btn btn-primary" onclick="loadWarehouseOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                
                <div id="ordersTableContainer">
                    <!-- Orders table will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <div id="productModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="productModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            
            <div id="productModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="productForm">
                <!-- –û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–∞ -->
                <div class="section" style="margin-bottom: 25px;">
                    <h3>–û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–∞</h3>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="productName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="productUnit">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                            <select id="productUnit">
                                <option value="—à—Ç">—à—Ç</option>
                                <option value="–∫–≥">–∫–≥</option>
                                <option value="–º">–º</option>
                                <option value="–º¬≤">–º¬≤</option>
                                <option value="–º¬≥">–º¬≥</option>
                                <option value="–ª">–ª</option>
                                <option value="—É–ø–∞–∫">—É–ø–∞–∫</option>
                                <option value="–∫–æ—Ä–æ–±–∫–∞">–∫–æ—Ä–æ–±–∫–∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="productSupplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                            <select id="productSupplier" style="width: 100%;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="productMinStock">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" id="productMinStock" value="0" min="0" step="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="productPurchasePrice">–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏</label>
                            <input type="number" id="productPurchasePrice" value="0" min="0" step="0.01">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="productCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <input type="text" id="productCategory" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞">
                        </div>
                    </div>
                </div>

                <!-- –°–ø–æ—Å–æ–±—ã –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤ -->
                <div class="section">
                    <h3>–ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤</h3>
                    
                    <div class="form-group">
                        <label>–°–ø–æ—Å–æ–± –≤–≤–æ–¥–∞:</label>
                        <div style="display: flex; gap: 15px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; margin: 0;">
                                <input type="radio" name="productInputMethod" value="manual" checked onchange="switchProductInputMethod()" style="margin-right: 8px;">
                                –†—É—á–Ω–æ–π –≤–≤–æ–¥
                            </label>
                            <label style="display: flex; align-items: center; margin: 0;">
                                <input type="radio" name="productInputMethod" value="range" onchange="switchProductInputMethod()" style="margin-right: 8px;">
                                –î–∏–∞–ø–∞–∑–æ–Ω –Ω–æ–º–µ—Ä–æ–≤
                            </label>
                            <label style="display: flex; align-items: center; margin: 0;">
                                <input type="radio" name="productInputMethod" value="text" onchange="switchProductInputMethod()" style="margin-right: 8px;">
                                –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
                            </label>
                        </div>
                    </div>

                    <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
                    <div id="productManualInput" class="input-method-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label>–ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤:</label>
                            <button type="button" class="btn btn-secondary" onclick="addProductSerialRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
                        </div>
                        <div id="productSerialNumbersContainer">
                            <div class="serial-row">
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <div style="flex: 2; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ *</small>
                                        <input type="text" placeholder="–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞" class="product-serial-input" style="height: 33px;" required>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è *</small>
                                        <input type="text" placeholder="MM/YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è *</small>
                                        <input type="text" placeholder="MM/YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                                    </div>
                                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ *</small>
                                        <input type="text" placeholder="MM/YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                                    </div>
                                    <div style="display: flex; align-items: flex-end; min-height: 50px;">
                                        <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px; height: 33px;">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –î–∏–∞–ø–∞–∑–æ–Ω –Ω–æ–º–µ—Ä–æ–≤ -->
                    <div id="productRangeInput" class="input-method-section" style="display: none;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangePrefix">–ü—Ä–µ—Ñ–∏–∫—Å</label>
                                <input type="text" id="productRangePrefix" placeholder="BAL" value="BAL">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeStart">–ù–∞—á–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                                <input type="number" id="productRangeStart" placeholder="1" min="1" value="1">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeEnd">–ö–æ–Ω–µ—á–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                                <input type="number" id="productRangeEnd" placeholder="10" min="1">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeFormat">–†–∞–∑—Ä—è–¥–Ω–æ—Å—Ç—å</label>
                                <input type="number" id="productRangeFormat" placeholder="3" min="1" value="3">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeManufactureDate">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–º–µ—Å—è—Ü/–≥–æ–¥)</label>
                                <input type="text" id="productRangeManufactureDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="–§–æ—Ä–º–∞—Ç: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeCertDate">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è (–º–µ—Å—è—Ü/–≥–æ–¥)</label>
                                <input type="text" id="productRangeCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="–§–æ—Ä–º–∞—Ç: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productRangeNextCertDate">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è (–º–µ—Å—è—Ü/–≥–æ–¥)</label>
                                <input type="text" id="productRangeNextCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="–§–æ—Ä–º–∞—Ç: MM/YYYY">
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="previewProductRange()">üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                            <div id="productRangePreview" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                                <strong>–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –Ω–æ–º–µ—Ä–æ–≤:</strong>
                                <div id="productRangePreviewList" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ -->
                    <div id="productTextInput" class="input-method-section" style="display: none;">
                        <div class="form-group">
                            <label for="productTextSerialNumbers">–ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ)</label>
                            <textarea id="productTextSerialNumbers" rows="10" placeholder="BAL001&#10;BAL002&#10;BAL003&#10;..."></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                –í—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã.
                            </small>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="productTextManufactureDate">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–º–µ—Å—è—Ü/–≥–æ–¥)</label>
                                <input type="text" id="productTextManufactureDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="–§–æ—Ä–º–∞—Ç: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productTextCertDate">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è (–º–µ—Å—è—Ü/–≥–æ–¥)</label>
                                <input type="text" id="productTextCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="–§–æ—Ä–º–∞—Ç: MM/YYYY">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="productTextNextCertDate">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è (–º–µ—Å—è—Ü/–≥–æ–¥)</label>
                                <input type="text" id="productTextNextCertDate" class="date-input" placeholder="MM / YYYY" maxlength="7" style="text-align: center; font-family: monospace;" title="–§–æ—Ä–º–∞—Ç: MM/YYYY">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()" style="margin-right: 10px;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success" id="saveProductBtn">üíæ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ç–æ–≤–∞—Ä–æ–º -->
    <div id="operationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="operationModalTitle">–û–ø–µ—Ä–∞—Ü–∏—è —Å —Ç–æ–≤–∞—Ä–æ–º</h2>
                <span class="close" onclick="closeOperationModal()">&times;</span>
            </div>
            
            <div id="operationModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="operationForm">
                <div class="form-group">
                    <label for="operationType">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ *</label>
                    <select id="operationType" required onchange="updateOperationForm()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é</option>
                        <option value="INCOMING">üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</option>
                        <option value="OUTGOING">üì§ –û—Ç–≥—Ä—É–∑–∫–∞/–°–ø–∏—Å–∞–Ω–∏–µ</option>
                        <option value="INVENTORY">üìã –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="operationQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                        <input type="number" id="operationQuantity" step="0.01" min="0" required>
                        <small id="currentStockInfo" style="color: #666;"></small>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="operationReason">–ü—Ä–∏—á–∏–Ω–∞/–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <input type="text" id="operationReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏">
                    </div>
                </div>

                <div id="clientField" class="form-group" style="display: none;">
                    <label for="operationClient">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</label>
                    <select id="operationClient">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</option>
                    </select>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeOperationModal()" style="margin-right: 10px;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="executeOperationBtn">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞ -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="historyModalTitle">–ò—Å—Ç–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞</h2>
                <span class="close" onclick="closeHistoryModal()">&times;</span>
            </div>
            
            <div id="transactionHistory" class="transaction-history">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–º–µ—Ä—ã –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –æ—Ç–≥—Ä—É–∑–∫–∏ -->
    <div id="cameraModal" class="camera-modal">
        <div class="camera-modal-content">
            <h3>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–≥—Ä—É–∑–∫–∏</h3>
            <p>–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ñ–∞–∫—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞</p>
            
            <div class="camera-container">
                <video id="cameraVideo" autoplay muted playsinline></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>

            <div class="camera-controls">
                <button class="camera-btn camera-btn-capture" onclick="capturePhoto()">
                    üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                </button>
                <button class="camera-btn camera-btn-cancel" onclick="closeCameraModal()">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
                <button class="camera-btn camera-btn-save" onclick="savePhotos()" style="display: none;">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ
                </button>
            </div>

            <div id="photosPreview" class="photos-preview"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–∫–∏ -->
    <div id="shipmentModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üì¶ –§–æ—Ä–º–∞ –æ—Ç–≥—Ä—É–∑–∫–∏</h2>
                <span class="close" onclick="closeShipmentModal()">&times;</span>
            </div>
            
            <div id="shipmentFormContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–æ—Ä–º—ã –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                <button type="button" class="btn btn-secondary" onclick="closeShipmentModal()" style="margin-right: 10px;">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" onclick="executeShipment()">üì¶ –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div id="operationTypeModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="operationTypeTitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                <span class="close" onclick="closeOperationTypeModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <p id="operationTypeProductName" style="margin-bottom: 20px; font-weight: bold;"></p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="btn btn-success" onclick="selectOperationType('incoming')" style="padding: 15px; text-align: left;">
                        üì• <strong>–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</strong>
                        <small style="display: block; margin-top: 5px; color: #6c757d;">–ü—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –±–∞–ª–ª–æ–Ω–æ–≤</small>
                    </button>
                    
                    <button class="btn btn-info" onclick="selectOperationType('inventory')" style="padding: 15px; text-align: left;">
                        üìã <strong>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</strong>
                        <small style="display: block; margin-top: 5px; color: #6c757d;">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="inventoryModalTitle">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: </h2>
                <span class="close" onclick="closeInventoryModal()">&times;</span>
            </div>
            
            <div id="inventoryModalErrorMessage" class="error-message" style="display: none;"></div>
            
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ:</strong>
                        <span id="currentInventoryStock" style="font-size: 18px; color: #28a745;"></span>
                    </div>
                    <small style="color: #6c757d;">–û—Ç–º–µ—Ç—å—Ç–µ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥–µ</small>
                </div>

                <div id="inventorySerialNumbersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- –°–ø–∏—Å–æ–∫ –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <strong>–ò—Ç–æ–≥–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</strong>
                        <span id="finalInventoryCount" style="font-size: 18px; font-weight: bold; color: #007bff;">0 —à—Ç</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="inventoryReason">–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–∞:</label>
                        <textarea id="inventoryReason" rows="3" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –±–∞–ª–ª–æ–Ω–æ–≤, –ø–æ—Ç–µ—Ä—è, –æ—à–∏–±–∫–∞ —É—á–µ—Ç–∞)"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveInventoryBtn" onclick="saveInventory()">üíæ –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentOperationProduct = null;
        let currentPage = 1;
        let currentTransactionsPage = 1;
        const pageSize = 10;
        let searchTimeouts = {};
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≥—Ä—É–∑–∫–∏
        let currentShippingOrder = null;
        let shippingItems = [];
        let shipmentFiles = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ api.js
            // –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            
            initializeUserInfo();
            loadWarehouse();
            loadStats();
            loadClientsForOperations();
            initializeDateInputs();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å–æ–∫ –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç
        function initializeDateInputs() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è input —Å–æ–±—ã—Ç–∏–π (–æ—Å–Ω–æ–≤–Ω–æ–π)
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('date-input')) {
                    formatDateInput(e.target);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è keyup —Å–æ–±—ã—Ç–∏–π (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            document.addEventListener('keyup', function(e) {
                if (e.target.classList.contains('date-input')) {
                    formatDateInput(e.target);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è change —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞)
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('date-input') && e.target.classList.contains('product-cert-date')) {
                    calculateNextCertification(e.target);
                }
            });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç MM/YYYY
        function formatDateInput(input) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            const cursorPos = input.selectionStart;
            const oldValue = input.value;
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
            let value = input.value.replace(/[^\d]/g, '');
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É (2 —Ü–∏—Ñ—Ä—ã –¥–ª—è –º–µ—Å—è—Ü–∞ + 4 –¥–ª—è –≥–æ–¥–∞)
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º "/" –ø–æ—Å–ª–µ 2-—Ö —Ü–∏—Ñ—Ä
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 6);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Å—è—Ü (01-12)
            if (value.length >= 2) {
                const month = parseInt(value.substring(0, 2));
                if (month > 12 || month < 1) {
                    return; // –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –º–µ—Å—è—Ü –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
                }
            }
            
            input.value = value;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            if (value.length > oldValue.length && cursorPos === 2 && value.charAt(2) === '/') {
                input.setSelectionRange(cursorPos + 1, cursorPos + 1);
            } else {
                input.setSelectionRange(cursorPos, cursorPos);
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è
            if (input.classList.contains('product-cert-date') && value.length === 7) {
                calculateNextCertification(input);
            }
        }

        // –†–∞—Å—á–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π –¥–∞—Ç—ã –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è
        function calculateNextCertification(certInput) {
            try {
                const certValue = certInput.value;
                if (!certValue || certValue.length !== 7) {
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç MM/YYYY
                const parts = certValue.split('/');
                if (parts.length !== 2 || parts[0].length !== 2 || parts[1].length !== 4) {
                    return;
                }
                
                // –ù–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ/—Ñ–æ—Ä–º–µ
                let manufactureInput, nextCertInput;
                
                if (certInput.classList.contains('product-cert-date')) {
                    // –†—É—á–Ω–æ–π –≤–≤–æ–¥ - –Ω–∞–π—Ç–∏ –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ
                    const row = certInput.closest('.serial-row') || certInput.closest('.form-row') || certInput.closest('div');
                    if (row) {
                        manufactureInput = row.querySelector('.product-manufacture-date');
                        nextCertInput = row.querySelector('.product-next-cert-date');
                    }
                } else if (certInput.id === 'productRangeCertDate') {
                    // –î–∏–∞–ø–∞–∑–æ–Ω
                    manufactureInput = document.getElementById('productRangeManufactureDate');
                    nextCertInput = document.getElementById('productRangeNextCertDate');
                } else if (certInput.id === 'productTextCertDate') {
                    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
                    manufactureInput = document.getElementById('productTextManufactureDate');
                    nextCertInput = document.getElementById('productTextNextCertDate');
                }
                
                if (!nextCertInput) {
                    return;
                }
                
                const [certMonth, certYear] = certValue.split('/');
                const certMonthNum = parseInt(certMonth);
                const certYearNum = parseInt(certYear);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                if (isNaN(certMonthNum) || isNaN(certYearNum) || certMonthNum < 1 || certMonthNum > 12) {
                    return;
                }
                
                let nextYear = certYearNum + 5;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è 40 –ª–µ—Ç –æ—Ç –¥–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
                if (manufactureInput && manufactureInput.value && manufactureInput.value.length === 7) {
                    const manufParts = manufactureInput.value.split('/');
                    if (manufParts.length === 2 && manufParts[1].length === 4) {
                        const manufYear = parseInt(manufParts[1]);
                        if (!isNaN(manufYear)) {
                            const maxYear = manufYear + 40;
                            
                            if (nextYear > maxYear) {
                                nextYear = maxYear;
                            }
                        }
                    }
                }
                
                const nextDate = certMonth.padStart(2, '0') + '/' + nextYear;
                nextCertInput.value = nextDate;
                
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—è —Å–ª–µ–¥—É—é—â–µ–π –¥–∞—Ç—ã
                if (nextCertInput.classList.contains('date-input')) {
                    formatDateInput(nextCertInput);
                }
                
            } catch (error) {
            }
        }

        function initializeUserInfo() {
            const user = APIHelpers.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É - –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∏–º–µ–Ω–∏
                const firstLetter = user.name.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function logout() {
            API.logout();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            switch(tabName) {
                case 'warehouse':
                    loadWarehouse();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'orders':
                    loadWarehouseOrders();
                    break;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        function showTabLoading(tabName, show = true) {
            const overlay = document.getElementById(tabName + 'LoadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        function showTabMessage(tabName, message, isError = false) {
            const errorEl = document.getElementById(tabName + 'ErrorMessage');
            const successEl = document.getElementById(tabName + 'SuccessMessage');
            
            if (errorEl && successEl) {
                if (isError) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                    successEl.style.display = 'none';
                } else {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                    errorEl.style.display = 'none';
                }

                setTimeout(() => {
                    errorEl.style.display = 'none';
                    successEl.style.display = 'none';
                }, 5000);
            }
        }

        function hideTabMessages(tabName) {
            const errorEl = document.getElementById(tabName + 'ErrorMessage');
            const successEl = document.getElementById(tabName + 'SuccessMessage');
            if (errorEl) errorEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞
        async function loadStats() {
            try {
                const stats = await API.getWarehouseStats();
                
                document.getElementById('totalItems').textContent = stats.totalProducts || 0;
                document.getElementById('totalQuantity').textContent = stats.totalQuantity || 0;
                document.getElementById('totalValue').textContent = APIHelpers.formatCurrency(stats.totalValue || 0).replace(' —Å—É–º', '');
                document.getElementById('lowStockItems').textContent = stats.lowStockCount || 0;
                
            } catch (error) {
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–∞
        async function loadWarehouse(page = 1) {
            try {
                currentPage = page;
                showTabLoading('warehouse', true);
                hideTabMessages('warehouse');

                const searchTerm = document.getElementById('warehouseSearchInput').value.trim();
                const lowStock = document.getElementById('lowStockFilter').checked;
                const supplier = document.getElementById('supplierFilter').value;
                const minPrice = document.getElementById('minPriceFilter').value;
                const maxPrice = document.getElementById('maxPriceFilter').value;
                const sortField = document.getElementById('sortField').value;
                const sortOrder = document.getElementById('sortOrder').value;
                const currentPageSize = parseInt(document.getElementById('pageSize').value);
                
                const params = {
                    page,
                    limit: currentPageSize,
                    sort: sortField,
                    order: sortOrder
                };

                if (searchTerm) params.search = searchTerm;
                if (lowStock) params.lowStock = 'true';
                if (supplier) params.supplier = supplier;
                if (minPrice) params.minPrice = parseFloat(minPrice);
                if (maxPrice) params.maxPrice = parseFloat(maxPrice);
                
                // Price range filter
                if (minPrice || maxPrice) {
                    const priceRange = {};
                    if (minPrice) priceRange.min = parseFloat(minPrice);
                    if (maxPrice) priceRange.max = parseFloat(maxPrice);
                    params.priceRange = JSON.stringify(priceRange);
                }

                const response = await API.getProductsPaginated(
                    params.page, 
                    params.limit, 
                    params.sort, 
                    params.order, 
                    params.search || '', 
                    {
                        lowStock: params.lowStock,
                        supplier: params.supplier,
                        priceRange: params.priceRange
                    }
                );
                
                displayWarehouseItems(response.products, response.suppliers, response.stockStats);
                updateWarehousePagination(response.pagination);
                updatePaginationInfo(response.pagination);
                updateSortIndicators(params.sort, params.order);

            } catch (error) {
                showTabMessage('warehouse', APIHelpers.formatError(error), true);
                APIHelpers.showError(document.getElementById('warehouseTableContainer'), '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–ª–∞–¥–∞');
            } finally {
                showTabLoading('warehouse', false);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å–∫–ª–∞–¥–∞
        function displayWarehouseItems(items, suppliers, stockStats) {
            const container = document.getElementById('warehouseTableContainer');
            
            // Update suppliers dropdown
            updateSuppliersDropdown(suppliers);
            
            if (items.length === 0) {
                const searchTerm = document.getElementById('warehouseSearchInput').value.trim();
                const message = searchTerm ? '–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–°–∫–ª–∞–¥ –ø—É—Å—Ç';
                APIHelpers.showEmpty(container, message);
                document.getElementById('warehousePagination').innerHTML = '';
                return;
            }

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞
            if (!document.getElementById('warehouseTable')) {
                container.innerHTML = `
                    <table class="warehouse-table" id="warehouseTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">
                                    –¢–æ–≤–∞—Ä <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="code">
                                    –ê—Ä—Ç–∏–∫—É–ª <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="supplier">
                                    –ü–æ—Å—Ç–∞–≤—â–∏–∫ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="currentStock">
                                    –û—Å—Ç–∞—Ç–æ–∫ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="minStock">
                                    –ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th class="sortable" data-sort="purchasePrice">
                                    –¶–µ–Ω–∞ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th>–ï–¥–∏–Ω–∏—Ü–∞</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="warehouseTableBody"></tbody>
                    </table>
                `;
                
                // Add click handlers for sortable headers
                container.addEventListener('click', handleTableHeaderClick);
            }

            // –ü–æ–ª—É—á–∞–µ–º tableBody –ø–æ—Å–ª–µ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
            const tableBody = document.getElementById('warehouseTableBody');
            tableBody.innerHTML = items.map(item => {
                // Handle both nested (item.product) and flat (item) structures
                const product = item.product || item;
                const quantity = item.quantity || product.quantity;
                const totalValue = quantity * product.purchasePrice;
                const isLowStock = product.minQuantity > 0 && quantity <= product.minQuantity;
                const isZeroStock = quantity === 0;
                
                let quantityClass = 'quantity-normal';
                if (isZeroStock) {
                    quantityClass = 'quantity-zero';
                } else if (isLowStock) {
                    quantityClass = 'quantity-low';
                }
                
                const lastUpdated = new Date(item.updatedAt).toLocaleDateString('ru-RU');

                return `
                    <tr style="cursor: pointer;" onclick="openProductCard('${product.id}')" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞">
                        <td>
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small style="color: #6c757d;">${product.description}</small>` : ''}
                            ${product.manufactureDate || product.certificationDate || product.nextCertificationDate ? `
                                <div style="margin-top: 8px; font-size: 11px; color: #6c757d;">
                                    ${product.manufactureDate ? `<div>üìÖ –ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: ${product.manufactureDate}</div>` : ''}
                                    ${product.certificationDate ? `<div>üîß –ü–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏–µ: ${product.certificationDate}</div>` : ''}
                                    ${product.nextCertificationDate ? `<div>‚è∞ –°–ª–µ–¥—É—é—â–µ–µ –æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏–µ: ${product.nextCertificationDate}</div>` : ''}
                                </div>
                            ` : ''}
                        </td>
                        <td>${product.sku || '-'}</td>
                        <td>${product.supplier || '-'}</td>
                        <td>
                            <span class="quantity-badge ${quantityClass}">
                                ${quantity}
                            </span>
                        </td>
                        <td>${product.minQuantity || 0}</td>
                        <td>${APIHelpers.formatCurrency(product.purchasePrice)}</td>
                        <td>${product.unit || '—à—Ç'}</td>
                        <td>${lastUpdated}</td>
                    </tr>
                `;
            }).join('');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å–∫–ª–∞–¥–∞
        function updateWarehousePagination(pagination) {
            updatePagination('warehousePagination', pagination, loadWarehouse);
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        function updatePagination(elementId, pagination, loadFunction) {
            const paginationEl = document.getElementById(elementId);
            
            if (pagination.pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            paginationHTML += `
                <button onclick="${loadFunction.name}(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>
                    ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                </button>
            `;

            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else if (Math.abs(i - pagination.page) <= 2 || i === 1 || i === pagination.pages) {
                    paginationHTML += `<button onclick="${loadFunction.name}(${i})">${i}</button>`;
                } else if (Math.abs(i - pagination.page) === 3) {
                    paginationHTML += '<span>...</span>';
                }
            }

            paginationHTML += `
                <button onclick="${loadFunction.name}(${pagination.page + 1})" ${pagination.page >= pagination.pages ? 'disabled' : ''}>
                    –°–ª–µ–¥—É—é—â–∞—è ‚Üí
                </button>
            `;

            paginationEl.innerHTML = paginationHTML;
        }

        // –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥—É
        function handleWarehouseSearch() {
            clearTimeout(searchTimeouts.warehouse);
            searchTimeouts.warehouse = setTimeout(() => {
                currentPage = 1;
                loadWarehouse(1);
            }, 500);
        }


        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
        async function loadTransactions(page = 1) {
            try {
                currentTransactionsPage = page;
                showTabLoading('transactions', true);
                hideTabMessages('transactions');

                const typeFilter = document.getElementById('transactionTypeFilter').value;
                const params = {
                    page,
                    limit: pageSize
                };

                if (typeFilter) params.type = typeFilter;

                const response = await API.getTransactions(params);
                displayTransactions(response.transactions);
                updatePagination('transactionsPagination', response.pagination, loadTransactions);

            } catch (error) {
                showTabMessage('transactions', APIHelpers.formatError(error), true);
            } finally {
                showTabLoading('transactions', false);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsTableContainer');
            
            if (transactions.length === 0) {
                APIHelpers.showEmpty(container, '–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π');
                return;
            }

            const typeLabels = {
                'INCOMING': '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ',
                'OUTGOING': '–û—Ç–≥—Ä—É–∑–∫–∞',
                'SHIPMENT': '–û—Ç–≥—Ä—É–∑–∫–∞',
                'INVENTORY': '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è'
            };

            container.innerHTML = `
                <table class="warehouse-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(transaction => `
                            <tr>
                                <td>${APIHelpers.formatDateTime(transaction.createdAt)}</td>
                                <td>
                                    <strong>${transaction.productName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä'}</strong>
                                </td>
                                <td>
                                    <span class="transaction-item ${transaction.type.toLowerCase()}">
                                        ${typeLabels[transaction.type] || transaction.type}
                                    </span>
                                </td>
                                <td>${transaction.quantity} —à—Ç</td>
                                <td>${transaction.orderNumber ? `–ó–∞—è–≤–∫–∞ ${transaction.orderNumber}` : '-'}</td>
                                <td>
                                    ${transaction.reason || '-'}${transaction.cylinderNumbers && transaction.cylinderNumbers.length > 0 ? ` (${transaction.cylinderNumbers.map(num => typeof num === 'object' ? num.cylinderNumber : num).join(', ')})` : ''}
                                </td>
                                <td>${transaction.createdBy || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
        async function loadClientsForOperations() {
            try {
                const response = await API.getClients({ limit: 1000 });
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
                const clientSelect = document.getElementById('operationClient');
                if (clientSelect) {
                    clientSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</option>';
                    response.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        clientSelect.appendChild(option);
                    });
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
                const supplierSelect = document.getElementById('productSupplier');
                if (supplierSelect) {
                    const currentValue = supplierSelect.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    supplierSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</option>';
                    response.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ
                        option.textContent = client.name;
                        supplierSelect.appendChild(option);
                    });
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
                    if (currentValue) {
                        supplierSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error loading contractors:', error);
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        function openAddProductModal() {
            try {
                currentEditingProduct = null;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const requiredElements = ['productModalTitle', 'saveProductBtn', 'productForm', 'productModalErrorMessage', 'productSerialNumbersContainer', 'productModal'];
                for (const elementId of requiredElements) {
                    if (!document.getElementById(elementId)) {
                        return;
                    }
                }
                
                document.getElementById('productModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
                document.getElementById('saveProductBtn').textContent = 'üíæ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
                document.getElementById('productForm').reset();
                document.getElementById('productModalErrorMessage').style.display = 'none';
                
                // –£–±–∏—Ä–∞–µ–º readOnly —Å –ø–æ–ª–µ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
                document.getElementById('productName').readOnly = false;
                document.getElementById('productUnit').readOnly = false;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
                loadClientsForOperations();
                
                // –°–±—Ä–æ—Å –∫ —Ä—É—á–Ω–æ–º—É –≤–≤–æ–¥—É
                const manualRadio = document.querySelector('input[name="productInputMethod"][value="manual"]');
                if (manualRadio) {
                    manualRadio.checked = true;
                    switchProductInputMethod();
                } else {
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
                const container = document.getElementById('productSerialNumbersContainer');
                container.innerHTML = `
                    <div class="serial-row">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="text" placeholder="–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞" class="product-serial-input" style="flex: 2;">
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <small style="color: #666; font-size: 11px; margin-bottom: 2px;">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</small>
                                <input type="text" placeholder="MM / YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace;" maxlength="7" title="–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY">
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <small style="color: #666; font-size: 11px; margin-bottom: 2px;">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è</small>
                                <input type="text" placeholder="MM / YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7" title="–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY">
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <small style="color: #666; font-size: 11px; margin-bottom: 2px;">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞</small>
                                <input type="text" placeholder="MM / YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7" title="–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY">
                            </div>
                            <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('productModal').style.display = 'block';
                
            } catch (error) {
            }
        }

        function closeProductModal() {
            // –°–±—Ä–æ—Å–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é —Å–æ–∑–¥–∞–Ω–∏—è
            document.getElementById('productModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é —Å –Ω–æ–º–µ—Ä–∞–º–∏ –±–∞–ª–ª–æ–Ω–æ–≤
            const serialNumbersSection = document.querySelector('.section:nth-child(2)');
            if (serialNumbersSection) {
                serialNumbersSection.style.display = 'block';
            }
            
            // –°–±—Ä–æ—Å–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveBtn = document.getElementById('saveProductBtn');
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            
            // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            window.isEditMode = false;
            window.editProductId = null;
            
            // –£–±–∏—Ä–∞–µ–º readOnly —Å –ø–æ–ª–µ–π
            document.getElementById('productName').readOnly = false;
            document.getElementById('productUnit').readOnly = false;
            
            // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('productModal').style.display = 'none';
            
            // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
            document.getElementById('productForm').reset();
            
            // –°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
            document.getElementById('productModalErrorMessage').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
        function switchProductInputMethod() {
            const methodRadio = document.querySelector('input[name="productInputMethod"]:checked');
            if (!methodRadio) {
                return;
            }
            const method = methodRadio.value;
            
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            const sections = ['productManualInput', 'productRangeInput', 'productTextInput'];
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.style.display = 'none';
                } else {
                }
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
            const targetSectionId = 'product' + method.charAt(0).toUpperCase() + method.slice(1) + 'Input';
            const targetElement = document.getElementById(targetSectionId);
            if (targetElement) {
                targetElement.style.display = 'block';
            } else {
            }
        }

        function addProductSerialRow() {
            const container = document.getElementById('productSerialNumbersContainer');
            const newRow = document.createElement('div');
            newRow.className = 'serial-row';
            newRow.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 2; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ *</small>
                        <input type="text" placeholder="–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞" class="product-serial-input" style="height: 33px;" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                    </div>
                    <div style="display: flex; align-items: flex-end; min-height: 50px;">
                        <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px; height: 33px;">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            container.appendChild(newRow);
        }

        function removeProductSerialRow(button) {
            const container = document.getElementById('productSerialNumbersContainer');
            if (container.children.length > 1) {
                button.closest('.serial-row').remove();
            } else {
                showProductModalMessage('–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞', true);
            }
        }

        function previewProductRange() {
            const prefix = document.getElementById('productRangePrefix').value || '';
            const start = parseInt(document.getElementById('productRangeStart').value) || 1;
            const end = parseInt(document.getElementById('productRangeEnd').value) || start;
            const format = parseInt(document.getElementById('productRangeFormat').value) || 3;
            
            if (end < start) {
                showProductModalMessage('–ö–æ–Ω–µ—á–Ω—ã–π –Ω–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ', true);
                return;
            }
            
            if (end - start > 1000) {
                showProductModalMessage('–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω (–º–∞–∫—Å–∏–º—É–º 1000 –Ω–æ–º–µ—Ä–æ–≤)', true);
                return;
            }
            
            const preview = document.getElementById('productRangePreview');
            const list = document.getElementById('productRangePreviewList');
            
            let html = '';
            const count = end - start + 1;
            
            for (let i = start; i <= Math.min(start + 20, end); i++) {
                const number = prefix + i.toString().padStart(format, '0');
                html += `<span style="display: inline-block; margin: 2px 5px; padding: 2px 8px; background: white; border: 1px solid #ddd; border-radius: 4px;">${number}</span>`;
            }
            
            if (count > 20) {
                html += `<div style="margin-top: 10px; color: #666;">...–∏ –µ—â–µ ${count - 20} –Ω–æ–º–µ—Ä–æ–≤</div>`;
            }
            
            list.innerHTML = html;
            preview.style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const header = preview.querySelector('strong');
            header.textContent = `–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –Ω–æ–º–µ—Ä–æ–≤: ${count}`;
        }

        function showProductModalMessage(message, isError = false) {
            const errorEl = document.getElementById('productModalErrorMessage');
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            } else {
                errorEl.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–∏–π–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ –≤ —Ñ–æ—Ä–º–µ
        function addSerialNumberRow() {
            const container = document.getElementById('serialNumbersList');
            
            const row = document.createElement('div');
            row.className = 'serial-row';
            row.innerHTML = `
                <div class="form-group" style="flex: 2;">
                    <label>–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ *</label>
                    <input type="text" class="serial-number-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</label>
                    <input type="date" class="manufacture-date-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>–î–∞—Ç–∞ –æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è</label>
                    <input type="date" class="certification-date-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>–°–ª–µ–¥. –æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏–µ</label>
                    <input type="date" class="next-certification-date-input">
                </div>
                <div>
                    <button type="button" class="btn-remove" onclick="removeSerialNumberRow(this)">‚ùå</button>
                </div>
            `;
            
            container.appendChild(row);
        }

        function removeSerialNumberRow(button) {
            button.closest('.serial-row').remove();
        }

        function openOperationModal(productId, productName, currentStock, unit) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ
            currentOperationProduct = { id: productId, name: productName, currentStock, unit };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
            document.getElementById('operationTypeProductName').textContent = `–¢–æ–≤–∞—Ä: ${productName} (–æ—Å—Ç–∞—Ç–æ–∫: ${currentStock} ${unit})`;
            document.getElementById('operationTypeModal').style.display = 'block';
        }
        
        function closeOperationTypeModal() {
            document.getElementById('operationTypeModal').style.display = 'none';
            currentOperationProduct = null;
        }
        
        function selectOperationType(type) {
            if (!currentOperationProduct) {
                console.error('currentOperationProduct is null');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const product = currentOperationProduct;
            
            closeOperationTypeModal();
            
            if (type === 'incoming') {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
                openIncomingOperationModal(product.id, product.name, product.unit);
            } else if (type === 'inventory') {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
                openInventoryModal(product.id, product.name, product.currentStock, product.unit);
            }
        }
        
        function openIncomingOperationModal(productId, productName, unit) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
            currentEditingProduct = { id: productId, isIncoming: true };
            
            // –í–ê–ñ–ù–û: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentOperationProduct –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã
            currentOperationProduct = { id: productId, name: productName, unit: unit };
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞
            document.getElementById('productModalTitle').textContent = `–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: ${productName}`;
            document.getElementById('saveProductBtn').textContent = 'üíæ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ';
            document.getElementById('productForm').reset();
            document.getElementById('productModalErrorMessage').style.display = 'none';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è
            document.getElementById('productName').value = productName;
            document.getElementById('productUnit').value = unit;
            
            // –î–µ–ª–∞–µ–º –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
            document.getElementById('productName').readOnly = true;
            document.getElementById('productUnit').readOnly = true;
            
            // –°–±—Ä–æ—Å –∫ —Ä—É—á–Ω–æ–º—É –≤–≤–æ–¥—É –±–∞–ª–ª–æ–Ω–æ–≤
            const manualRadio = document.querySelector('input[name="productInputMethod"][value="manual"]');
            if (manualRadio) {
                manualRadio.checked = true;
                switchProductInputMethod();
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –≤–≤–æ–¥–∞ –±–∞–ª–ª–æ–Ω–∞
            const container = document.getElementById('productSerialNumbersContainer');
            container.innerHTML = `
                <div class="serial-row">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <input type="text" placeholder="–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞" class="product-serial-input" style="flex: 2;">
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <small style="color: #666; font-size: 11px; margin-bottom: 2px;">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</small>
                            <input type="text" placeholder="MM / YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace;" maxlength="7">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <small style="color: #666; font-size: 11px; margin-bottom: 2px;">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è</small>
                            <input type="text" placeholder="MM / YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <small style="color: #666; font-size: 11px; margin-bottom: 2px;">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞</small>
                            <input type="text" placeholder="MM / YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace;" maxlength="7">
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeSerialNumberRow(this)" style="width: 40px; height: 40px;">‚úñ</button>
                    </div>
                </div>
            `;
            
            document.getElementById('productModal').style.display = 'block';
        }

        function closeOperationModal() {
            document.getElementById('operationModal').style.display = 'none';
            currentOperationProduct = null;
            hideModalMessages('operation');
        }

        function openHistoryModal(productId, productName) {
            console.log('Opening history modal for product:', productId, productName);
            document.getElementById('historyModalTitle').textContent = `–ò—Å—Ç–æ—Ä–∏—è: ${productName || '—Ç–æ–≤–∞—Ä–∞'}`;
            loadTransactionHistory(productId);
            document.getElementById('historyModal').style.display = 'block';
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.openHistoryModal = openHistoryModal;

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
        window.closeHistoryModal = closeHistoryModal;

        function updateOperationForm() {
            const operationType = document.getElementById('operationType').value;
            const clientField = document.getElementById('clientField');
            
            if (operationType === 'OUTGOING') {
                clientField.style.display = 'block';
            } else {
                clientField.style.display = 'none';
            }
        }

        function hideModalMessages(modalType) {
            const errorEl = document.getElementById(modalType + 'ModalErrorMessage');
            if (errorEl) errorEl.style.display = 'none';
        }

        function showModalMessage(modalType, message, isError = false) {
            const errorEl = document.getElementById(modalType + 'ModalErrorMessage');
            
            if (errorEl && isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            } else if (errorEl) {
                errorEl.style.display = 'none';
            }
        }

        // Removed duplicate productForm handler - using enhanced version below

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        document.getElementById('operationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentOperationProduct) return;
            
            const operationType = document.getElementById('operationType').value;
            const quantity = parseFloat(document.getElementById('operationQuantity').value);
            const reason = document.getElementById('operationReason').value.trim();
            const clientId = document.getElementById('operationClient').value || undefined;

            if (!operationType || isNaN(quantity) || quantity <= 0) {
                showModalMessage('operation', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', true);
                return;
            }

            if (operationType === 'OUTGOING' && quantity > currentOperationProduct.currentStock) {
                showModalMessage('operation', `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ! –î–æ—Å—Ç—É–ø–Ω–æ: ${currentOperationProduct.currentStock} ${currentOperationProduct.unit}`, true);
                return;
            }

            try {
                const executeBtn = document.getElementById('executeOperationBtn');
                executeBtn.innerHTML = '<div class="loading"></div>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...';
                executeBtn.disabled = true;

                await API.createTransaction({
                    productId: currentOperationProduct.id,
                    type: operationType,
                    quantity: quantity,
                    reason: reason,
                    clientId: clientId
                });

                showTabMessage('warehouse', '–û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!');
                closeOperationModal();
                loadWarehouse(currentPage);
                loadStats();
                
                // –û–±–Ω–æ–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
                const productsTab = document.getElementById('productsTab');
                if (productsTab && productsTab.classList.contains('active')) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                }
                
                // –û–±–Ω–æ–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É –æ–ø–µ—Ä–∞—Ü–∏–π –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
                const transactionsTab = document.getElementById('transactionsTab');
                if (transactionsTab && transactionsTab.classList.contains('active')) {
                    loadTransactions(currentTransactionsPage);
                }

            } catch (error) {
                showModalMessage('operation', APIHelpers.formatError(error), true);
            } finally {
                const executeBtn = document.getElementById('executeOperationBtn');
                executeBtn.textContent = '–í—ã–ø–æ–ª–Ω–∏—Ç—å';
                executeBtn.disabled = false;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å –±–∞–ª–ª–æ–Ω–∞–º–∏
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (window.isEditMode && window.editProductId) {
                await saveEditedProduct(window.editProductId);
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
            const isIncomingOperation = document.getElementById('productName').readOnly;
            
            if (isIncomingOperation && currentOperationProduct) {
                // –≠—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å –±–∞–ª–ª–æ–Ω–∞–º–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
                const serialNumbers = [];
                
                try {
                    document.querySelectorAll('.serial-row').forEach((row, index) => {
                    const serialNumberInput = row.querySelector('.product-serial-input');
                    const manufactureDateInput = row.querySelector('.product-manufacture-date');
                    const certificationDateInput = row.querySelector('.product-cert-date');
                    const nextCertificationDateInput = row.querySelector('.product-next-cert-date');

                    if (!serialNumberInput) return;

                    const serialNumber = serialNumberInput.value.trim();
                    const manufactureDate = manufactureDateInput ? manufactureDateInput.value.trim() : '';
                    const certificationDate = certificationDateInput ? certificationDateInput.value.trim() : '';
                    const nextCertificationDate = nextCertificationDateInput ? nextCertificationDateInput.value.trim() : '';

                    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                    if (!serialNumber) {
                        throw new Error(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`);
                    }
                    
                    if (!manufactureDate) {
                        throw new Error(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`);
                    }
                    
                    if (!certificationDate) {
                        throw new Error(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`);
                    }
                    
                    if (!nextCertificationDate) {
                        throw new Error(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`);
                    }

                    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç (MM/YYYY)
                    const datePattern = /^(0[1-9]|1[0-2])\/\d{4}$/;
                    
                    if (!datePattern.test(manufactureDate)) {
                        throw new Error(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è "${manufactureDate}". –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MM/YYYY`);
                    }
                    
                    if (!datePattern.test(certificationDate)) {
                        throw new Error(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è "${certificationDate}". –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MM/YYYY`);
                    }
                    
                    if (!datePattern.test(nextCertificationDate)) {
                        throw new Error(`–°—Ç—Ä–æ–∫–∞ ${index + 1}: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–ª–µ–¥—É—é—â–µ–π –¥–∞—Ç—ã –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è "${nextCertificationDate}". –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MM/YYYY`);
                    }

                    serialNumbers.push({
                        serialNumber,
                        manufactureDate,
                        certificationDate,
                        nextCertificationDate
                    });
                    });

                    if (serialNumbers.length === 0) {
                        throw new Error('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –Ω–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞');
                    }
                } catch (validationError) {
                    showModalMessage('product', validationError.message, true);
                    return;
                }

                try {
                    const saveBtn = document.getElementById('saveProductBtn');
                    saveBtn.innerHTML = '<div class="loading"></div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                    saveBtn.disabled = true;

                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
                    await API.createSerialNumbers({
                        productId: currentOperationProduct.id,
                        serialNumbers: serialNumbers
                    });

                    // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
                    await API.createTransaction({
                        productId: currentOperationProduct.id,
                        type: 'INCOMING',
                        quantity: serialNumbers.length,
                        reason: '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–Ω–æ–≤'
                    });

                    showToast(`–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! –î–æ–±–∞–≤–ª–µ–Ω–æ ${serialNumbers.length} –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤.`);
                showTabMessage('warehouse', `–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! –î–æ–±–∞–≤–ª–µ–Ω–æ ${serialNumbers.length} –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤.`);
                    closeProductModal();
                    loadWarehouse(currentPage);
                    loadStats();

                } catch (error) {
                    showModalMessage('product', APIHelpers.formatError(error), true);
                } finally {
                    const saveBtn = document.getElementById('saveProductBtn');
                    saveBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
                    saveBtn.disabled = false;
                }
                return;
            }

            // –û–±—ã—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
            const purchasePrice = parseFloat(document.getElementById('productPurchasePrice').value) || 0;
            const productData = {
                name: document.getElementById('productName').value.trim(),
                unit: document.getElementById('productUnit').value,
                minQuantity: parseInt(document.getElementById('productMinStock').value) || 0,
                supplier: document.getElementById('productSupplier').value.trim() || '',
                category: document.getElementById('productCategory').value.trim() || '',
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                purchasePrice: purchasePrice,
                price: purchasePrice * 1.3, // –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ —Å –Ω–∞—Ü–µ–Ω–∫–æ–π 30%
                quantity: 0, // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –ø–æ–¥—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–Ω–æ–≤
                code: undefined,
                location: undefined,
                description: undefined
            };

            const serialNumbers = [];
            
            document.querySelectorAll('.serial-row').forEach(row => {
                const serialNumberInput = row.querySelector('.product-serial-input');
                const manufactureDateInput = row.querySelector('.product-manufacture-date');
                const certificationDateInput = row.querySelector('.product-cert-date');
                const nextCertificationDateInput = row.querySelector('.product-next-cert-date');

                if (!serialNumberInput) return;

                const serialNumber = serialNumberInput.value.trim();
                const manufactureDate = manufactureDateInput ? manufactureDateInput.value : '';
                const certificationDate = certificationDateInput ? certificationDateInput.value : '';
                const nextCertificationDate = nextCertificationDateInput ? nextCertificationDateInput.value : '';

                if (serialNumber) {
                    serialNumbers.push({
                        serialNumber,
                        manufactureDate: manufactureDate || undefined,
                        certificationDate: certificationDate || undefined,
                        nextCertificationDate: nextCertificationDate || undefined
                    });
                }
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ —Ä–∞–≤–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±–∞–ª–ª–æ–Ω–æ–≤
            if (serialNumbers.length > 0) {
                productData.quantity = serialNumbers.length;
            }

            if (!productData.name) {
                showModalMessage('product', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', true);
                return;
            }

            try {
                const saveBtn = document.getElementById('saveProductBtn');
                saveBtn.innerHTML = '<div class="loading"></div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                saveBtn.disabled = true;

                const product = await API.createProduct(productData);
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (serialNumbers.length > 0) {
                    await API.createSerialNumbers({
                        productId: product.id,
                        serialNumbers: serialNumbers
                    });
                }
                
                // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ quantity —É–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π
                
                showToast(`–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! ${serialNumbers.length > 0 ? `–î–æ–±–∞–≤–ª–µ–Ω–æ ${serialNumbers.length} –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤.` : ''}`);
                showTabMessage('warehouse', `–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! ${serialNumbers.length > 0 ? `–î–æ–±–∞–≤–ª–µ–Ω–æ ${serialNumbers.length} –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤.` : ''}`);
                closeProductModal();
                loadWarehouse(currentPage);
                loadStats();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                const transactionsTab = document.getElementById('transactionsTab');
                if (transactionsTab && transactionsTab.classList.contains('active')) {
                    loadTransactions(currentTransactionsPage);
                }

            } catch (error) {
                showModalMessage('product', APIHelpers.formatError(error), true);
            } finally {
                const saveBtn = document.getElementById('saveProductBtn');
                saveBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
                saveBtn.disabled = false;
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞
        async function loadTransactionHistory(productId) {
            console.log('Loading transaction history for productId:', productId);
            try {
                const historyContainer = document.getElementById('transactionHistory');
                if (!historyContainer) {
                    console.error('History container not found');
                    return;
                }
                
                APIHelpers.showLoading(historyContainer, '–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...');

                
                let response;
                try {
                    // –í—Ä–µ–º–µ–Ω–Ω–æ –¥–µ–ª–∞–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –º–∏–Ω—É—è API wrapper
                    const directResponse = await fetch(`http://localhost:8081/api/products/${productId}/transactions?limit=50`);
                    response = await directResponse.json();
                    
                    // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    const apiResponse = await API.getProductTransactions(productId, { limit: 50 });
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ API wrapper –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                    if (apiResponse && apiResponse.status === 'OK' && apiResponse.data) {
                    } else if (apiResponse && apiResponse.transactions) {
                        response = apiResponse;
                    }
                    
                } catch (apiError) {
                    console.error('API call failed:', apiError);
                    throw apiError;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ transactions –≤ –æ—Ç–≤–µ—Ç–µ
                if (!response || !response.transactions) {
                    console.error('Invalid response format:', response);
                    APIHelpers.showEmpty(historyContainer, '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö');
                    return;
                }
                
                if (response.transactions.length === 0) {
                    APIHelpers.showEmpty(historyContainer, '–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞');
                    return;
                }

                const typeLabels = {
                    'INCOMING': 'üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ',
                    'OUTGOING': 'üì§ –û—Ç–≥—Ä—É–∑–∫–∞',
                    'SHIPMENT': 'üì¶ –û—Ç–≥—Ä—É–∑–∫–∞ –ø–æ –∑–∞—è–≤–∫–µ',
                    'INVENTORY': 'üìã –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è'
                };

                historyContainer.innerHTML = response.transactions.map(transaction => {
                    const typeClass = transaction.type === 'SHIPMENT' ? 'outgoing' : transaction.type.toLowerCase();
                    const date = APIHelpers.formatDateTime(transaction.createdAt);
                    const quantityChange = transaction.quantity > 0 ? `+${transaction.quantity}` : transaction.quantity;
                    
                    return `
                        <div class="transaction-item ${typeClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>${typeLabels[transaction.type] || transaction.type}</strong>
                                <small>${date}</small>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <div>
                                    <strong style="font-size: 16px; color: ${transaction.quantity > 0 ? '#28a745' : '#dc3545'};">
                                        ${quantityChange} —à—Ç
                                    </strong>
                                </div>
                                <div style="text-align: right; color: #6c757d;">
                                    ${transaction.oldQuantity} ‚Üí ${transaction.newQuantity}
                                </div>
                            </div>
                            
                            ${transaction.cylinderNumbers && transaction.cylinderNumbers.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                                    <strong>${transaction.type === 'INVENTORY' ? '–ë–∞–ª–ª–æ–Ω—ã –Ω–∞ —Å–∫–ª–∞–¥–µ:' : '–ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤:'}</strong>
                                    <div style="margin-top: 5px;">
                                        ${transaction.cylinderNumbers.map(num => `
                                            <span style="display: inline-block; padding: 2px 8px; margin: 2px; background-color: #28a745; color: white; border-radius: 3px;">
                                                ${typeof num === 'object' ? num.cylinderNumber : num}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${transaction.missingCylinderNumbers && transaction.missingCylinderNumbers.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background-color: #fff5f5; border-radius: 5px; border-left: 4px solid #dc3545;">
                                    <strong style="color: #dc3545;">–°–ø–∏—Å–∞–Ω–Ω—ã–µ –±–∞–ª–ª–æ–Ω—ã:</strong>
                                    <div style="margin-top: 5px;">
                                        ${transaction.missingCylinderNumbers.map(num => `
                                            <span style="display: inline-block; padding: 2px 8px; margin: 2px; background-color: #dc3545; color: white; border-radius: 3px;">
                                                ${typeof num === 'object' ? num.cylinderNumber : num}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${transaction.orderNumber ? `
                                <div style="margin-top: 5px;">
                                    <strong>–ó–∞—è–≤–∫–∞:</strong> ‚Ññ${transaction.orderNumber}
                                </div>
                            ` : ''}
                            
                            ${transaction.reason ? `
                                <div style="margin-top: 5px;">
                                    <strong>–û—Å–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${transaction.reason}
                                </div>
                            ` : ''}
                            
                            ${transaction.clientId ? `
                                <div style="margin-top: 5px;">
                                    <strong>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</strong> ${transaction.clientName || 'ID: ' + transaction.clientId}
                                </div>
                            ` : ''}
                            
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; color: #6c757d; font-size: 12px;">
                                <strong>–í—ã–ø–æ–ª–Ω–∏–ª:</strong> ${transaction.createdBy || '–°–∏—Å—Ç–µ–º–∞'}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading transaction history:', error);
                const historyContainer = document.getElementById('transactionHistory');
                if (historyContainer) {
                    historyContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #dc3545;">
                            <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</p>
                            <small>${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</small>
                        </div>
                    `;
                }
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function editProduct(productId) {
            try {
                // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
                const product = await API.getProduct(productId);
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–µ–ø–µ—Ä—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ)
                await showEditProductModal(product);
                
            } catch (error) {
                console.error('Error loading product for edit:', error);
                showTabMessage('warehouse', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞: ' + (error.message || error), false);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
        async function showEditProductModal(product) {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥–∏ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            window.isEditMode = true;
            window.editProductId = product.id;
            
            // –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('productModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é —Å –Ω–æ–º–µ—Ä–∞–º–∏ –±–∞–ª–ª–æ–Ω–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const serialNumbersSection = document.querySelector('.section:nth-child(2)');
            if (serialNumbersSection) {
                serialNumbersSection.style.display = 'block';
            }
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤
            await loadExistingSerialNumbers(product.id);
            
            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productUnit').value = product.unit || '—à—Ç';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productMinStock').value = product.minQuantity || 0;
            document.getElementById('productPurchasePrice').value = product.purchasePrice || 0;
            document.getElementById('productCategory').value = product.category || '';
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –¥–ª—è —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏
            const priceField = document.getElementById('productPrice');
            if (priceField) {
                priceField.value = product.price || 0;
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
            const descriptionField = document.getElementById('productDescription');
            if (descriptionField) {
                descriptionField.value = product.description || '';
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ –¥–ª—è –ª–æ–∫–∞—Ü–∏–∏
            const locationField = document.getElementById('productLocation');
            if (locationField) {
                locationField.value = product.location || '';
            }
            
            // –ò–∑–º–µ–Ω–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveBtn = document.getElementById('saveProductBtn');
            saveBtn.textContent = '–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            
            // –û—á–∏—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
            document.getElementById('productModalErrorMessage').style.display = 'none';
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('productModal').style.display = 'block';
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadExistingSerialNumbers(productId) {
            try {
                console.log('Loading existing serial numbers for product:', productId);
                
                // –ü–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤
                const response = await API.getSerialNumbers(productId);
                const existingSerialNumbers = response.serialNumbers || [];
                
                console.log('Existing serial numbers:', existingSerialNumbers);
                
                // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                const container = document.getElementById('productSerialNumbersContainer');
                container.innerHTML = '';
                
                // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.querySelector('input[name="productInputMethod"][value="manual"]').checked = true;
                switchProductInputMethod();
                
                if (existingSerialNumbers.length === 0) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤, –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                    addProductSerialRow();
                } else {
                    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    existingSerialNumbers.forEach((serial, index) => {
                        const row = createProductSerialRow();
                        
                        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–º–∏
                        const inputs = row.querySelectorAll('input');
                        if (inputs[0]) inputs[0].value = serial.serialNumber || '';
                        if (inputs[1]) inputs[1].value = serial.manufactureDate || '';
                        if (inputs[2]) inputs[2].value = serial.certificationDate || '';
                        if (inputs[3]) inputs[3].value = serial.nextCertificationDate || '';
                        
                        // –î–æ–±–∞–≤–∏—Ç—å data-attribute –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
                        row.setAttribute('data-serial-id', serial.id);
                        row.setAttribute('data-existing', 'true');
                        
                        container.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error('Error loading existing serial numbers:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
                addProductSerialRow();
            }
        }

        // –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
        function createProductSerialRow() {
            const row = document.createElement('div');
            row.className = 'serial-row';
            row.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 2; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ *</small>
                        <input type="text" placeholder="–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞" class="product-serial-input" style="height: 33px;" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-manufacture-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 50px;">
                        <small style="color: #666; font-size: 11px; margin-bottom: 2px; height: 15px;">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ *</small>
                        <input type="text" placeholder="MM/YYYY" class="product-next-cert-date date-input" style="text-align: center; font-family: monospace; height: 33px;" maxlength="7" title="–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM/YYYY" required>
                    </div>
                    <div style="display: flex; align-items: flex-end; min-height: 50px;">
                        <button type="button" class="btn btn-danger" onclick="removeProductSerialRow(this)" style="padding: 8px; height: 33px;">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            return row;
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä
        async function saveEditedProduct(productId) {
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                if (!window.isEditMode || !window.editProductId) {
                    console.error('saveEditedProduct called but not in edit mode');
                    return;
                }
                
                showTabLoading('warehouse', true);
                
                const formData = {
                    name: document.getElementById('productName').value,
                    unit: document.getElementById('productUnit').value,
                    supplier: document.getElementById('productSupplier').value,
                    minQuantity: parseInt(document.getElementById('productMinStock').value) || 0,
                    purchasePrice: parseFloat(document.getElementById('productPurchasePrice').value) || 0,
                    category: document.getElementById('productCategory').value
                };
                
                // –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                const priceField = document.getElementById('productPrice');
                if (priceField) {
                    formData.price = parseFloat(priceField.value) || 0;
                }
                
                const descriptionField = document.getElementById('productDescription');
                if (descriptionField) {
                    formData.description = descriptionField.value;
                }
                
                const locationField = document.getElementById('productLocation');
                if (locationField) {
                    formData.location = locationField.value;
                }
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!formData.name || formData.name.trim().length === 0) {
                    const errorEl = document.getElementById('productModalErrorMessage');
                    errorEl.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
                    errorEl.style.display = 'block';
                    showTabLoading('warehouse', false);
                    return;
                }
                
                // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥–∏ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
                window.isEditMode = false;
                window.editProductId = null;
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                await API.updateProduct(productId, formData);
                
                // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–æ–º–µ—Ä–∞—Ö –±–∞–ª–ª–æ–Ω–æ–≤
                await processSerialNumberChanges(productId);
                
                // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeProductModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥–∞
                await loadWarehouse(currentPage);
                await loadStats();
                
                showTabMessage('warehouse', '–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                
            } catch (error) {
                console.error('Error updating product:', error);
                const errorEl = document.getElementById('productModalErrorMessage');
                errorEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ' + (error.message || error);
                errorEl.style.display = 'block';
                showTabLoading('warehouse', false);
                
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                window.isEditMode = true;
                window.editProductId = productId;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–æ–º–µ—Ä–∞—Ö –±–∞–ª–ª–æ–Ω–æ–≤ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        async function processSerialNumberChanges(productId) {
            try {
                console.log('Processing serial number changes for product:', productId);
                
                // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
                const serialRows = document.querySelectorAll('.serial-row');
                const currentSerialNumbers = [];
                
                serialRows.forEach((row, index) => {
                    const inputs = row.querySelectorAll('input');
                    const serialNumber = inputs[0]?.value?.trim();
                    const manufactureDate = inputs[1]?.value?.trim();
                    const certificationDate = inputs[2]?.value?.trim();
                    const nextCertificationDate = inputs[3]?.value?.trim();
                    
                    if (serialNumber) {
                        currentSerialNumbers.push({
                            id: row.getAttribute('data-serial-id'), // null –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
                            serialNumber,
                            manufactureDate,
                            certificationDate,
                            nextCertificationDate,
                            isExisting: row.getAttribute('data-existing') === 'true'
                        });
                    }
                });
                
                console.log('Current serial numbers from form:', currentSerialNumbers);
                
                // –ü–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
                const response = await API.getSerialNumbers(productId);
                const existingSerialNumbers = response.serialNumbers || [];
                
                console.log('Existing serial numbers from server:', existingSerialNumbers);
                
                // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                const toUpdate = [];
                const toCreate = [];
                const toDelete = [];
                
                // –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏—è
                currentSerialNumbers.forEach(current => {
                    if (current.id && current.isExisting) {
                        // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        const existing = existingSerialNumbers.find(e => e.id === current.id);
                        if (existing) {
                            if (existing.serialNumber !== current.serialNumber ||
                                existing.manufactureDate !== current.manufactureDate ||
                                existing.certificationDate !== current.certificationDate ||
                                existing.nextCertificationDate !== current.nextCertificationDate) {
                                toUpdate.push({
                                    id: current.id,
                                    ...current
                                });
                            }
                        }
                    } else {
                        // –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
                        toCreate.push({
                            productId: productId,
                            ...current
                        });
                    }
                });
                
                // –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                existingSerialNumbers.forEach(existing => {
                    const stillExists = currentSerialNumbers.find(c => c.id === existing.id);
                    if (!stillExists) {
                        toDelete.push(existing.id);
                    }
                });
                
                console.log('Changes to process:', { toUpdate, toCreate, toDelete });
                
                // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                const promises = [];
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
                toUpdate.forEach(serial => {
                    promises.push(API.updateSerialNumber(serial.id, {
                        serialNumber: serial.serialNumber,
                        manufactureDate: serial.manufactureDate,
                        certificationDate: serial.certificationDate,
                        nextCertificationDate: serial.nextCertificationDate
                    }));
                });
                
                // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏
                if (toCreate.length > 0) {
                    promises.push(API.createSerialNumbers({
                        productId: productId,
                        serialNumbers: toCreate
                    }));
                }
                
                // –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏
                toDelete.forEach(serialId => {
                    promises.push(API.deleteSerialNumber(serialId));
                });
                
                // –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                if (promises.length > 0) {
                    await Promise.all(promises);
                    console.log('Serial number changes applied successfully');
                }
                
            } catch (error) {
                console.error('Error processing serial number changes:', error);
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
                // –¢–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function deleteProduct(productId, productName) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${productName}"?`)) {
                return;
            }

            try {
                showTabLoading('warehouse', true);
                await API.deleteProduct(productId);
                showTabMessage('warehouse', '–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                loadWarehouse(currentPage);
                loadStats();
                
            } catch (error) {
                showTabMessage('warehouse', APIHelpers.formatError(error), true);
            } finally {
                showTabLoading('warehouse', false);
            }
        }

        // –ö–∞–º–µ—Ä–∞ –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –æ—Ç–≥—Ä—É–∑–∫–∏
        let cameraStream = null;
        let currentTransactionId = null;
        let capturedPhotos = [];

        async function openCameraForShipment(transactionId) {
            currentTransactionId = transactionId;
            capturedPhotos = [];
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false 
                });
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                
                document.getElementById('cameraModal').style.display = 'block';
                document.getElementById('photosPreview').innerHTML = '';
                document.querySelector('.camera-btn-save').style.display = 'none';
                
            } catch (error) {
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas –ø–æ —Ä–∞–∑–º–µ—Ä—É –≤–∏–¥–µ–æ
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // –†–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –≤–∏–¥–µ–æ –Ω–∞ canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ blob –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã–º —Ñ–æ—Ç–æ
            canvas.toBlob(blob => {
                const photoUrl = URL.createObjectURL(blob);
                capturedPhotos.push({
                    blob: blob,
                    url: photoUrl,
                    timestamp: new Date().toISOString()
                });
                
                updatePhotosPreview();
            }, 'image/jpeg', 0.8);
        }

        function updatePhotosPreview() {
            const preview = document.getElementById('photosPreview');
            
            preview.innerHTML = capturedPhotos.map((photo, index) => `
                <div class="photo-preview">
                    <img src="${photo.url}" alt="–§–æ—Ç–æ ${index + 1}">
                    <button class="photo-remove" onclick="removePhoto(${index})">√ó</button>
                </div>
            `).join('');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ
            const saveBtn = document.querySelector('.camera-btn-save');
            saveBtn.style.display = capturedPhotos.length > 0 ? 'block' : 'none';
        }

        function removePhoto(index) {
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL –æ–±—ä–µ–∫—Ç
            URL.revokeObjectURL(capturedPhotos[index].url);
            capturedPhotos.splice(index, 1);
            updatePhotosPreview();
        }

        async function savePhotos() {
            if (capturedPhotos.length === 0) {
                return;
            }

            try {
                const saveBtn = document.querySelector('.camera-btn-save');
                saveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                saveBtn.disabled = true;

                // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
                const formData = new FormData();
                
                capturedPhotos.forEach((photo, index) => {
                    formData.append('photos', photo.blob, `shipment_photo_${index + 1}.jpg`);
                });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(`${API.baseURL}/files/transaction/${currentTransactionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API.getToken()}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                
                closeCameraModal();
                loadOperations(currentOperationsPage); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
                
            } catch (error) {
            } finally {
                const saveBtn = document.querySelector('.camera-btn-save');
                saveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
                saveBtn.disabled = false;
            }
        }

        function closeCameraModal() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL –æ–±—ä–µ–∫—Ç—ã
            capturedPhotos.forEach(photo => {
                URL.revokeObjectURL(photo.url);
            });
            
            capturedPhotos = [];
            currentTransactionId = null;
            document.getElementById('cameraModal').style.display = 'none';
            document.getElementById('photosPreview').innerHTML = '';
        }



        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        window.onclick = function(event) {
            const modals = ['productModal', 'operationModal', 'historyModal', 'cameraModal', 'shipmentModal', 'operationTypeModal', 'inventoryModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'cameraModal') {
                        closeCameraModal();
                    } else {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É –¥–ª—è —Å–∫–ª–∞–¥–∞
        async function loadWarehouseOrders() {
            showTabLoading('orders', true);
            showTabMessage('orders', '');

            try {
                const response = await API.getWarehousePendingOrders();
                const container = document.getElementById('ordersTableContainer');
                
                if (response.orders.length === 0) {
                    container.innerHTML = '<div class="empty-state">üìã –ù–µ—Ç –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–≥—Ä—É–∑–∫–∏</div>';
                    return;
                }

                container.innerHTML = `
                    <table class="warehouse-table">
                        <thead>
                            <tr>
                                <th>‚Ññ –ó–∞—è–≤–∫–∏</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–¢–æ–≤–∞—Ä—ã</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${response.orders.map(order => {
                                let statusText, statusClass;
                                if (order.status === 'PAID') {
                                    statusText = '–û–ø–ª–∞—á–µ–Ω–∞';
                                    statusClass = 'paid';
                                } else if (order.status === 'FOR_SHIPMENT_UNPAID') {
                                    statusText = '–í –æ—Ç–≥—Ä—É–∑–∫—É –±–µ–∑ –æ–ø–ª–∞—Ç—ã';
                                    statusClass = 'for-shipment-unpaid';
                                } else if (order.status === 'PICKING') {
                                    statusText = '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è';
                                    statusClass = 'picking';
                                } else if (order.status === 'SHIPPED') {
                                    statusText = '–û—Ç–≥—Ä—É–∂–µ–Ω–∞';
                                    statusClass = 'shipped';
                                }
                                
                                const isShipped = order.status === 'SHIPPED';
                                const rowClick = isShipped ? `onclick="viewOrderFromWarehouse('${order.id}')" style="cursor: pointer;"` : '';
                                
                                return `
                                    <tr ${rowClick}>
                                        <td><strong>${order.number}</strong></td>
                                        <td>${order.client.name}</td>
                                        <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                                        <td>
                                            ${order.items.map(item => 
                                                `${item.product.name} - ${item.quantity} ${item.product.unit}`
                                            ).join('<br>')}
                                        </td>
                                        <td>${APIHelpers.formatCurrency(order.totalAmount)}</td>
                                        <td>${APIHelpers.formatDate(order.orderDate || order.createdAt)}</td>
                                        <td ${isShipped ? 'onclick="event.stopPropagation()"' : ''}>
                                            <div class="actions">
                                                ${!isShipped ? `<button class="btn btn-success" onclick="shipOrder('${order.id}', '${order.number}')" title="–û—Ç–≥—Ä—É–∑–∏—Ç—å">üì¶ –û—Ç–≥—Ä—É–∑–∏—Ç—å</button>` : '<span style="color: #28a745;">‚úì –û—Ç–≥—Ä—É–∂–µ–Ω–∞</span>'}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                showTabMessage('orders', APIHelpers.formatError(error), true);
            } finally {
                showTabLoading('orders', false);
            }
        }

        // –û—Ç–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–∫–∏
        async function shipOrder(orderId, orderNumber) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏
                const order = await API.getOrder(orderId);
                
                currentShippingOrder = order;
                shippingItems = [];
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞—è–≤–∫–µ
                for (const item of order.items) {
                    const serialNumbers = [];
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID —Ç–æ–≤–∞—Ä–∞ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ product –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ item
                    const productId = item.product ? item.product.id : (item.id || item.productId);
                    const productName = item.product ? item.product.name : (item.name || '–¢–æ–≤–∞—Ä');
                    
                    // –ï—Å–ª–∏ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–∞ product, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ
                    if (!item.product && productId) {
                        try {
                            const productInfo = await API.getProduct(productId);
                            item.product = productInfo;
                        } catch (error) {
                            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ:', productId);
                            // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç product
                            item.product = {
                                id: productId,
                                name: productName,
                                unit: '—à—Ç'
                            };
                        }
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å–µ—Ä–∏–π–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ–≤–∞—Ä–∞)
                    for (let i = 0; i < item.quantity; i++) {
                        serialNumbers.push({
                            serialNumber: '',
                            productId: productId,
                            productName: productName
                        });
                    }
                    
                    shippingItems.push({
                        ...item,
                        productId: productId,
                        serialNumbers: serialNumbers
                    });
                }
                
                displayShipmentForm();
                document.getElementById('shipmentModal').style.display = 'block';
                
            } catch (error) {
                showTabMessage('orders', APIHelpers.formatError(error), true);
            }
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π
        window.shipOrder = shipOrder;

        // –§—É–Ω–∫—Ü–∏—è openShipmentModal —É–±—Ä–∞–Ω–∞ - –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ shipOrder

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –æ—Ç–≥—Ä—É–∑–∫–∏
        function displayShipmentForm() {
            const content = document.getElementById('shipmentFormContent');
            
            content.innerHTML = `
                <div class="shipment-order-info">
                    <h3>–ó–∞—è–≤–∫–∞ ${currentShippingOrder.number}</h3>
                    <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${currentShippingOrder.client.name}</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> ${APIHelpers.formatDate(currentShippingOrder.orderDate || currentShippingOrder.createdAt)}</p>
                </div>
                
                <div class="shipment-items">
                    <h4>–¢–æ–≤–∞—Ä—ã –∫ –æ—Ç–≥—Ä—É–∑–∫–µ:</h4>
                    ${shippingItems.map((item, itemIndex) => `
                        <div class="shipment-item">
                            <div class="shipment-item-header">
                                <strong>${item.product ? item.product.name : (item.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä')}</strong>
                                <span class="quantity-info">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity} ${item.product ? item.product.unit : '—à—Ç'}</span>
                            </div>
                            
                            <div class="serial-numbers-section">
                                <h5>–ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤:</h5>
                                ${item.serialNumbers.map((serial, serialIndex) => `
                                    <div class="serial-input-row">
                                        <label>–ë–∞–ª–ª–æ–Ω ${serialIndex + 1}:</label>
                                        <input 
                                            type="text" 
                                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞"
                                            value="${serial.serialNumber}"
                                            onchange="updateSerialNumber(${itemIndex}, ${serialIndex}, this.value)"
                                            required
                                        >
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="shipment-files-section">
                    <h4>–î–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</h4>
                    <div class="file-upload-area">
                        <input type="file" id="shipmentFileInput" multiple accept="image/*,application/pdf" style="display: none;" onchange="handleShipmentFiles(this)">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('shipmentFileInput').click()">
                            üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã
                        </button>
                        <p class="file-info">–ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã</p>
                    </div>
                    <div id="shipmentFilesList" class="files-preview">
                        <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–∏–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞
        async function updateSerialNumber(itemIndex, serialIndex, value) {
            const trimmedValue = value.trim();
            
            if (!trimmedValue) {
                shippingItems[itemIndex].serialNumbers[serialIndex].serialNumber = '';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–∞
            const currentProductId = shippingItems[itemIndex].productId;
            const validationResult = await validateCylinderNumber(trimmedValue, currentProductId);
            
            if (!validationResult.isValid) {
                // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –∏ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
                alert(`–û—à–∏–±–∫–∞: ${validationResult.message}`);
                // –ù–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π input –∏ –æ—á–∏—Å—Ç–∏—Ç—å –µ–≥–æ
                const inputs = document.querySelectorAll(`input[onchange*="updateSerialNumber(${itemIndex}, ${serialIndex}"]`);
                if (inputs.length > 0) {
                    inputs[0].value = '';
                }
                shippingItems[itemIndex].serialNumbers[serialIndex].serialNumber = '';
                return;
            }
            
            shippingItems[itemIndex].serialNumbers[serialIndex].serialNumber = trimmedValue;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–∞
        async function validateCylinderNumber(cylinderNumber, currentProductId) {
            try {
                console.log('Validating cylinder:', cylinderNumber, 'for product:', currentProductId);
                
                // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–∞
                if (cylinderNumber.length < 3) {
                    return {
                        isValid: false,
                        message: '–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤'
                    };
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–æ–≤–∞—Ä–∞
                const serialResponse = await API.getSerialNumbers(currentProductId);
                const serialNumbers = serialResponse.serialNumbers || [];
                
                console.log('Serial numbers found:', serialNumbers.length);
                
                // –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ (–¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –æ—Ç–≥—Ä—É–∑–∫–∏)
                const availableSerials = serialNumbers.filter(serial => serial.status === 'active');
                console.log('Available active serials:', availableSerials.map(s => s.serialNumber));
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö
                const foundSerial = availableSerials.find(serial => serial.serialNumber === cylinderNumber);
                
                if (!foundSerial) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –Ω–æ–º–µ—Ä –≤–æ–æ–±—â–µ –Ω–æ —Å –¥—Ä—É–≥–∏–º —Å—Ç–∞—Ç—É—Å–æ–º
                    const existingSerial = serialNumbers.find(serial => serial.serialNumber === cylinderNumber);
                    
                    if (existingSerial) {
                        if (existingSerial.status === 'shipped') {
                            return {
                                isValid: false,
                                message: `–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ ${cylinderNumber} —É–∂–µ –±—ã–ª –æ—Ç–≥—Ä—É–∂–µ–Ω`
                            };
                        } else if (existingSerial.status === 'lost') {
                            return {
                                isValid: false,
                                message: `–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ ${cylinderNumber} —Å–ø–∏—Å–∞–Ω`
                            };
                        } else {
                            return {
                                isValid: false,
                                message: `–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ ${cylinderNumber} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—Å—Ç–∞—Ç—É—Å: ${existingSerial.status})`
                            };
                        }
                    } else {
                        return {
                            isValid: false,
                            message: `–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ ${cylinderNumber} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Å—Ç–∞—Ç–∫–∞—Ö —Ç–æ–≤–∞—Ä–∞`
                        };
                    }
                }
                
                console.log('Cylinder validation passed for:', cylinderNumber);
                return {
                    isValid: true,
                    message: '–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–µ–Ω'
                };
                
            } catch (error) {
                console.error('Error validating cylinder number:', error);
                return {
                    isValid: false,
                    message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'
                };
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        function handleShipmentFiles(input) {
            const files = Array.from(input.files);
            shipmentFiles = files;
            
            const filesList = document.getElementById('shipmentFilesList');
            
            if (files.length === 0) {
                filesList.innerHTML = '<p class="no-files-text">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>';
                return;
            }
            
            filesList.innerHTML = files.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                const fileUrl = URL.createObjectURL(file);
                
                return `
                    <div class="file-preview-item">
                        <div class="file-preview-content">
                            ${isImage ? `
                                <div class="image-preview">
                                    <img src="${fileUrl}" alt="${file.name}" onclick="openImagePreview('${fileUrl}', '${file.name}')">
                                </div>
                            ` : `
                                <div class="file-icon">
                                    üìÑ
                                </div>
                            `}
                            <div class="file-details">
                                <div class="file-name" title="${file.name}">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                                <div class="file-type">${file.type || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø'}</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeShipmentFile(${index})" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function openImagePreview(imageUrl, fileName) {
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            modal.innerHTML = `
                <div class="image-preview-content">
                    <div class="image-preview-header">
                        <h3>${fileName}</h3>
                        <button class="close-preview" onclick="closeImagePreview()">&times;</button>
                    </div>
                    <div class="image-preview-body">
                        <img src="${imageUrl}" alt="${fileName}">
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeImagePreview();
                }
            };
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function closeImagePreview() {
            const modal = document.querySelector('.image-preview-modal');
            if (modal) {
                modal.remove();
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        function removeShipmentFile(index) {
            shipmentFiles.splice(index, 1);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º input —Ñ–∞–π–ª–æ–≤
            const input = document.getElementById('shipmentFileInput');
            const dt = new DataTransfer();
            shipmentFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;
            
            handleShipmentFiles(input);
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–≥—Ä—É–∑–∫–∏
        async function executeShipment() {
            try {
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤
                for (const item of shippingItems) {
                    for (const serial of item.serialNumbers) {
                        if (!serial.serialNumber) {
                            alert('–í—Å–µ –ø–æ–ª—è –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
                            return;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∂–¥—ã–π –Ω–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞
                        const validationResult = await validateCylinderNumber(serial.serialNumber, item.productId);
                        if (!validationResult.isValid) {
                            console.error(`Validation failed for cylinder ${serial.serialNumber}, product ID: ${item.productId}`);
                            alert(`–û—à–∏–±–∫–∞: ${validationResult.message}\n\n–ü—Ä–æ–¥—É–∫—Ç ID: ${item.productId}\n–ù–æ–º–µ—Ä –±–∞–ª–ª–æ–Ω–∞: ${serial.serialNumber}`);
                            return;
                        }
                    }
                }

                showTabMessage('orders', '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–≥—Ä—É–∑–∫–∞...', false);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å
                let uploadedFiles = [];
                if (shipmentFiles.length > 0) {
                    const fileResponse = await API.uploadFiles(shipmentFiles, currentShippingOrder.id, 'ORDER');
                    uploadedFiles = fileResponse.files;
                }

                // –°–æ–∑–¥–∞–µ–º –æ—Ç–≥—Ä—É–∑–∫—É —Å —Å–µ—Ä–∏–π–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
                const shipmentData = {
                    items: shippingItems.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity,
                        serialNumbers: item.serialNumbers.map(sn => sn.serialNumber)
                    })),
                    fileIds: uploadedFiles.map(f => f.id),
                    notes: null
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                const orderNumber = currentShippingOrder.number;
                
                // –°–æ–∑–¥–∞–µ–º –æ—Ç–≥—Ä—É–∑–∫—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏)
                await API.createShipment(currentShippingOrder.id, shipmentData);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                closeShipmentModal();
                
                showTabMessage('orders', `–ó–∞—è–≤–∫–∞ ${orderNumber} —É—Å–ø–µ—à–Ω–æ –æ—Ç–≥—Ä—É–∂–µ–Ω–∞!`);
                loadWarehouseOrders();
                
                const warehouseTab = document.getElementById('warehouseTab');
                if (warehouseTab && warehouseTab.classList.contains('active')) {
                    loadWarehouse();
                }
                
                // –û–±–Ω–æ–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
                const productsTab = document.getElementById('productsTab');
                if (productsTab && productsTab.classList.contains('active')) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                }
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
                loadStats();
                const transactionsTab = document.getElementById('transactionsTab');
                if (transactionsTab && transactionsTab.classList.contains('active')) {
                    loadTransactions(currentTransactionsPage);
                }

            } catch (error) {
                showTabMessage('orders', APIHelpers.formatError(error), true);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ç–≥—Ä—É–∑–∫–∏
        function closeShipmentModal() {
            document.getElementById('shipmentModal').style.display = 'none';
            currentShippingOrder = null;
            shippingItems = [];
            shipmentFiles = [];
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–∫–ª–∞–¥–∞
        function viewOrderFromWarehouse(orderId) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∑–∞—è–≤–∫—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ orders.html
            window.open(`orders.html?view=${orderId}`, '_blank');
        }

        // Enhanced pagination helper functions
        function updateSuppliersDropdown(suppliers) {
            const supplierFilter = document.getElementById('supplierFilter');
            const currentValue = supplierFilter.value;
            
            // Clear existing options except the first one
            supplierFilter.innerHTML = '<option value="">–í—Å–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏</option>';
            
            if (suppliers && suppliers.length > 0) {
                suppliers.forEach(supplier => {
                    if (supplier) {
                        const option = document.createElement('option');
                        option.value = supplier;
                        option.textContent = supplier;
                        if (supplier === currentValue) {
                            option.selected = true;
                        }
                        supplierFilter.appendChild(option);
                    }
                });
            }
        }

        function updatePaginationInfo(pagination) {
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo && pagination) {
                const start = (pagination.page - 1) * pagination.limit + 1;
                const end = Math.min(pagination.page * pagination.limit, pagination.total);
                paginationInfo.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${start}-${end} –∏–∑ ${pagination.total}`;
            }
        }

        function updateSortIndicators(sortField, sortOrder) {
            // Reset all sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
                indicator.textContent = '‚Üï';
            });

            // Update the active sort indicator
            const activeTh = document.querySelector(`th[data-sort="${sortField}"] .sort-indicator`);
            if (activeTh) {
                activeTh.className = `sort-indicator ${sortOrder.toLowerCase()}`;
                activeTh.textContent = sortOrder === 'ASC' ? '‚Üë' : '‚Üì';
            }
        }

        function handleTableHeaderClick(event) {
            const th = event.target.closest('th.sortable');
            if (th) {
                const sortField = th.dataset.sort;
                const currentSortField = document.getElementById('sortField').value;
                const currentSortOrder = document.getElementById('sortOrder').value;
                
                let newSortOrder = 'ASC';
                if (sortField === currentSortField && currentSortOrder === 'ASC') {
                    newSortOrder = 'DESC';
                }
                
                document.getElementById('sortField').value = sortField;
                document.getElementById('sortOrder').value = newSortOrder;
                
                loadWarehouse(1); // Reset to first page when sorting
            }
        }

        function handleWarehouseSorting() {
            loadWarehouse(1); // Reset to first page when changing sort
        }

        function handlePageSizeChange() {
            loadWarehouse(1); // Reset to first page when changing page size
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
        async function openProductCard(productId) {
            try {
                const product = await API.getProduct(productId);
                const user = APIHelpers.getCurrentUser();
                const isAdmin = user && user.role === 'admin';
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤
                let serialNumbers = [];
                try {
                    const serialResponse = await API.getSerialNumbers(productId);
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –±–∞–ª–ª–æ–Ω—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
                    serialNumbers = (serialResponse.serialNumbers || []).filter(serial => serial.status === 'active');
                } catch (serialError) {
                    console.warn('Could not load serial numbers for product:', serialError);
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
                const cardModal = document.createElement('div');
                cardModal.className = 'modal';
                cardModal.style.display = 'block';
                cardModal.id = 'productCardModal';
                
                cardModal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 style="font-size: 18px;">–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞: ${product.name}</h2>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-primary" onclick="openOperationModal('${product.id}', '${product.name}', ${product.quantity || 0}, '${product.unit || '—à—Ç'}')">–û–ø–µ—Ä–∞—Ü–∏–∏</button>
                                <button class="btn btn-edit" onclick="editProduct('${product.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                ${isAdmin ? `<button class="btn btn-danger" onclick="deleteProduct('${product.id}', '${product.name}')">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                                <button class="btn btn-secondary" onclick="openHistoryModal('${product.id}', \`${product.name || ''}\`)">–ò—Å—Ç–æ—Ä–∏—è</button>
                                <span class="close" onclick="closeProductCard()">&times;</span>
                            </div>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                <div>
                                    <h3 style="color: #667eea; margin-bottom: 15px;">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                                    <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${product.name}</p>
                                    <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> ${product.sku || '-'}</p>
                                    <p><strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> ${product.supplier || '-'}</p>
                                    <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${product.category || '-'}</p>
                                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${product.description || '-'}</p>
                                    <p><strong>–ó–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞:</strong> ${APIHelpers.formatCurrency(product.purchasePrice)} | <strong>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏:</strong> ${APIHelpers.formatCurrency(product.price)}</p>
                                </div>
                                <div>
                                    <h3 style="color: #667eea; margin-bottom: 15px;">–°–∫–ª–∞–¥—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                                    <p><strong>–û—Å—Ç–∞—Ç–æ–∫:</strong> <span style="color: ${product.quantity > 0 ? '#28a745' : '#dc3545'};">${product.quantity || 0} ${product.unit || '—à—Ç'}</span></p>
                                    <p><strong>–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫:</strong> ${product.minQuantity || 0} ${product.unit || '—à—Ç'}</p>
                                    <p><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> ${product.location || '-'}</p>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${product.status || 'active'}</p>
                                    <p><strong>–°–æ–∑–¥–∞–Ω:</strong> ${APIHelpers.formatDateTime(product.createdAt)} | <strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong> ${APIHelpers.formatDateTime(product.updatedAt)}</p>
                                </div>
                            </div>
                            
                            <!-- –ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">–ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ (${serialNumbers.length} —à—Ç.)</h3>
                                ${serialNumbers.length > 0 ? `
                                    <div style="display: grid; gap: 15px;">
                                        ${serialNumbers.map(serial => {
                                            const statusColor = serial.status === 'active' ? '#28a745' : serial.status === 'lost' ? '#dc3545' : '#6c757d';
                                            const statusText = serial.status === 'active' ? '–ù–∞ —Å–∫–ª–∞–¥–µ' : serial.status === 'lost' ? '–°–ø–∏—Å–∞–Ω' : serial.status;
                                            
                                            return `
                                                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid ${statusColor};">
                                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; align-items: center;">
                                                        <div>
                                                            <strong style="font-size: 16px;">${serial.serialNumber}</strong>
                                                        </div>
                                                        <div>
                                                            <small style="color: #6c757d; display: block;">–î–∞—Ç–∞ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</small>
                                                            <span>${serial.manufactureDate || '-'}</span>
                                                        </div>
                                                        <div>
                                                            <small style="color: #6c757d; display: block;">–î–∞—Ç–∞ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏—è</small>
                                                            <span>${serial.certificationDate || '-'}</span>
                                                        </div>
                                                        <div>
                                                            <small style="color: #6c757d; display: block;">–°–ª–µ–¥—É—é—â–µ–µ –ø–µ—Ä–µ–æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏–µ</small>
                                                            <span>${serial.nextCertificationDate || '-'}</span>
                                                        </div>
                                                        <div>
                                                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; background-color: ${statusColor};">
                                                                ${statusText}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">
                                        –ù–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ –Ω–µ —É–∫–∞–∑–∞–Ω—ã
                                    </p>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(cardModal);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                cardModal.addEventListener('click', function(event) {
                    if (event.target === cardModal) {
                        closeProductCard();
                    }
                });
                
            } catch (error) {
                console.error('Error opening product card:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞: ' + error.message);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
        function closeProductCard() {
            const modal = document.getElementById('productCardModal');
            if (modal) {
                modal.remove();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
        let inventoryData = null;
        
        async function openInventoryModal(productId, productName, currentStock, unit) {
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
                inventoryData = { productId, productName, currentStock, unit };
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫
                document.getElementById('inventoryModalTitle').textContent = `–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: ${productName}`;
                document.getElementById('currentInventoryStock').textContent = `${currentStock} ${unit}`;
                document.getElementById('inventoryModalErrorMessage').style.display = 'none';
                document.getElementById('inventoryReason').value = '';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–º–µ—Ä–∞ –±–∞–ª–ª–æ–Ω–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
                const serialNumbers = await API.getSerialNumbers(productId);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –±–∞–ª–ª–æ–Ω—ã –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
                const activeSerialNumbers = (serialNumbers.serialNumbers || []).filter(serial => serial.status === 'active');
                displayInventorySerialNumbers(activeSerialNumbers);
                updateFinalInventoryCount();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('inventoryModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading serial numbers:', error);
                showTabMessage('warehouse', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤: ' + (error.message || error), false);
            }
        }
        
        function displayInventorySerialNumbers(serialNumbers) {
            const container = document.getElementById('inventorySerialNumbersList');
            
            if (serialNumbers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">–ù–∞ —Å–∫–ª–∞–¥–µ –Ω–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</p>';
                return;
            }
            
            container.innerHTML = serialNumbers.map(serial => `
                <div class="inventory-serial-item" style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; border: 1px solid #dee2e6; border-radius: 6px; background-color: #f8f9fa;">
                    <label style="display: flex; align-items: center; width: 100%; cursor: pointer; margin: 0;">
                        <input type="checkbox" 
                               class="inventory-checkbox" 
                               value="${serial.serialNumber}" 
                               checked 
                               onchange="updateFinalInventoryCount()" 
                               style="margin-right: 15px; transform: scale(1.2);">
                        
                        <div style="flex: 1;">
                            <strong>${serial.serialNumber}</strong>
                            ${serial.manufactureDate ? `<br><small style="color: #6c757d;">–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω: ${serial.manufactureDate}</small>` : ''}
                            ${serial.certificationDate ? `<br><small style="color: #6c757d;">–ê—Ç—Ç–µ—Å—Ç–æ–≤–∞–Ω: ${serial.certificationDate}</small>` : ''}
                            ${serial.nextCertificationDate ? `<br><small style="color: #28a745;">–°–ª–µ–¥—É—é—â–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è: ${serial.nextCertificationDate}</small>` : ''}
                        </div>
                        
                        <span class="inventory-status" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background-color: #28a745; color: white;">
                            –ù–ê –°–ö–õ–ê–î–ï
                        </span>
                    </label>
                </div>
            `).join('');
        }
        
        function updateFinalInventoryCount() {
            const checkedBoxes = document.querySelectorAll('.inventory-checkbox:checked');
            const finalCount = checkedBoxes.length;
            const unit = inventoryData ? inventoryData.unit : '—à—Ç';
            
            document.getElementById('finalInventoryCount').textContent = `${finalCount} ${unit}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.inventory-serial-item').forEach(item => {
                const checkbox = item.querySelector('.inventory-checkbox');
                const status = item.querySelector('.inventory-status');
                
                if (checkbox.checked) {
                    status.textContent = '–ù–ê –°–ö–õ–ê–î–ï';
                    status.style.backgroundColor = '#28a745';
                    item.style.backgroundColor = '#f8f9fa';
                } else {
                    status.textContent = '–û–¢–°–£–¢–°–¢–í–£–ï–¢';
                    status.style.backgroundColor = '#dc3545';
                    item.style.backgroundColor = '#fff5f5';
                }
            });
        }
        
        async function saveInventory() {
            if (!inventoryData) return;
            
            try {
                const allCheckboxes = document.querySelectorAll('.inventory-checkbox');
                const checkedBoxes = document.querySelectorAll('.inventory-checkbox:checked');
                const uncheckedBoxes = document.querySelectorAll('.inventory-checkbox:not(:checked)');
                
                const finalCount = checkedBoxes.length;
                const currentStock = inventoryData.currentStock;
                const difference = finalCount - currentStock;
                
                if (difference === 0) {
                    showInventoryError('–û—Å—Ç–∞—Ç–æ–∫ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è. –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.');
                    return;
                }
                
                const reason = document.getElementById('inventoryReason').value.trim();
                if (!reason) {
                    showInventoryError('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–∞');
                    return;
                }
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const saveBtn = document.getElementById('saveInventoryBtn');
                saveBtn.innerHTML = '<div class="loading"></div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                saveBtn.disabled = true;
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                const presentCylinders = Array.from(checkedBoxes).map(cb => cb.value);
                const missingCylinders = Array.from(uncheckedBoxes).map(cb => cb.value);
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                let detailedReason = `${reason}. `;
                if (missingCylinders.length > 0) {
                    detailedReason += `–°–ø–∏—Å–∞–Ω—ã –±–∞–ª–ª–æ–Ω—ã: ${missingCylinders.join(', ')}. `;
                }
                if (presentCylinders.length > 0) {
                    detailedReason += `–û—Å—Ç–∞–ª–∏—Å—å –Ω–∞ —Å–∫–ª–∞–¥–µ: ${presentCylinders.join(', ')}.`;
                }
                
                // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
                await API.createTransaction({
                    productId: inventoryData.productId,
                    type: 'INVENTORY',
                    quantity: finalCount, // –ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏
                    reason: detailedReason,
                    cylinderNumbers: presentCylinders, // –ë–∞–ª–ª–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–ª–∏—Å—å
                    missingCylinderNumbers: missingCylinders // –ë–∞–ª–ª–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–ø–∏—Å–∞–Ω—ã
                });
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –±–∞–ª–ª–æ–Ω–æ–≤
                if (missingCylinders.length > 0) {
                    try {
                        await API.updateSerialNumbersStatus(missingCylinders, 'lost');
                    } catch (statusError) {
                        console.warn('Could not update serial numbers status:', statusError);
                    }
                }
                
                const actionType = difference > 0 ? '–¥–æ–±–∞–≤–ª–µ–Ω' : '—Å–ø–∏—Å–∞–Ω';
                const changeDesc = missingCylinders.length > 0 ? ` (—Å–ø–∏—Å–∞–Ω—ã: ${missingCylinders.join(', ')})` : '';
                
                showToast(`–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: ${inventoryData.productName} - ${Math.abs(difference)} ${inventoryData.unit} ${actionType}${changeDesc}`);
                showTabMessage('warehouse', `–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: ${inventoryData.productName} - ${Math.abs(difference)} ${inventoryData.unit} ${actionType}${changeDesc}`);
                
                closeInventoryModal();
                loadWarehouse(currentPage);
                loadStats();
                
            } catch (error) {
                console.error('Error saving inventory:', error);
                showInventoryError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏: ' + (error.message || error));
                
                const saveBtn = document.getElementById('saveInventoryBtn');
                saveBtn.innerHTML = 'üíæ –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é';
                saveBtn.disabled = false;
            }
        }
        
        function showInventoryError(message) {
            const errorEl = document.getElementById('inventoryModalErrorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            // –¢–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showToast(message, true);
        }
        
        function showToast(message, isError = false) {
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const toast = document.createElement('div');
            toast.className = `toast-notification ${isError ? 'toast-error' : 'toast-success'}`;
            toast.textContent = message;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è toast
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isError ? '#dc3545' : '#28a745'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 350px;
                word-wrap: break-word;
            `;

            document.body.appendChild(toast);

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 4000);
        }
        
        function closeInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'none';
            inventoryData = null;
            
            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏
            const saveBtn = document.getElementById('saveInventoryBtn');
            saveBtn.innerHTML = 'üíæ –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é';
            saveBtn.disabled = false;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML
        window.openProductCard = openProductCard;
        window.closeProductCard = closeProductCard;
    </script>
</body>
</html>