<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор рентабельности - CO_LAB CRM</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-sizing: border-box;
            padding: 30px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #e1e5e9;
        }

        h1 {
            color: #333;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .user-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 12px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .dropdown-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 4px;
        }

        .user-name {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .user-email {
            color: #666;
            font-size: 12px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .dropdown-item.logout:hover {
            background-color: #fff5f5;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-right: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-weight: 600;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .section {
            margin-bottom: 30px;
            padding: 30px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        .section-icon {
            font-size: 28px;
            margin-right: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .cost-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .sales-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        .required::after {
            content: ' *';
            color: #e74c3c;
        }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .required-field {
            border-left: 4px solid #e74c3c;
        }

        .auto-calc {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%) !important;
            border: 2px solid #87ceeb !important;
            color: #4682b4;
            font-weight: 600;
            cursor: not-allowed;
        }

        .total-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .formula-display {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            border: 2px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            margin-top: 15px;
            color: #1565c0;
            line-height: 1.6;
        }

        .profit-indicator {
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 700;
            text-align: center;
            margin-top: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .profit-positive {
            background: linear-gradient(135deg, #d4edda 0%, #c8e6c9 100%);
            color: #155724;
            border: 2px solid #c3e6cb;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }

        .profit-negative {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 2px solid #f5c6cb;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
        }

        .profit-neutral {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border: 2px solid #ffeaa7;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .final-results {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid #667eea;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15);
            margin-bottom: 30px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-item:last-child {
            border-bottom: none;
            border-top: 2px solid #667eea;
            padding-top: 20px;
            margin-top: 20px;
            font-weight: 700;
            font-size: 18px;
            color: #667eea;
        }

        .currency {
            font-weight: 700;
            color: #28a745;
        }

        .action-buttons {
            text-align: center;
            margin: 40px 0;
        }

        .action-buttons .btn {
            margin: 0 10px 15px 10px;
            min-width: 200px;
            padding: 15px 30px;
            font-size: 16px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .error-message, .success-message {
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 25px;
            font-size: 14px;
            font-weight: 500;
        }

        .error-message {
            background: linear-gradient(135deg, #fee 0%, #ffebee 100%);
            border: 2px solid #f5c6cb;
            color: #721c24;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c8e6c9 100%);
            border: 2px solid #c3e6cb;
            color: #155724;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-label {
            font-weight: 500;
            color: #666;
        }

        .breakdown-value {
            font-weight: 600;
            color: #333;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .nav-buttons {
                margin-right: 0;
            }

            .company-grid,
            .cost-breakdown-grid,
            .results-grid {
                grid-template-columns: 1fr;
            }

            .sales-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons .btn {
                width: 100%;
                margin: 10px 0;
            }
        }

        /* Animation for smooth transitions */
        .section {
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <h1>Калькулятор рентабельности</h1>
                <button class="btn btn-success" onclick="newCalculation()">➕ Новый расчет</button>
                <button class="btn btn-info" onclick="showCalculationsHistory()" style="margin-right: 40px;">📊 История расчетов</button>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="nav-buttons">
                    <a href="clients.html" class="btn btn-secondary">Контрагенты</a>
                    <a href="warehouse.html" class="btn btn-secondary">Склад</a>
                    <a href="orders.html" class="btn btn-secondary">Заявки</a>
                    <a href="contracts.html" class="btn btn-secondary">Договоры</a>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                        У
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="user-name" id="userName">Пользователь</div>
                            <div class="user-email" id="userEmail">user@example.com</div>
                        </div>
                        <button class="dropdown-item logout" onclick="logout()">
                            🚪 Выйти из системы
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div>
                <div class="loading"></div>
                <span>Выполняется расчет...</span>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="successMessage" class="success-message" style="display: none;"></div>

        <form id="calculatorForm">
            <!-- 1. Company Information Section -->
            <div class="section">
                <h2><span class="section-icon">🏢</span>Информация о компании</h2>
                <div class="company-grid">
                    <div class="form-group">
                        <label for="sellingCompany" class="required">Продающая компания</label>
                        <select id="sellingCompany" class="required-field" required>
                            <option value="">Выберите компанию</option>
                            <option value="nova">Нова</option>
                            <option value="co-lab">СО-ЛАБ</option>
                            <option value="other">Другая</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="organizationINN">ИНН организации</label>
                        <input type="text" id="organizationINN" placeholder="123456789" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="organizationName">Название организации</label>
                        <div style="position: relative;">
                            <select id="organizationName" style="width: 100%;">
                                <option value="">Выберите организацию или создайте новую</option>
                                <option value="__new__">➕ Создать нового клиента</option>
                            </select>
                            <div id="organizationHint" style="font-size: 12px; color: #666; margin-top: 5px; display: none;">
                                Клиент не найден. <a href="#" onclick="redirectToNewClient(); return false;" style="color: #667eea;">Создать нового клиента</a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="responsibleManager" class="required">Ответственный менеджер</label>
                        <select id="responsibleManager" class="required-field" required>
                            <option value="">Выберите менеджера</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 2. Cost Breakdown Section -->
            <div class="section">
                <h2><span class="section-icon">💰</span>Структура себестоимости</h2>
                <div class="cost-breakdown-grid">
                    <div class="form-group">
                        <label for="gasCost" class="required">Стоимость газа (сум)</label>
                        <input type="number" id="gasCost" class="required-field" step="0.01" min="0" value="0" oninput="calculateRealTime()">
                    </div>
                    <div class="form-group">
                        <label for="cylinderCost" class="required">Стоимость баллона (сум)</label>
                        <input type="number" id="cylinderCost" class="required-field" step="0.01" min="0" value="0" oninput="calculateRealTime()">
                    </div>
                    <div class="form-group">
                        <label for="preparationCost">Подготовка товара (сум)</label>
                        <input type="number" id="preparationCost" step="0.01" min="0" value="0" oninput="calculateRealTime()" placeholder="Комплектующие, покраска и т.д.">
                    </div>
                    <div class="form-group">
                        <label for="logisticsCost">Логистика (сум)</label>
                        <input type="number" id="logisticsCost" step="0.01" min="0" value="0" oninput="calculateRealTime()" placeholder="Транспортные расходы">
                    </div>
                    <div class="form-group">
                        <label for="workersCost">Грузчики (сум)</label>
                        <input type="number" id="workersCost" step="0.01" min="0" value="0" oninput="calculateRealTime()" placeholder="Оплата рабочих">
                    </div>
                    <div class="form-group">
                        <label for="kickbacksCost">Откаты по сделке (сум)</label>
                        <input type="number" id="kickbacksCost" step="0.01" min="0" value="0" oninput="calculateRealTime()" placeholder="Дополнительные расходы">
                    </div>
                </div>
                <div class="total-display">
                    <div>💸 Общая себестоимость: <span id="totalCostBreakdown">0 сум</span></div>
                </div>
                <div class="formula-display">
                    <strong>Формула расчета:</strong><br>
                    Общая себестоимость = Газ + Баллон + Подготовка + Логистика + Грузчики + Откаты
                </div>
            </div>

            <!-- 3. Sales Information Section -->
            <div class="section">
                <h2><span class="section-icon">🏷️</span>Информация о продаже</h2>
                <div class="sales-grid">
                    <div class="form-group">
                        <label for="productName" class="required">Название товара</label>
                        <input type="text" id="productName" class="required-field" placeholder="Например: Баллон с газом" required>
                    </div>
                    <div class="form-group">
                        <label for="pricePerUnit" class="required">Цена за единицу (сум)</label>
                        <input type="number" id="pricePerUnit" class="required-field" step="0.01" min="0" value="0" oninput="calculateRealTime()" required>
                    </div>
                    <div class="form-group">
                        <label for="quantity" class="required">Количество</label>
                        <input type="number" id="quantity" class="required-field" step="0.01" min="1" value="1" oninput="calculateRealTime()" required>
                    </div>
                    <div class="form-group">
                        <label>Общая сумма продаж</label>
                        <input type="number" id="totalSaleAmount" class="auto-calc" readonly tabindex="-1">
                    </div>
                </div>
                <div class="formula-display">
                    <strong>Формула расчета:</strong><br>
                    Общая сумма продаж = Цена за единицу × Количество
                </div>
            </div>

            <!-- 4. Profitability Analysis Section -->
            <div class="section">
                <h2><span class="section-icon">📈</span>Анализ рентабельности</h2>
                <div class="results-grid">
                    <div class="form-group">
                        <label>Валовая прибыль (сум)</label>
                        <input type="number" id="grossProfit" class="auto-calc" readonly tabindex="-1">
                        <div class="formula-display">Общая продажа - Общая себестоимость</div>
                    </div>
                    <div class="form-group">
                        <label for="vatRate">НДС (%)</label>
                        <input type="number" id="vatRate" step="0.01" min="0" max="100" value="12" oninput="calculateRealTime()">
                    </div>
                    <div class="form-group">
                        <label>Сумма НДС (сум)</label>
                        <input type="number" id="vatAmount" class="auto-calc" readonly tabindex="-1">
                        <div class="formula-display">Валовая прибыль × НДС%</div>
                    </div>
                    <div class="form-group">
                        <label for="incomeTaxRate">Налог на прибыль (%)</label>
                        <input type="number" id="incomeTaxRate" step="0.01" min="0" max="100" value="20" oninput="calculateRealTime()">
                    </div>
                    <div class="form-group">
                        <label>Сумма налога на прибыль (сум)</label>
                        <input type="number" id="incomeTaxAmount" class="auto-calc" readonly tabindex="-1">
                        <div class="formula-display">Валовая прибыль × Налог на прибыль%</div>
                    </div>
                    <div class="form-group">
                        <label>Чистая прибыль (сум)</label>
                        <input type="number" id="netProfit" class="auto-calc" readonly tabindex="-1">
                        <div class="formula-display">Валовая прибыль - НДС - Налог на прибыль</div>
                    </div>
                </div>
                
                <div class="results-grid" style="margin-top: 25px;">
                    <div class="form-group">
                        <label>Рентабельность (%)</label>
                        <input type="number" id="profitabilityPercent" class="auto-calc" readonly tabindex="-1">
                        <div class="formula-display">Чистая прибыль / Общая себестоимость × 100</div>
                    </div>
                    <div class="form-group">
                        <div id="profitIndicator" class="profit-indicator profit-neutral">
                            🔄 Введите данные для расчета рентабельности
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Results Summary Section -->
            <div id="resultsSection" class="final-results" style="display: none;">
                <h2><span class="section-icon">📊</span>Итоговые результаты</h2>
                
                <div class="breakdown-item">
                    <span class="breakdown-label">📦 Товар:</span>
                    <span class="breakdown-value" id="resultProductName">-</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">🔢 Количество:</span>
                    <span class="breakdown-value" id="resultQuantity">-</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">💸 Общая себестоимость:</span>
                    <span class="breakdown-value currency" id="resultTotalCost">0 сум</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">💰 Общая сумма продаж:</span>
                    <span class="breakdown-value currency" id="resultTotalSales">0 сум</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">📈 Валовая прибыль:</span>
                    <span class="breakdown-value currency" id="resultGrossProfit">0 сум</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">🏛️ НДС:</span>
                    <span class="breakdown-value currency" id="resultVAT">0 сум</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">🏛️ Налог на прибыль:</span>
                    <span class="breakdown-value currency" id="resultIncomeTax">0 сум</span>
                </div>
                
                <div class="result-item">
                    <span>💎 ЧИСТАЯ ПРИБЫЛЬ:</span>
                    <span class="currency" id="resultNetProfit">0 сум</span>
                </div>
                
                <div class="total-display" style="margin-top: 25px;">
                    <div>🎯 Рентабельность: <span id="resultProfitability">0%</span></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn btn-primary" onclick="performFullCalculation()">
                    🧮 Рассчитать рентабельность
                </button>
                <button type="button" class="btn btn-success" id="saveBtn" onclick="saveCalculation()" style="display: none;">
                    💾 Сохранить расчет
                </button>
            </div>
        </form>
    </div>

    <!-- History Section -->
    <div id="historySection" class="container" style="display: none;">
        <div class="header" style="border-bottom: 2px solid #e1e5e9; padding-bottom: 15px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 40px;">
                <h2>📊 История расчетов</h2>
                <button class="btn btn-secondary" onclick="hideCalculationsHistory()">← Вернуться к калькулятору</button>
            </div>
        </div>
        
        <div class="form-row" style="margin-bottom: 20px;">
            <input type="text" id="historySearch" placeholder="Поиск по товару, клиенту или ИНН..." 
                   style="padding: 10px; border: 1px solid #e1e5e9; border-radius: 8px; width: 300px;">
            <button class="btn btn-primary" onclick="loadCalculationsHistory()">🔍 Найти</button>
        </div>
        
        <div id="historyContainer">
            <div style="text-align: center; padding: 40px; color: #95a5a6;">
                Загрузка истории расчетов...
            </div>
        </div>
        
        <div id="historyPagination" style="margin-top: 20px;"></div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Global variables
        let currentCalculationData = {
            company: {},
            costs: {},
            sales: {},
            profitability: {}
        };
        let managers = [];
        let realTimeCalculationTimeout;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Temporarily disable auth check for testing
            // if (!requireAuth()) return;
            
            initializeUserInfo();
            initializeManagers();
            initializeClients();
            restoreCalculatorDataFromLocalStorage();
            setupINNSearch();
            
            // Add input event listeners for real-time calculation
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', debounce(calculateRealTime, 300));
            });
        });

        function initializeUserInfo() {
            const user = APIHelpers.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                
                // Set avatar - first letter of name
                const firstLetter = user.name.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;
            }
        }

        async function initializeManagers() {
            try {
                // Прямой запрос к API
                const response = await fetch('/api/managers', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                managers = data.managers || [];
                
                const managerSelect = document.getElementById('responsibleManager');
                managerSelect.innerHTML = '<option value="">Выберите менеджера</option>';
                
                // Get current user from localStorage
                const currentUser = localStorage.getItem('user');
                let currentUserName = '';
                if (currentUser) {
                    try {
                        const userObj = JSON.parse(currentUser);
                        currentUserName = userObj.name || userObj.email || '';
                    } catch (e) {
                        // Handle parsing error
                    }
                }
                
                managers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager.id;
                    option.textContent = manager.name;
                    managerSelect.appendChild(option);
                    
                    // Set current manager as default if names match
                    if (currentUserName && manager.name === currentUserName) {
                        managerSelect.value = manager.id;
                    }
                });
                
                // If no manager was selected but we have managers, select the first one
                if (!managerSelect.value && managers.length > 0) {
                    // Try to match by current user or select first manager
                    const defaultManager = managers.find(m => m.name === currentUserName) || managers[0];
                    if (defaultManager) {
                        managerSelect.value = defaultManager.id;
                    }
                }
            } catch (error) {
                console.error('Error loading managers:', error);
                const managerSelect = document.getElementById('responsibleManager');
                if (managerSelect) {
                    managerSelect.innerHTML = '<option value="">Ошибка: ' + error.message + '</option>';
                }
            }
        }

        // Initialize clients dropdown
        async function initializeClients() {
            try {
                const response = await API.getClients({ limit: 500 });
                const clients = response.clients || [];
                
                const organizationSelect = document.getElementById('organizationName');
                
                // Keep the default options
                organizationSelect.innerHTML = `
                    <option value="">Выберите организацию или создайте новую</option>
                    <option value="__new__">➕ Создать нового клиента</option>
                    <option disabled>──────────────────</option>
                `;
                
                // Add clients from database
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    option.dataset.inn = client.inn || '';
                    organizationSelect.appendChild(option);
                });
                
                // Add event listener for selection
                organizationSelect.addEventListener('change', handleOrganizationChange);
                
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        // Handle organization selection
        function handleOrganizationChange(event) {
            const select = event.target;
            const selectedValue = select.value;
            const innInput = document.getElementById('organizationINN');
            const hintDiv = document.getElementById('organizationHint');
            
            if (selectedValue === '__new__') {
                // Redirect to create new client
                if (confirm('Вы будете перенаправлены на страницу создания нового клиента. Сохранить текущие данные калькулятора?')) {
                    // Save current calculator data to localStorage
                    saveCalculatorDataToLocalStorage();
                    window.location.href = 'clients.html';
                }
                select.value = ''; // Reset selection
            } else if (selectedValue && selectedValue !== '') {
                // Auto-fill INN if client is selected
                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption.dataset.inn) {
                    innInput.value = selectedOption.dataset.inn;
                }
                hintDiv.style.display = 'none';
            } else {
                // Clear INN if no client selected
                innInput.value = '';
                hintDiv.style.display = 'none';
            }
            
            // Trigger real-time calculation
            calculateRealTime();
        }

        // Save calculator data to localStorage
        function saveCalculatorDataToLocalStorage() {
            const data = {
                sellingCompany: document.getElementById('sellingCompany').value,
                organizationINN: document.getElementById('organizationINN').value,
                responsibleManager: document.getElementById('responsibleManager').value,
                gasCost: document.getElementById('gasCost').value,
                cylinderCost: document.getElementById('cylinderCost').value,
                preparationCost: document.getElementById('preparationCost').value,
                logisticsCost: document.getElementById('logisticsCost').value,
                workersCost: document.getElementById('workersCost').value,
                kickbacksCost: document.getElementById('kickbacksCost').value,
                productName: document.getElementById('productName').value,
                unitPrice: document.getElementById('unitPrice').value,
                quantity: document.getElementById('quantity').value,
                vatRate: document.getElementById('vatRate').value,
                incomeTaxRate: document.getElementById('incomeTaxRate').value
            };
            localStorage.setItem('calculatorData', JSON.stringify(data));
        }

        // Restore calculator data from localStorage
        function restoreCalculatorDataFromLocalStorage() {
            const savedData = localStorage.getItem('calculatorData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && data[key]) {
                            element.value = data[key];
                        }
                    });
                    // Clear saved data
                    localStorage.removeItem('calculatorData');
                    // Trigger calculation
                    calculateRealTime();
                } catch (error) {
                    console.error('Error restoring calculator data:', error);
                }
            }
        }

        // Redirect to create new client
        function redirectToNewClient() {
            if (confirm('Вы будете перенаправлены на страницу создания нового клиента. Сохранить текущие данные калькулятора?')) {
                saveCalculatorDataToLocalStorage();
                window.location.href = 'clients.html';
            }
        }

        // Search client by INN
        async function searchClientByINN(inn) {
            if (!inn || inn.trim() === '') return;
            
            try {
                const response = await API.getClients({ search: inn, limit: 500 });
                const clients = response.clients || [];
                
                // Find client with matching INN
                const matchingClient = clients.find(client => client.inn === inn);
                
                if (matchingClient) {
                    // Found client - update the dropdown
                    const organizationSelect = document.getElementById('organizationName');
                    organizationSelect.value = matchingClient.id;
                    
                    // Show success feedback
                    const innInput = document.getElementById('organizationINN');
                    innInput.style.borderColor = '#28a745';
                    setTimeout(() => {
                        innInput.style.borderColor = '';
                    }, 2000);
                    
                    // Hide hint
                    document.getElementById('organizationHint').style.display = 'none';
                    
                    // Trigger calculation
                    calculateRealTime();
                } else {
                    // Client not found - show hint
                    const organizationSelect = document.getElementById('organizationName');
                    organizationSelect.value = '';
                    document.getElementById('organizationHint').style.display = 'block';
                }
            } catch (error) {
                console.error('Error searching client by INN:', error);
            }
        }

        // Add INN input handler
        let innSearchTimeout;
        function setupINNSearch() {
            const innInput = document.getElementById('organizationINN');
            
            innInput.addEventListener('input', function(event) {
                const inn = event.target.value;
                
                // Clear previous timeout
                clearTimeout(innSearchTimeout);
                
                // Search after user stops typing for 500ms
                if (inn && inn.length >= 3) {
                    innSearchTimeout = setTimeout(() => {
                        searchClientByINN(inn);
                    }, 500);
                }
            });
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function logout() {
            API.logout();
        }

        // Message functions
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showMessage(message, isError = false) {
            // Показываем стандартные сообщения в верхней части
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            } else {
                successEl.textContent = message;
                successEl.style.display = 'block';
                errorEl.style.display = 'none';
            }

            setTimeout(() => {
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
            }, 5000);

            // Создаем всплывающее уведомление
            showToast(message, isError);
        }

        function showToast(message, isError = false) {
            // Удаляем существующие toast уведомления
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());

            // Создаем новое toast уведомление
            const toast = document.createElement('div');
            toast.className = `toast-notification ${isError ? 'toast-error' : 'toast-success'}`;
            toast.textContent = message;

            // Добавляем стили для toast
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isError ? '#dc3545' : '#28a745'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 350px;
                word-wrap: break-word;
            `;

            document.body.appendChild(toast);

            // Анимация появления
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);

            // Автоматическое скрытие через 3 секунды
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // Real-time calculation function
        function calculateRealTime() {
            const gasCost = parseFloat(document.getElementById('gasCost').value) || 0;
            const cylinderCost = parseFloat(document.getElementById('cylinderCost').value) || 0;
            const preparationCost = parseFloat(document.getElementById('preparationCost').value) || 0;
            const logisticsCost = parseFloat(document.getElementById('logisticsCost').value) || 0;
            const workersCost = parseFloat(document.getElementById('workersCost').value) || 0;
            const kickbacksCost = parseFloat(document.getElementById('kickbacksCost').value) || 0;
            
            const pricePerUnit = parseFloat(document.getElementById('pricePerUnit').value) || 0;
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
            const incomeTaxRate = parseFloat(document.getElementById('incomeTaxRate').value) || 0;

            // Calculate totals
            const totalCostBreakdown = gasCost + cylinderCost + preparationCost + logisticsCost + workersCost + kickbacksCost;
            const totalSaleAmount = pricePerUnit * quantity;
            const grossProfit = totalSaleAmount - totalCostBreakdown;
            const vatAmount = grossProfit > 0 ? grossProfit * (vatRate / 100) : 0;
            const incomeTaxAmount = grossProfit > 0 ? grossProfit * (incomeTaxRate / 100) : 0;
            const netProfit = grossProfit - vatAmount - incomeTaxAmount;
            const profitabilityPercent = totalCostBreakdown > 0 ? (netProfit / totalCostBreakdown) * 100 : 0;

            // Update display fields
            document.getElementById('totalCostBreakdown').textContent = formatCurrency(totalCostBreakdown);
            document.getElementById('totalSaleAmount').value = totalSaleAmount;
            document.getElementById('grossProfit').value = grossProfit;
            document.getElementById('vatAmount').value = vatAmount;
            document.getElementById('incomeTaxAmount').value = incomeTaxAmount;
            document.getElementById('netProfit').value = netProfit;
            document.getElementById('profitabilityPercent').value = profitabilityPercent.toFixed(2);

            // Update profit indicator
            updateProfitIndicator(profitabilityPercent, netProfit);

            // Get organization name properly from dropdown
            const organizationSelect = document.getElementById('organizationName');
            const organizationName = organizationSelect.selectedIndex > 0 && organizationSelect.value !== '__new__' 
                ? organizationSelect.options[organizationSelect.selectedIndex].text 
                : '';
            
            // Store calculation data
            currentCalculationData = {
                company: {
                    sellingCompany: document.getElementById('sellingCompany').value,
                    organizationINN: document.getElementById('organizationINN').value,
                    organizationName: organizationName,
                    responsibleManager: document.getElementById('responsibleManager').value
                },
                costs: {
                    gasCost, cylinderCost, preparationCost, 
                    logisticsCost, workersCost, kickbacksCost, 
                    totalCostBreakdown
                },
                sales: {
                    productName: document.getElementById('productName').value,
                    pricePerUnit, quantity, totalSaleAmount
                },
                profitability: {
                    grossProfit, vatRate, vatAmount, 
                    incomeTaxRate, incomeTaxAmount, 
                    netProfit, profitabilityPercent
                }
            };
        }

        function updateProfitIndicator(profitabilityPercent, netProfit) {
            const indicator = document.getElementById('profitIndicator');
            
            // Обновляем цвета полей чистой прибыли и рентабельности в анализе
            const netProfitField = document.getElementById('netProfit');
            const profitabilityField = document.getElementById('profitabilityPercent');
            
            if (profitabilityPercent > 20) {
                indicator.className = 'profit-indicator profit-positive';
                indicator.innerHTML = `🎉 Отличная рентабельность! ${profitabilityPercent.toFixed(2)}%<br><small>Чистая прибыль: ${formatCurrency(netProfit)}</small>`;
                netProfitField.style.color = '#28a745';
                profitabilityField.style.color = '#28a745';
            } else if (profitabilityPercent > 10) {
                indicator.className = 'profit-indicator profit-positive';
                indicator.innerHTML = `✅ Хорошая рентабельность: ${profitabilityPercent.toFixed(2)}%<br><small>Чистая прибыль: ${formatCurrency(netProfit)}</small>`;
                netProfitField.style.color = '#28a745';
                profitabilityField.style.color = '#28a745';
            } else if (profitabilityPercent > 0) {
                indicator.className = 'profit-indicator profit-neutral';
                indicator.innerHTML = `⚠️ Низкая рентабельность: ${profitabilityPercent.toFixed(2)}%<br><small>Чистая прибыль: ${formatCurrency(netProfit)}</small>`;
                netProfitField.style.color = '#17a2b8';
                profitabilityField.style.color = '#17a2b8';
            } else {
                indicator.className = 'profit-indicator profit-negative';
                indicator.innerHTML = `❌ Убыточная сделка: ${profitabilityPercent.toFixed(2)}%<br><small>Убыток: ${formatCurrency(Math.abs(netProfit))}</small>`;
                netProfitField.style.color = '#dc3545';
                profitabilityField.style.color = '#dc3545';
            }
            
            // Добавляем жирность для выделения
            netProfitField.style.fontWeight = 'bold';
            profitabilityField.style.fontWeight = 'bold';
        }

        async function performFullCalculation() {
            // First calculate markup to initialize currentCalculationData
            calculateRealTime();
            
            // Validate required fields
            const requiredFields = ['sellingCompany', 'responsibleManager', 'gasCost', 'cylinderCost', 'productName', 'pricePerUnit', 'quantity'];
            let hasErrors = false;

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    field.style.borderColor = '#e74c3c';
                    hasErrors = true;
                } else {
                    field.style.borderColor = '#e1e5e9';
                }
            });

            if (hasErrors) {
                showMessage('Пожалуйста, заполните все обязательные поля', true);
                return;
            }

            try {
                showLoading(true);

                // Prepare data for API call
                const calculationData = {
                    company: {
                        sellingCompany: currentCalculationData.company.sellingCompany,
                        organizationINN: currentCalculationData.company.organizationINN || '',
                        organizationName: currentCalculationData.company.organizationName || '',
                        responsibleManager: currentCalculationData.company.responsibleManager
                    },
                    costs: {
                        productCost: (currentCalculationData.costs.gasCost || 0) + (currentCalculationData.costs.cylinderCost || 0) + (currentCalculationData.costs.preparationCost || 0),
                        deliveryCost: currentCalculationData.costs.logisticsCost || 0,
                        additionalCost: (currentCalculationData.costs.workersCost || 0) + (currentCalculationData.costs.kickbacksCost || 0)
                    },
                    sales: {
                        productName: currentCalculationData.sales.productName,
                        unitPrice: currentCalculationData.sales.pricePerUnit,
                        quantity: currentCalculationData.sales.quantity
                    },
                    taxes: {
                        vatRate: currentCalculationData.profitability.vatRate,
                        incomeTaxRate: currentCalculationData.profitability.incomeTaxRate
                    }
                };

                // Call the profitability analysis API
                const response = await API.calculateProfitabilityAnalysis(calculationData);
                
                displayResults(response.analysis);
                showMessage('Расчет выполнен успешно!');
                document.getElementById('saveBtn').style.display = 'inline-block';

            } catch (error) {
                console.error('Error performing calculation:', error);
                showMessage(APIHelpers.formatError(error), true);
            } finally {
                showLoading(false);
            }
        }

        function displayResults(analysis) {
            const resultsSection = document.getElementById('resultsSection');
            
            // Update summary fields
            document.getElementById('resultProductName').textContent = currentCalculationData.sales.productName;
            document.getElementById('resultQuantity').textContent = currentCalculationData.sales.quantity;
            document.getElementById('resultTotalCost').textContent = formatCurrency(analysis.totalCost);
            document.getElementById('resultTotalSales').textContent = formatCurrency(analysis.totalSaleAmount);
            document.getElementById('resultGrossProfit').textContent = formatCurrency(analysis.grossProfit);
            document.getElementById('resultVAT').textContent = formatCurrency(analysis.vatAmount);
            document.getElementById('resultIncomeTax').textContent = formatCurrency(analysis.incomeTaxAmount);
            // Отображение чистой прибыли с условной раскраской
            const netProfitElement = document.getElementById('resultNetProfit');
            netProfitElement.textContent = formatCurrency(analysis.netProfit);
            
            // Применяем цветовую схему в зависимости от прибыльности
            if (analysis.netProfit < 0) {
                netProfitElement.style.color = '#dc3545'; // Красный для убытка
                netProfitElement.style.fontWeight = 'bold';
            } else if (analysis.netProfit > 0) {
                netProfitElement.style.color = '#28a745'; // Зеленый для прибыли
                netProfitElement.style.fontWeight = 'bold';
            } else {
                netProfitElement.style.color = '#6c757d'; // Серый для нуля
                netProfitElement.style.fontWeight = 'normal';
            }
            
            // Отображение рентабельности с условной раскраской
            const profitabilityElement = document.getElementById('resultProfitability');
            profitabilityElement.textContent = analysis.profitabilityPercent.toFixed(2) + '%';
            
            if (analysis.profitabilityPercent < 0) {
                profitabilityElement.style.color = '#dc3545'; // Красный для отрицательной рентабельности
                profitabilityElement.style.fontWeight = 'bold';
            } else if (analysis.profitabilityPercent >= 20) {
                profitabilityElement.style.color = '#28a745'; // Зеленый для высокой рентабельности
                profitabilityElement.style.fontWeight = 'bold';
            } else if (analysis.profitabilityPercent >= 10) {
                profitabilityElement.style.color = '#ffc107'; // Желтый для средней рентабельности
                profitabilityElement.style.fontWeight = 'bold';
            } else if (analysis.profitabilityPercent > 0) {
                profitabilityElement.style.color = '#17a2b8'; // Голубой для низкой рентабельности
                profitabilityElement.style.fontWeight = 'normal';
            } else {
                profitabilityElement.style.color = '#6c757d'; // Серый для нуля
                profitabilityElement.style.fontWeight = 'normal';
            }

            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function saveCalculation() {
            if (!currentCalculationData.sales.productName) {
                showMessage('Сначала выполните расчет', true);
                return;
            }

            try {
                showLoading(true);
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.innerHTML = '<div class="loading"></div>Сохранение...';
                saveBtn.disabled = true;

                // Prepare calculation data for saving
                const calculationData = {
                    name: `${currentCalculationData.sales.productName} - ${new Date().toLocaleDateString('ru-RU')}`,
                    sellingCompany: currentCalculationData.company.sellingCompany,
                    organizationINN: currentCalculationData.company.organizationINN,
                    organizationName: currentCalculationData.company.organizationName,
                    responsibleManager: currentCalculationData.company.responsibleManager,
                    
                    gasCost: currentCalculationData.costs.gasCost,
                    cylinderCost: currentCalculationData.costs.cylinderCost,
                    preparationCost: currentCalculationData.costs.preparationCost,
                    logisticsCost: currentCalculationData.costs.logisticsCost,
                    workersCost: currentCalculationData.costs.workersCost,
                    kickbacksCost: currentCalculationData.costs.kickbacksCost,
                    
                    productName: currentCalculationData.sales.productName,
                    pricePerUnit: currentCalculationData.sales.pricePerUnit,
                    quantity: currentCalculationData.sales.quantity,
                    
                    vatPercent: currentCalculationData.profitability.vatRate,
                    incomeTaxPercent: currentCalculationData.profitability.incomeTaxRate
                };

                const response = await API.createCalculation(calculationData);
                showMessage('Расчет успешно сохранен!');

            } catch (error) {
                console.error('Error saving calculation:', error);
                showMessage(APIHelpers.formatError(error), true);
            } finally {
                showLoading(false);
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.textContent = '💾 Сохранить расчет';
                saveBtn.disabled = false;
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            return amount.toLocaleString('ru-RU', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }) + ' сум';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Form validation
        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            performFullCalculation();
        });

        // History functions
        let currentHistoryPage = 1;
        
        function showCalculationsHistory() {
            document.querySelector('.container:not(#historySection)').style.display = 'none';
            document.getElementById('historySection').style.display = 'block';
            loadCalculationsHistory();
        }
        
        function hideCalculationsHistory() {
            document.getElementById('historySection').style.display = 'none';
            document.querySelector('.container:not(#historySection)').style.display = 'block';
        }
        
        function newCalculation() {
            // Clear all form fields
            const fields = [
                'sellingCompany', 'organizationINN', 'responsibleManager',
                'gasCost', 'cylinderCost', 'preparationCost', 
                'logisticsCost', 'workersCost', 'kickbacksCost',
                'productName', 'pricePerUnit', 'quantity'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'number') {
                        field.value = fieldId === 'quantity' ? 1 : 0;
                    } else {
                        field.value = '';
                    }
                }
            });
            
            // Reset tax rates to defaults
            document.getElementById('vatRate').value = 12;
            document.getElementById('incomeTaxRate').value = 20;
            
            // Reset organization dropdown
            const orgSelect = document.getElementById('organizationName');
            if (orgSelect) {
                orgSelect.selectedIndex = 0;
            }
            
            // Clear all calculated fields
            const calculatedFields = [
                'totalSaleAmount', 'grossProfit', 'vatAmount', 
                'incomeTaxAmount', 'netProfit', 'profitabilityPercent'
            ];
            
            calculatedFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = 0;
                }
            });
            
            // Clear cost breakdown display
            const totalCostDisplay = document.getElementById('totalCostBreakdown');
            if (totalCostDisplay) {
                totalCostDisplay.textContent = '0 сум';
            }
            
            // Hide save button and results
            document.getElementById('saveBtn').style.display = 'none';
            
            // Clear messages
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            
            // Set focus to first field
            const firstField = document.getElementById('sellingCompany');
            if (firstField) {
                firstField.focus();
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
            
            showMessage('Форма очищена для нового расчета');
        }
        
        async function loadCalculationsHistory(page = 1) {
            try {
                const searchTerm = document.getElementById('historySearch').value;
                const params = {
                    page: page,
                    limit: 10,
                    search: searchTerm
                };
                
                const response = await API.getCalculations(params);
                displayCalculationsHistory(response.calculations);
                updateHistoryPagination(response.pagination);
                currentHistoryPage = page;
                
            } catch (error) {
                console.error('Error loading calculations history:', error);
                document.getElementById('historyContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        Ошибка загрузки истории: ${error.message}
                    </div>
                `;
            }
        }
        
        function displayCalculationsHistory(calculations) {
            const container = document.getElementById('historyContainer');
            
            if (calculations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #95a5a6;">
                        Нет сохраненных расчетов
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #e1e5e9;">
                            <th style="padding: 12px; text-align: left;">Дата</th>
                            <th style="padding: 12px; text-align: left;">Товар</th>
                            <th style="padding: 12px; text-align: left;">Клиент</th>
                            <th style="padding: 12px; text-align: right;">Сумма</th>
                            <th style="padding: 12px; text-align: right;">Прибыль</th>
                            <th style="padding: 12px; text-align: right;">Рентабельность</th>
                            <th style="padding: 12px; text-align: center;">Менеджер</th>
                            <th style="padding: 12px; text-align: center;">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${calculations.map(calc => `
                            <tr style="border-bottom: 1px solid #e1e5e9; cursor: pointer;" 
                                onclick="loadCalculationData('${calc.id}')" 
                                title="Нажмите для загрузки расчета в калькулятор">
                                <td style="padding: 12px;">${new Date(calc.createdAt).toLocaleDateString('ru-RU')}</td>
                                <td style="padding: 12px;">${calc.productName || '-'}</td>
                                <td style="padding: 12px;">
                                    ${calc.organizationName || '-'}
                                    ${calc.organizationINN ? `<br><small style="color: #95a5a6;">ИНН: ${calc.organizationINN}</small>` : ''}
                                </td>
                                <td style="padding: 12px; text-align: right;">${formatCurrency(calc.totalSales || 0)}</td>
                                <td style="padding: 12px; text-align: right; color: ${calc.netProfit >= 0 ? '#27ae60' : '#e74c3c'};">
                                    ${formatCurrency(calc.netProfit || 0)}
                                </td>
                                <td style="padding: 12px; text-align: right;">
                                    <span style="color: ${calc.profitabilityPercent >= 20 ? '#27ae60' : calc.profitabilityPercent >= 10 ? '#f39c12' : '#e74c3c'};">
                                        ${(calc.profitabilityPercent || 0).toFixed(2)}%
                                    </span>
                                </td>
                                <td style="padding: 12px; text-align: center;">${calc.createdBy || '-'}</td>
                                <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation();">
                                    <button class="btn btn-danger" onclick="deleteCalculation('${calc.id}')" style="padding: 4px 8px; font-size: 12px;">🗑️</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function updateHistoryPagination(pagination) {
            const container = document.getElementById('historyPagination');
            if (pagination.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let buttons = [];
            for (let i = 1; i <= pagination.totalPages; i++) {
                const isActive = i === pagination.page;
                buttons.push(`
                    <button class="btn ${isActive ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="loadCalculationsHistory(${i})"
                            style="margin: 0 5px;">
                        ${i}
                    </button>
                `);
            }
            
            container.innerHTML = `
                <div style="text-align: center;">
                    ${buttons.join('')}
                </div>
            `;
        }
        
        async function loadCalculationData(calcId) {
            try {
                const calculation = await API.getCalculation(calcId);
                console.log('Loading calculation:', calculation);
                
                // Hide history and show calculator
                hideCalculationsHistory();
                
                // Load data into form fields with debugging
                console.log('Setting form fields...');
                
                const fields = {
                    'sellingCompany': calculation.sellingCompany || '',
                    'organizationINN': calculation.organizationINN || '',
                    'responsibleManager': calculation.responsibleManager || '',
                    'gasCost': calculation.gasCost || 0,
                    'cylinderCost': calculation.cylinderCost || 0,
                    'preparationCost': calculation.preparationCost || 0,
                    'logisticsCost': calculation.logisticsCost || 0,
                    'workersCost': calculation.workersCost || 0,
                    'kickbacksCost': calculation.kickbacksCost || 0,
                    'productName': calculation.productName || '',
                    'pricePerUnit': calculation.pricePerUnit || 0,
                    'quantity': calculation.quantity || 1,
                    'vatRate': calculation.vatPercent || 12,
                    'incomeTaxRate': calculation.incomeTaxPercent || 20
                };
                
                // Set each field and verify it was set
                for (const [fieldId, value] of Object.entries(fields)) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = value;
                        console.log(`Set ${fieldId} = ${value}`);
                    } else {
                        console.error(`Field ${fieldId} not found!`);
                    }
                }
                
                // Set organization dropdown if exists
                if (calculation.organizationName && calculation.organizationINN) {
                    const orgSelect = document.getElementById('organizationName');
                    if (orgSelect) {
                        // Try to find existing organization
                        for (let i = 0; i < orgSelect.options.length; i++) {
                            if (orgSelect.options[i].value === calculation.organizationINN) {
                                orgSelect.selectedIndex = i;
                                console.log(`Set organization dropdown to: ${calculation.organizationName}`);
                                break;
                            }
                        }
                    }
                }
                
                // Small delay then trigger calculation to show results
                setTimeout(() => {
                    console.log('Triggering calculateRealTime...');
                    calculateRealTime();
                    console.log('Calculate real time completed');
                }, 100);
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                showMessage('Расчет загружен в калькулятор');
                
            } catch (error) {
                console.error('Error loading calculation:', error);
                showMessage('Ошибка загрузки расчета: ' + error.message, true);
            }
        }
        
        async function deleteCalculation(calcId) {
            if (!confirm('Удалить этот расчет?')) return;
            
            try {
                await API.deleteCalculation(calcId);
                showMessage('Расчет удален');
                loadCalculationsHistory(currentHistoryPage);
            } catch (error) {
                showMessage('Ошибка удаления: ' + error.message, true);
            }
        }

        // Initialize real-time calculation on page load
        setTimeout(calculateRealTime, 500);
    </script>
</body>
</html>