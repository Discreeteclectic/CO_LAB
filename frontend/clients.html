<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление клиентами - CO_LAB CRM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: white;
            box-sizing: border-box;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }

        h1 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-left: 20px;
            position: relative;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .user-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 12px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            margin-bottom: 4px;
        }

        .user-name {
            color: #333;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .user-email {
            color: #666;
            font-size: 12px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #eee;
            margin-top: 4px;
        }

        .dropdown-item.logout:hover {
            background-color: #fff5f5;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"], input[type="email"], input[type="tel"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .clients-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: relative;
        }

        .clients-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .clients-table tr:hover {
            background: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .items-per-page select {
            padding: 8px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 12px;
            color: #c33;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 8px;
            padding: 12px;
            color: #3c3;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-controls button {
            padding: 8px 12px;
            border: 1px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .pagination-controls button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 14px;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .sortable-header:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sort-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 12px;
            opacity: 0.7;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div style="display: flex; align-items: center; gap: 30px;">
                    <h1>Управление клиентами</h1>
                    <button class="btn btn-success" onclick="openAddClientModal()">➕ Добавить клиента</button>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="nav-buttons">
                        <a href="markup_calculator.html" class="btn btn-secondary">Калькулятор</a>
                        <a href="warehouse.html" class="btn btn-secondary">Склад</a>
                        <a href="orders.html" class="btn btn-secondary">Заявки</a>
                        <a href="contracts.html" class="btn btn-secondary">Договоры</a>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">
                            У
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-header">
                                <div class="user-name" id="userName">Пользователь</div>
                                <div class="user-email" id="userEmail">user@example.com</div>
                            </div>
                            <button class="dropdown-item logout" onclick="logout()">
                                🚪 Выйти из системы
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalClients">-</div>
                <div class="stat-label">Всего клиентов</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCalculations">-</div>
                <div class="stat-label">Всего расчетов</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeClients">-</div>
                <div class="stat-label">Активных клиентов</div>
            </div>
        </div>

        <div class="section" style="position: relative;">
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div>
                    <div class="loading"></div>
                    <span>Загрузка...</span>
                </div>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>

            <div class="search-controls">
                <input type="text" class="search-input" id="searchInput" placeholder="🔍 Поиск клиентов по названию, ИНН, контактам, Telegram..." onkeyup="handleSearch()">
                <div class="filter-controls">
                    <div class="items-per-page">
                        <label>Показать:</label>
                        <select id="itemsPerPage" onchange="changeItemsPerPage()">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadClients()">🔄 Обновить</button>
                </div>
            </div>
            
            <div id="clientsTableContainer">
                <table class="clients-table" id="clientsTable">
                    <thead>
                        <tr>
                            <th class="sortable-header" data-sort="name" onclick="sortBy('name')">
                                Название <span class="sort-indicator" id="sort-name"></span>
                            </th>
                            <th>ИНН</th>
                            <th class="sortable-header" data-sort="contactPerson" onclick="sortBy('contactPerson')">
                                Контактное лицо <span class="sort-indicator" id="sort-contactPerson"></span>
                            </th>
                            <th class="sortable-header" data-sort="phone" onclick="sortBy('phone')">
                                Телефон <span class="sort-indicator" id="sort-phone"></span>
                            </th>
                            <th class="sortable-header" data-sort="email" onclick="sortBy('email')">
                                Email <span class="sort-indicator" id="sort-email"></span>
                            </th>
                            <th>Telegram</th>
                            <th class="sortable-header" data-sort="createdAt" onclick="sortBy('createdAt')">
                                Дата создания <span class="sort-indicator" id="sort-createdAt">▼</span>
                            </th>
                            <th>Расчеты</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>

            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <!-- Модальное окно добавления/редактирования клиента -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Добавить клиента</h2>
                <span class="close" onclick="closeClientModal()">&times;</span>
            </div>
            
            <div id="modalErrorMessage" class="error-message" style="display: none;"></div>
            
            <form id="clientForm">
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="clientName">Название компании *</label>
                        <input type="text" id="clientName" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="clientCode">Код клиента</label>
                        <input type="text" id="clientCode" placeholder="Автогенерация">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="clientInn">ИНН</label>
                        <input type="text" id="clientInn" placeholder="9-12 цифр" pattern="[0-9]{9,12}" maxlength="12">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="contactPerson">Контактное лицо</label>
                        <input type="text" id="contactPerson">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="position">Должность</label>
                        <input type="text" id="position">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="phone">Телефон</label>
                        <input type="tel" id="phone">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="telegram">Telegram</label>
                        <input type="text" id="telegram" placeholder="@username или username">
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">Адрес</label>
                    <textarea id="address" placeholder="Полный адрес компании"></textarea>
                </div>

                <div class="form-group">
                    <label for="notes">Примечания</label>
                    <textarea id="notes" placeholder="Дополнительная информация о клиенте"></textarea>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeClientModal()" style="margin-right: 10px;">Отмена</button>
                    <button type="submit" class="btn btn-success" id="saveClientBtn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentEditingClient = null;
        let currentPage = 1;
        let pageSize = 20;
        let searchTimeout;
        let currentSort = 'createdAt';
        let currentOrder = 'DESC';
        let isLoading = false;

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Temporarily disable auth check
            // if (!requireAuth()) return;
            
            initializeUserInfo();
            loadClients();
        });

        function initializeUserInfo() {
            const user = APIHelpers.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                
                // Установить аватарку - первая буква имени
                const firstLetter = user.name.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = firstLetter;
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Закрывать дропдаун при клике вне его
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function logout() {
            API.logout();
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function showMessage(message, isError = false) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            } else {
                successEl.textContent = message;
                successEl.style.display = 'block';
                errorEl.style.display = 'none';
            }

            // Автоматически скрыть сообщение через 5 секунд
            setTimeout(() => {
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
            }, 5000);
        }

        function showModalMessage(message, isError = false) {
            const modalErrorEl = document.getElementById('modalErrorMessage');
            
            if (isError) {
                modalErrorEl.textContent = message;
                modalErrorEl.style.display = 'block';
            } else {
                modalErrorEl.style.display = 'none';
            }
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('modalErrorMessage').style.display = 'none';
        }

        // Загрузка клиентов
        async function loadClients(page = 1) {
            if (isLoading) return;
            
            try {
                isLoading = true;
                currentPage = page;
                showLoading(true);
                hideMessages();

                const searchTerm = document.getElementById('searchInput').value.trim();
                const params = {
                    page,
                    limit: pageSize,
                    sort: currentSort,
                    order: currentOrder
                };

                if (searchTerm) {
                    params.search = searchTerm;
                }

                const response = await API.getClients(params);
                displayClients(response.clients);
                updatePagination(response.pagination, response.meta);
                updateStats();

            } catch (error) {
                console.error('Error loading clients:', error);
                showMessage(APIHelpers.formatError(error), true);
                APIHelpers.showError(document.getElementById('clientsTableContainer'), 'Ошибка загрузки клиентов');
            } finally {
                showLoading(false);
                isLoading = false;
            }
        }

        // Отображение клиентов
        function displayClients(clients) {
            const container = document.getElementById('clientsTableContainer');
            
            if (clients.length === 0) {
                const searchTerm = document.getElementById('searchInput').value.trim();
                const message = searchTerm ? 'По вашему запросу ничего не найдено' : 'Пока нет добавленных клиентов';
                APIHelpers.showEmpty(container, message);
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // Восстанавливаем таблицу если она была скрыта
            if (!document.getElementById('clientsTable')) {
                container.innerHTML = `
                    <table class="clients-table" id="clientsTable">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>ИНН</th>
                                <th>Контактное лицо</th>
                                <th>Телефон</th>
                                <th>Email</th>
                                <th>Telegram</th>
                                <th>Дата создания</th>
                                <th>Расчеты</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody"></tbody>
                    </table>
                `;
            }

            // Получаем tableBody после возможного пересоздания таблицы
            const tableBody = document.getElementById('clientsTableBody');
            tableBody.innerHTML = clients.map(client => {
                const calculationsCount = client.calculationCount || 0;
                
                return `
                    <tr style="cursor: pointer;" onclick="openClientCard('${client.id}')" title="Нажмите для просмотра карточки клиента">
                        <td>
                            <strong>${client.name}</strong>
                            ${client.code ? `<br><small style="color: #6c757d;">Код: ${client.code}</small>` : ''}
                        </td>
                        <td>${client.inn || '-'}</td>
                        <td>
                            ${client.contactPerson || '-'}
                            ${client.position ? `<br><small style="color: #6c757d;">${client.position}</small>` : ''}
                        </td>
                        <td>${client.phone || '-'}</td>
                        <td>${client.email || '-'}</td>
                        <td onclick="event.stopPropagation();">${client.telegram ? `<a href="https://t.me/${client.telegram.replace('@', '')}" target="_blank" style="color: #0088cc; text-decoration: none;">${client.telegram}</a>` : '-'}</td>
                        <td>${APIHelpers.formatDate(client.createdAt)}</td>
                        <td>
                            ${calculationsCount > 0 ? `<span style="color: #28a745; font-weight: bold;">📊 ${calculationsCount}</span>` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Обновление пагинации
        function updatePagination(pagination, meta = {}) {
            const paginationEl = document.getElementById('pagination');
            
            if (pagination.pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            // Информация о пагинации
            const start = (pagination.page - 1) * pagination.limit + 1;
            const end = Math.min(pagination.page * pagination.limit, pagination.total);
            const infoText = `Показано ${start}-${end} из ${pagination.total}`;
            
            // Контролы пагинации
            let controlsHTML = '<div class="pagination-controls">';
            
            // Кнопка "Предыдущая"
            controlsHTML += `
                <button onclick="loadClients(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>
                    ← Предыдущая
                </button>
            `;

            // Номера страниц
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) {
                    controlsHTML += `<button class="active">${i}</button>`;
                } else if (Math.abs(i - pagination.page) <= 2 || i === 1 || i === pagination.pages) {
                    controlsHTML += `<button onclick="loadClients(${i})">${i}</button>`;
                } else if (Math.abs(i - pagination.page) === 3) {
                    controlsHTML += '<span>...</span>';
                }
            }

            // Кнопка "Следующая"
            controlsHTML += `
                <button onclick="loadClients(${pagination.page + 1})" ${pagination.page >= pagination.pages ? 'disabled' : ''}>
                    Следующая →
                </button>
            `;
            
            controlsHTML += '</div>';

            paginationEl.innerHTML = `
                <div class="pagination-info">${infoText}</div>
                ${controlsHTML}
            `;
        }

        // Обновление статистики
        async function updateStats() {
            try {
                // Пока используем простые подсчеты, позже можно добавить отдельный endpoint для статистики
                const response = await API.getClients({ limit: 1000 }); // Получаем все для подсчета
                
                document.getElementById('totalClients').textContent = response.pagination.total;
                
                // Load calculations count
                const calculationsResponse = await API.getCalculations({ limit: 1 });
                document.getElementById('totalCalculations').textContent = calculationsResponse.pagination.total;
                
                // Active clients (clients with orders or recent activity)
                document.getElementById('activeClients').textContent = '-';
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Поиск с задержкой
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadClients(1);
            }, 500);
        }

        // Сортировка
        function sortBy(field) {
            if (currentSort === field) {
                currentOrder = currentOrder === 'ASC' ? 'DESC' : 'ASC';
            } else {
                currentSort = field;
                currentOrder = 'ASC';
            }
            
            updateSortIndicators();
            currentPage = 1;
            loadClients(1);
        }

        // Обновление индикаторов сортировки
        function updateSortIndicators() {
            // Очистить все индикаторы
            document.querySelectorAll('.sort-indicator').forEach(el => {
                el.textContent = '';
            });
            
            // Показать текущий индикатор
            const indicator = document.getElementById(`sort-${currentSort}`);
            if (indicator) {
                indicator.textContent = currentOrder === 'ASC' ? '▲' : '▼';
            }
        }

        // Изменение количества элементов на странице
        function changeItemsPerPage() {
            pageSize = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            loadClients(1);
        }

        // Отображение состояния загрузки
        function showTableLoading(show) {
            const container = document.getElementById('clientsTableContainer');
            const existingOverlay = container.querySelector('.loading-overlay');
            
            if (show && !existingOverlay) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading"></div>';
                container.style.position = 'relative';
                container.appendChild(overlay);
            } else if (!show && existingOverlay) {
                existingOverlay.remove();
            }
        }

        // Открытие модального окна добавления
        function openAddClientModal() {
            currentEditingClient = null;
            document.getElementById('modalTitle').textContent = 'Добавить клиента';
            document.getElementById('saveClientBtn').textContent = 'Сохранить';
            document.getElementById('clientForm').reset();
            hideMessages();
            document.getElementById('clientModal').style.display = 'block';
        }

        // Редактирование клиента
        async function editClient(clientId) {
            try {
                showLoading(true);
                const client = await API.getClient(clientId);
                
                currentEditingClient = clientId;
                document.getElementById('modalTitle').textContent = 'Редактировать клиента';
                document.getElementById('saveClientBtn').textContent = 'Обновить';
                
                document.getElementById('clientName').value = client.name || '';
                document.getElementById('clientCode').value = client.code || '';
                document.getElementById('clientInn').value = client.inn || '';
                document.getElementById('contactPerson').value = client.contactPerson || '';
                document.getElementById('position').value = client.position || '';
                document.getElementById('phone').value = client.phone || '';
                document.getElementById('email').value = client.email || '';
                document.getElementById('telegram').value = client.telegram || '';
                document.getElementById('address').value = client.address || '';
                document.getElementById('notes').value = client.notes || '';
                
                hideMessages();
                document.getElementById('clientModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading client:', error);
                showMessage(APIHelpers.formatError(error), true);
            } finally {
                showLoading(false);
            }
        }

        // Закрытие модального окна
        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
            currentEditingClient = null;
            hideMessages();
        }

        // Сохранение клиента
        document.getElementById('clientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const clientData = {
                name: document.getElementById('clientName').value.trim(),
                code: document.getElementById('clientCode').value.trim() || undefined,
                inn: document.getElementById('clientInn').value.trim() || undefined,
                contactPerson: document.getElementById('contactPerson').value.trim() || undefined,
                position: document.getElementById('position').value.trim() || undefined,
                phone: document.getElementById('phone').value.trim() || undefined,
                email: document.getElementById('email').value.trim() || undefined,
                telegram: document.getElementById('telegram').value.trim() || undefined,
                address: document.getElementById('address').value.trim() || undefined,
                notes: document.getElementById('notes').value.trim() || undefined
            };

            if (!clientData.name) {
                showModalMessage('Пожалуйста, укажите название компании', true);
                return;
            }

            try {
                const saveBtn = document.getElementById('saveClientBtn');
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<div class="loading"></div>Сохранение...';
                saveBtn.disabled = true;

                if (currentEditingClient) {
                    await API.updateClient(currentEditingClient, clientData);
                    showMessage('Клиент успешно обновлен!');
                } else {
                    await API.createClient(clientData);
                    showMessage('Клиент успешно добавлен!');
                }

                closeClientModal();
                loadClients(currentPage);

            } catch (error) {
                console.error('Error saving client:', error);
                showModalMessage(APIHelpers.formatError(error), true);
            } finally {
                const saveBtn = document.getElementById('saveClientBtn');
                saveBtn.textContent = currentEditingClient ? 'Обновить' : 'Сохранить';
                saveBtn.disabled = false;
            }
        });

        // Удаление клиента
        async function deleteClient(clientId, clientName) {
            if (!confirm(`Вы уверены, что хотите удалить клиента "${clientName}"? Это действие нельзя отменить.`)) {
                return;
            }

            try {
                showLoading(true);
                await API.deleteClient(clientId);
                showMessage('Клиент успешно удален!');
                loadClients(currentPage);
                
            } catch (error) {
                console.error('Error deleting client:', error);
                showMessage(APIHelpers.formatError(error), true);
            } finally {
                showLoading(false);
            }
        }

        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const modal = document.getElementById('clientModal');
            if (event.target === modal) {
                closeClientModal();
            }
        }
        
        // Открытие карточки клиента
        async function openClientCard(clientId) {
            try {
                const client = await API.getClient(clientId);
                const user = APIHelpers.getCurrentUser();
                const isAdmin = user && user.role === 'admin';
                
                // Создаем модальное окно карточки клиента
                const cardModal = document.createElement('div');
                cardModal.className = 'modal';
                cardModal.style.display = 'block';
                cardModal.id = 'clientCardModal';
                
                // Используем количество расчетов из данных клиента
                const calculationsCount = client.calculationCount || 0;
                
                // Загружаем историю изменений
                const historyResponse = await API.getClientHistory(client.id);
                const history = historyResponse.history || [];
                
                cardModal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2>Карточка клиента: ${client.name}</h2>
                            <span class="close" onclick="closeClientCard()">&times;</span>
                        </div>
                        
                        <div style="padding: 20px;">
                            <!-- Основная информация -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                <div>
                                    <h3 style="color: #667eea; margin-bottom: 15px;">Основная информация</h3>
                                    <p><strong>Название:</strong> ${client.name}</p>
                                    <p><strong>ИНН:</strong> ${client.inn || '-'}</p>
                                    <p><strong>Код:</strong> ${client.code || '-'}</p>
                                    <p><strong>Дата создания:</strong> ${APIHelpers.formatDateTime(client.createdAt)}</p>
                                </div>
                                <div>
                                    <h3 style="color: #667eea; margin-bottom: 15px;">Контактная информация</h3>
                                    <p><strong>Контактное лицо:</strong> ${client.contactPerson || '-'}</p>
                                    <p><strong>Должность:</strong> ${client.position || '-'}</p>
                                    <p><strong>Телефон:</strong> ${client.phone || '-'}</p>
                                    <p><strong>Email:</strong> ${client.email || '-'}</p>
                                    <p><strong>Telegram:</strong> ${client.telegram || '-'} | <strong>Расчетов:</strong> <span style="color: ${calculationsCount > 0 ? '#28a745' : '#6c757d'}; font-weight: bold;">📊 ${calculationsCount}</span></p>
                                </div>
                            </div>
                            
                            <!-- Кнопки действий -->
                            <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                                <button class="btn btn-primary" onclick="editClientFromCard('${client.id}')">✏️ Редактировать</button>
                                ${isAdmin ? `<button class="btn btn-danger" onclick="deleteClientFromCard('${client.id}', '${client.name}')">🗑️ Удалить</button>` : ''}
                            </div>
                            
                            <!-- История изменений -->
                            <div style="border-top: 2px solid #e1e5e9; padding-top: 20px;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">История изменений</h3>
                                <div id="clientHistory" style="max-height: 300px; overflow-y: auto;">
                                    ${history.length > 0 ? history.map(h => `
                                        <div style="background: #f8f9fa; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
                                            <p style="margin: 5px 0;"><strong>${h.changedBy}</strong> - ${APIHelpers.formatDateTime(h.createdAt)}</p>
                                            <div style="margin: 5px 0; color: #6c757d;">
                                                ${h.changes.map(change => `
                                                    <div style="margin: 2px 0;">
                                                        <strong>${change.field}:</strong> 
                                                        ${change.oldValue ? `"${change.oldValue}"` : 'пусто'} → 
                                                        ${change.newValue ? `"${change.newValue}"` : 'пусто'}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('') : '<p style="color: #6c757d;">История изменений пока пуста</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(cardModal);
                
            } catch (error) {
                console.error('Error opening client card:', error);
                showMessage('Ошибка при открытии карточки клиента', true);
            }
        }
        
        // Закрытие карточки клиента
        function closeClientCard() {
            const modal = document.getElementById('clientCardModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Редактирование клиента из карточки
        function editClientFromCard(clientId) {
            closeClientCard();
            editClient(clientId);
        }
        
        // Удаление клиента из карточки
        async function deleteClientFromCard(clientId, clientName) {
            if (confirm(`Удалить клиента "${clientName}"?`)) {
                try {
                    await API.deleteClient(clientId);
                    closeClientCard();
                    showMessage('Клиент удален');
                    loadClients(currentPage);
                } catch (error) {
                    console.error('Error deleting client:', error);
                    showMessage('Ошибка при удалении клиента', true);
                }
            }
        }
    </script>
</body>
</html>